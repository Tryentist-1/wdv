<!DOCTYPE html>
<html lang="en" class="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Bracket Results</title>
  <link rel="stylesheet" href="css/tailwind-compiled.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    .bg-primary { background-color: #0d6efd !important; }
    .bg-primary-dark { background-color: #0a58ca !important; }
    .bg-success { background-color: #198754 !important; }
    .text-primary { color: #0d6efd !important; }
    .text-success { color: #198754 !important; }
    .hover\:bg-primary-dark:hover { background-color: #0a58ca !important; }
    .winner-row { 
      background-color: #d4edda !important; 
    }
    .dark .winner-row {
      background-color: rgba(34, 197, 94, 0.2) !important;
    }
    .winner-text {
      color: #198754 !important;
    }
    .dark .winner-text {
      color: #4ade80 !important;
    }
  </style>
  <script>
    // Dark mode toggle functionality
    function toggleDarkMode() {
      const html = document.documentElement;
      const isDark = html.classList.contains('dark');
      
      if (isDark) {
        html.classList.remove('dark');
        html.classList.add('light');
        localStorage.setItem('theme', 'light');
      } else {
        html.classList.remove('light');
        html.classList.add('dark');
        localStorage.setItem('theme', 'dark');
      }
    }
    
    // Initialize theme from localStorage or system preference
    function initTheme() {
      const savedTheme = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      
      if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
        document.documentElement.classList.add('dark');
        document.documentElement.classList.remove('light');
      }
    }
    
    // Run on page load
    initTheme();
  </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 min-h-screen p-4 transition-colors duration-200" style="padding-bottom: calc(48px + env(safe-area-inset-bottom));">
  <div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="mb-6 bg-white dark:bg-gray-800 rounded-lg shadow p-4 transition-colors duration-200">
      <div class="flex justify-between items-center mb-2">
        <h1 class="text-3xl font-bold text-gray-800 dark:text-white">Bracket Results</h1>
        <button onclick="toggleDarkMode()" 
                class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors duration-200 flex items-center gap-2 min-h-[44px]">
          <span class="dark:hidden">üåô Dark</span>
          <span class="hidden dark:inline">‚òÄÔ∏è Light</span>
        </button>
      </div>
      <div id="bracket-info" class="text-gray-600 dark:text-gray-400">
        Loading bracket information...
      </div>
    </div>

    <!-- Tab Navigation (for Elimination brackets) -->
    <div id="elimination-tabs" class="hidden mb-6 bg-white dark:bg-gray-800 rounded-lg shadow p-2 transition-colors duration-200">
      <div class="flex gap-2 overflow-x-auto">
        <button class="tab-btn active px-4 py-2 font-semibold text-primary border-b-2 border-primary whitespace-nowrap min-w-[44px] min-h-[44px]" data-tab="qual">Qual Ranking</button>
        <button class="tab-btn px-4 py-2 font-semibold text-gray-600 dark:text-gray-400 hover:text-primary whitespace-nowrap min-w-[44px] min-h-[44px]" data-tab="quarters">Quarter Finals</button>
        <button class="tab-btn px-4 py-2 font-semibold text-gray-600 dark:text-gray-400 hover:text-primary whitespace-nowrap min-w-[44px] min-h-[44px]" data-tab="semis">Semi Finals</button>
        <button class="tab-btn px-4 py-2 font-semibold text-gray-600 dark:text-gray-400 hover:text-primary whitespace-nowrap min-w-[44px] min-h-[44px]" data-tab="finals">Finals Round</button>
      </div>
    </div>

    <!-- Qualification Ranking Tab -->
    <div id="qual-tab" class="tab-content hidden">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 overflow-x-auto transition-colors duration-200">
        <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Qualification Ranking (Top 8)</h2>
        <div class="overflow-x-auto -mx-4 px-4">
          <table class="w-full text-xs sm:text-sm border-collapse min-w-[400px]">
            <thead>
              <tr class="border-b-2 border-gray-300 dark:border-gray-600 bg-primary dark:bg-primary-dark text-white">
                <th class="text-left px-1 py-2 font-semibold w-10">Rank</th>
                <th class="text-left px-2 py-2 font-semibold min-w-[120px]">Name</th>
                <th class="text-left px-2 py-2 font-semibold hidden sm:table-cell">School</th>
                <th class="text-right px-2 py-2 font-semibold w-14">Total</th>
                <th class="text-right px-1 py-2 font-semibold w-10">10s</th>
                <th class="text-right px-1 py-2 font-semibold w-10">Xs</th>
              </tr>
            </thead>
            <tbody id="qual-table-body">
              <tr><td colspan="6" class="text-center p-4 text-gray-500">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Quarter Finals Tab -->
    <div id="quarters-tab" class="tab-content hidden">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 transition-colors duration-200">
        <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Quarter Finals</h2>
        <div id="quarters-matches" class="space-y-4">
          <div class="text-gray-500 text-center p-4">Loading matches...</div>
        </div>
      </div>
    </div>

    <!-- Semi Finals Tab -->
    <div id="semis-tab" class="tab-content hidden">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 transition-colors duration-200">
        <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Semi Finals</h2>
        <div id="semis-matches" class="space-y-4">
          <div class="text-gray-500 text-center p-4">Loading matches...</div>
        </div>
      </div>
    </div>

    <!-- Finals Tab -->
    <div id="finals-tab" class="tab-content hidden">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 transition-colors duration-200">
        <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Finals Round</h2>
        <div id="finals-matches" class="space-y-4">
          <div class="text-gray-500 text-center p-4">Loading matches...</div>
        </div>
      </div>
    </div>

    <!-- Swiss Bracket View -->
    <div id="swiss-view" class="hidden">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 mb-6 transition-colors duration-200">
        <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Swiss Leaderboard</h2>
        <div class="overflow-x-auto -mx-4 px-4">
          <table class="w-full text-xs sm:text-sm border-collapse min-w-[400px]">
            <thead>
              <tr class="border-b-2 border-gray-300 dark:border-gray-600 bg-primary dark:bg-primary-dark text-white">
                <th class="text-left px-1 py-2 font-semibold w-10">Rank</th>
                <th class="text-left px-2 py-2 font-semibold min-w-[120px]">Name</th>
                <th class="text-left px-2 py-2 font-semibold hidden sm:table-cell">School</th>
                <th class="text-center px-2 py-2 font-semibold w-12">W-L</th>
                <th class="text-right px-1 py-2 font-semibold w-10">Pts</th>
              </tr>
            </thead>
            <tbody id="swiss-leaderboard-body">
              <tr><td colspan="5" class="text-center p-4 text-gray-500">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 transition-colors duration-200">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold text-gray-800 dark:text-white">All Matches</h2>
          <button id="refresh-swiss-matches-btn" class="px-3 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors min-h-[44px] min-w-[44px] flex items-center justify-center" title="Refresh Matches">
            <i class="fas fa-recycle text-lg"></i>
          </button>
        </div>
        <div id="swiss-matches" class="space-y-4">
          <div class="text-gray-500 text-center p-4">Loading matches...</div>
        </div>
      </div>
    </div>

    <!-- Coach Actions (if authenticated) -->
    <div id="coach-actions" class="hidden mt-6">
      <button id="validate-close-btn" class="px-6 py-3 bg-success hover:bg-success-dark text-white rounded-lg font-semibold transition-colors min-w-[44px] min-h-[44px]">
        ‚úÖ Validate All and Close Bracket
      </button>
    </div>
  </div>

  <!-- Footer Navigation -->
  <footer class="fixed bottom-0 left-0 right-0 h-[48px] bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 flex items-center px-4 shadow-lg transition-colors duration-200 z-10 safe-area-bottom">
    <a href="index.html" class="min-w-[48px] h-[48px] text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white active:bg-gray-100 dark:active:bg-gray-700 rounded-lg transition-colors flex items-center justify-center" aria-label="Home">
      <i class="fas fa-home text-2xl"></i>
    </a>
    <div class="flex-1"></div>
    <div id="footer-navigation" class="flex gap-2">
      <!-- Footer navigation will be added here by JavaScript -->
    </div>
  </footer>

  <script>
    (() => {
      const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
        ? `${window.location.protocol}//${window.location.hostname}:${window.location.port || 8001}/api/index.php/v1`
        : 'https://archery.tryentist.com/api/v1';
      
      const API_KEY = localStorage.getItem('coach_api_key') || 'wdva26';
      
      const urlParams = new URLSearchParams(window.location.search);
      const bracketId = urlParams.get('bracket') || urlParams.get('bracketId'); // Support both 'bracket' and 'bracketId'
      
      if (!bracketId) {
        document.body.innerHTML = '<div class="p-8 text-center"><h1 class="text-2xl font-bold text-red-600 mb-4">Error</h1><p>No bracket ID provided. Please access this page from the Coach Console.</p></div>';
        return;
      }
      
      let bracketData = null;
      let refreshInterval = null;
      
      async function req(endpoint, method = 'GET', data = null) {
        const options = {
          method,
          headers: {
            'X-API-Key': API_KEY,
            'Content-Type': 'application/json'
          }
        };
        
        if (data && method !== 'GET') {
          options.body = JSON.stringify(data);
        }
        
        const response = await fetch(`${API_BASE}${endpoint}`, options);
        const json = await response.json();
        
        if (!response.ok) {
          throw new Error(json.error || 'Request failed');
        }
        
        return json;
      }
      
      async function loadBracketResults() {
        try {
          const data = await req(`/brackets/${bracketId}/results`);
          bracketData = data;
          
          // Update header
          const bracket = data.bracket;
          const eventName = bracket.event_name || 'Event';
          const eventId = bracket.event_id;
          document.getElementById('bracket-info').innerHTML = `
            <div class="text-lg font-semibold">${eventName}</div>
            <div>${bracket.bracket_type} ${bracket.bracket_format} - ${bracket.division} (${bracket.status})</div>
          `;
          
          // Add footer navigation
          const footerNav = document.getElementById('footer-navigation');
          let footerHtml = '';
          
          if (eventId) {
            footerHtml += `
              <a href="event_dashboard.html?event=${eventId}" 
                 class="px-3 h-[44px] bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors flex items-center justify-center text-sm">
                <i class="fas fa-calendar-alt mr-1"></i>Event
              </a>
            `;
          }
          
          footerHtml += `
            <a href="coach.html" 
               class="px-3 h-[44px] bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors flex items-center justify-center text-sm">
              <i class="fas fa-chalkboard-teacher mr-1"></i>Coach
            </a>
          `;
          
          footerNav.innerHTML = footerHtml;
          
          // Show appropriate view
          if (bracket.bracket_format === 'ELIMINATION') {
            document.getElementById('elimination-tabs').classList.remove('hidden');
            renderQualification(data.qualification || []);
            renderMatches('quarters', data.rounds.quarterfinals || []);
            renderMatches('semis', data.rounds.semifinals || []);
            renderMatches('finals', data.rounds.finals || []);
            showTab('qual');
          } else {
            document.getElementById('swiss-view').classList.remove('hidden');
            renderSwissLeaderboard(data.leaderboard || []);
            renderSwissMatches(data.rounds.swiss || []);
            // Restart auto-refresh for Swiss brackets
            startAutoRefresh();
          }
          
          // Show coach actions if authenticated
          if (localStorage.getItem('coach_auth') === 'true' || API_KEY) {
            document.getElementById('coach-actions').classList.remove('hidden');
          }
          
        } catch (err) {
          console.error('Error loading bracket results:', err);
          document.body.innerHTML = `<div class="p-8 text-center"><h1 class="text-2xl font-bold text-red-600 mb-4">Error</h1><p>${err.message}</p></div>`;
        }
      }
      
      function renderQualification(qual) {
        const tbody = document.getElementById('qual-table-body');
        if (qual.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center p-4 text-gray-500">No qualification data</td></tr>';
          return;
        }
        
        let html = '';
        qual.forEach((entry, index) => {
          const isTop8 = index < 8;
          const rowClass = isTop8 ? 'bg-yellow-50 dark:bg-yellow-900/20' : '';
          html += `
            <tr class="${rowClass} border-b border-gray-200 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700">
              <td class="px-1 py-2 font-semibold dark:text-white">${entry.rank}</td>
              <td class="px-2 py-2 dark:text-white">${entry.archer_name}</td>
              <td class="px-2 py-2 dark:text-gray-300 hidden sm:table-cell">${entry.school || ''}</td>
              <td class="px-2 py-2 text-right font-semibold dark:text-white">${entry.total_score}</td>
              <td class="px-1 py-2 text-right dark:text-white">${entry.total_10s}</td>
              <td class="px-1 py-2 text-right dark:text-white">${entry.total_xs}</td>
            </tr>
          `;
        });
        tbody.innerHTML = html;
      }
      
      function renderMatches(round, matches) {
        const container = document.getElementById(`${round}-matches`);
        if (!matches || matches.length === 0) {
          container.innerHTML = '<div class="text-gray-500 text-center p-4">No matches yet</div>';
          return;
        }
        
        let html = '';
        matches.forEach(match => {
          const matchId = match.bracket_match_id || match.id;
          const a1 = match.archer1 || {};
          const a2 = match.archer2 || {};
          const a1IsWinner = match.winner_archer_id === a1.archer_id;
          const a2IsWinner = match.winner_archer_id === a2.archer_id;
          
          html += `
            <div class="border border-gray-300 dark:border-gray-600 rounded-lg p-4 bg-white dark:bg-gray-800 transition-colors duration-200">
              <div class="font-semibold text-lg mb-3 text-gray-800 dark:text-white">${matchId}</div>
              <div class="overflow-x-auto -mx-4 px-4">
                <table class="w-full text-xs sm:text-sm border-collapse min-w-[450px]">
                  <thead>
                    <tr class="border-b border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700">
                      <th class="text-left px-1 py-2 font-semibold dark:text-white">Tgt</th>
                      <th class="text-left px-2 py-2 font-semibold dark:text-white">Name</th>
                      <th class="text-center px-1 py-2 font-semibold dark:text-white">E1</th>
                      <th class="text-center px-1 py-2 font-semibold dark:text-white">E2</th>
                      <th class="text-center px-1 py-2 font-semibold dark:text-white">E3</th>
                      <th class="text-center px-1 py-2 font-semibold dark:text-white">E4</th>
                      <th class="text-center px-1 py-2 font-semibold dark:text-white">E5</th>
                      <th class="text-right px-1 py-2 font-semibold dark:text-white">Total</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${renderMatchRow(a1, 1, a1IsWinner, false)}
                    ${renderMatchRow(a2, 2, a2IsWinner, false)}
                  </tbody>
                </table>
              </div>
            </div>
          `;
        });
        container.innerHTML = html;
      }
      
      function renderMatchRow(archer, position, isWinner, swissFormat = false) {
        if (!archer || !archer.name) {
          if (swissFormat) {
            return `
              <tr class="border-b border-gray-200 dark:border-gray-600">
                <td class="px-1 py-2 text-right font-semibold dark:text-white">-</td>
                <td class="px-1 py-2 dark:text-white">${position === 1 ? '15A' : '16A'}</td>
                <td class="px-2 py-2 font-medium dark:text-white">-</td>
                <td class="px-1 py-2 text-center dark:text-white">-</td>
                <td class="px-1 py-2 text-center dark:text-white">-</td>
                <td class="px-1 py-2 text-center dark:text-white">-</td>
                <td class="px-1 py-2 text-center dark:text-white">-</td>
                <td class="px-1 py-2 text-center dark:text-white">-</td>
              </tr>
            `;
          } else {
            return `
              <tr class="border-b border-gray-200 dark:border-gray-600">
                <td class="px-1 py-2 dark:text-white">${position === 1 ? '15A' : '16A'}</td>
                <td class="px-2 py-2 font-medium dark:text-white">-</td>
                <td class="px-1 py-2 text-center dark:text-white">-</td>
                <td class="px-1 py-2 text-center dark:text-white">-</td>
                <td class="px-1 py-2 text-center dark:text-white">-</td>
                <td class="px-1 py-2 text-center dark:text-white">-</td>
                <td class="px-1 py-2 text-center dark:text-white">-</td>
                <td class="px-1 py-2 text-right font-semibold dark:text-white">-</td>
              </tr>
            `;
          }
        }
        
        const nameDisplay = archer.seed ? `${archer.name} (${archer.seed})` : archer.name;
        const rowClass = isWinner ? 'winner-row' : '';
        const textClass = isWinner ? 'winner-text' : 'dark:text-white';
        const sets = archer.sets || [];
        
        // Calculate total score from sets (sum of all end scores)
        let totalScore = 0;
        if (archer.total_score !== undefined) {
          totalScore = archer.total_score;
        } else if (sets.length > 0) {
          totalScore = sets.reduce((sum, set) => sum + (set.score || 0), 0);
        }
        
        // Build end columns - show set_points (0, 1, or 2) instead of just score
        let endCells = '';
        for (let i = 1; i <= 5; i++) {
          const set = sets.find(s => s.end === i);
          if (set) {
            const scoreClass = isWinner ? 'winner-text font-semibold' : 'dark:text-white';
            // Show set_points if available, otherwise show score
            const setPoints = set.set_points !== undefined ? set.set_points : null;
            const displayText = setPoints !== null ? `${set.score} (${setPoints})` : (set.display || `${set.score}(${set.xs})`);
            endCells += `<td class="px-1 py-2 text-center ${scoreClass}">${displayText}</td>`;
          } else {
            endCells += `<td class="px-1 py-2 text-center dark:text-gray-400">-</td>`;
          }
        }
        
        if (swissFormat) {
          return `
            <tr class="${rowClass} border-b border-gray-200 dark:border-gray-600">
              <td class="px-1 py-2 text-right font-semibold ${textClass}">${totalScore}</td>
              <td class="px-1 py-2 dark:text-white">${position === 1 ? '15A' : '16A'}</td>
              <td class="px-2 py-2 font-medium ${textClass}">${nameDisplay}</td>
              ${endCells}
            </tr>
          `;
        } else {
          // For elimination format, use total_set_points (match score)
          const matchScore = archer.total_set_points || 0;
          return `
            <tr class="${rowClass} border-b border-gray-200 dark:border-gray-600">
              <td class="px-1 py-2 dark:text-white">${position === 1 ? '15A' : '16A'}</td>
              <td class="px-2 py-2 font-medium ${textClass}">${nameDisplay}</td>
              ${endCells}
              <td class="px-1 py-2 text-right font-semibold ${textClass}">${matchScore}</td>
            </tr>
          `;
        }
      }
      
      function renderSwissLeaderboard(leaderboard) {
        const tbody = document.getElementById('swiss-leaderboard-body');
        if (!leaderboard || leaderboard.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-gray-500">No leaderboard data</td></tr>';
          return;
        }
        
        let html = '';
        leaderboard.forEach(entry => {
          html += `
            <tr class="border-b border-gray-200 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700">
              <td class="px-1 py-2 font-semibold dark:text-white">${entry.rank}</td>
              <td class="px-2 py-2 dark:text-white">${entry.archer_name}</td>
              <td class="px-2 py-2 dark:text-gray-300 hidden sm:table-cell">${entry.school || ''}</td>
              <td class="px-2 py-2 text-center dark:text-white">${entry.record}</td>
              <td class="px-1 py-2 text-right font-semibold dark:text-white">${entry.points}</td>
            </tr>
          `;
        });
        tbody.innerHTML = html;
      }
      
      function getMatchStatusBadge(cardStatus, status) {
        // card_status: PEND, COMP, VRFD, VOID
        // status: Not Started, In Progress, Completed, Voided
        const cardStatusUpper = (cardStatus || '').toUpperCase();
        const statusUpper = (status || '').toUpperCase();
        
        if (cardStatusUpper === 'VRFD') {
          return '<span class="px-2 py-1 bg-green-500 text-white rounded text-xs font-semibold">Verified</span>';
        } else if (cardStatusUpper === 'COMP') {
          return '<span class="px-2 py-1 bg-blue-500 text-white rounded text-xs font-semibold">Complete</span>';
        } else if (statusUpper === 'IN PROGRESS') {
          return '<span class="px-2 py-1 bg-yellow-500 text-white rounded text-xs font-semibold">In Progress</span>';
        } else if (statusUpper === 'COMPLETED') {
          return '<span class="px-2 py-1 bg-blue-500 text-white rounded text-xs font-semibold">Complete</span>';
        } else if (cardStatusUpper === 'VOID' || statusUpper === 'VOIDED') {
          return '<span class="px-2 py-1 bg-gray-500 text-white rounded text-xs font-semibold">Voided</span>';
        } else {
          return '<span class="px-2 py-1 bg-gray-400 text-white rounded text-xs font-semibold">Pending</span>';
        }
      }
      
      function renderSwissMatches(matches) {
        const container = document.getElementById('swiss-matches');
        if (!matches || matches.length === 0) {
          container.innerHTML = '<div class="text-gray-500 text-center p-4">No matches yet</div>';
          return;
        }
        
        let html = '';
        matches.forEach(match => {
          const matchId = match.bracket_match_id || match.match_code || match.id;
          const a1 = match.archer1 || {};
          const a2 = match.archer2 || {};
          const a1IsWinner = match.winner_archer_id === a1.archer_id;
          const a2IsWinner = match.winner_archer_id === a2.archer_id;
          const statusBadge = getMatchStatusBadge(match.card_status, match.status);
          
          html += `
            <div class="border border-gray-300 dark:border-gray-600 rounded-lg p-4 bg-white dark:bg-gray-800 transition-colors duration-200">
              <div class="flex justify-between items-center mb-3">
                <div class="font-semibold text-lg text-gray-800 dark:text-white">${matchId}</div>
                <div>${statusBadge}</div>
              </div>
              <div class="overflow-x-auto -mx-4 px-4">
                <table class="w-full text-xs sm:text-sm border-collapse min-w-[450px]">
                  <thead>
                    <tr class="border-b border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700">
                      <th class="text-right px-1 py-2 font-semibold dark:text-white">Total</th>
                      <th class="text-left px-1 py-2 font-semibold dark:text-white">Tgt</th>
                      <th class="text-left px-2 py-2 font-semibold dark:text-white">Name</th>
                      <th class="text-center px-1 py-2 font-semibold dark:text-white">E1</th>
                      <th class="text-center px-1 py-2 font-semibold dark:text-white">E2</th>
                      <th class="text-center px-1 py-2 font-semibold dark:text-white">E3</th>
                      <th class="text-center px-1 py-2 font-semibold dark:text-white">E4</th>
                      <th class="text-center px-1 py-2 font-semibold dark:text-white">E5</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${renderMatchRow(a1, 1, a1IsWinner, true)}
                    ${renderMatchRow(a2, 2, a2IsWinner, true)}
                  </tbody>
                </table>
              </div>
            </div>
          `;
        });
        container.innerHTML = html;
      }
      
      function showTab(tabName) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(btn => {
          btn.classList.remove('active', 'text-primary', 'border-b-2', 'border-primary');
          btn.classList.add('text-gray-600', 'dark:text-gray-400');
        });
        
        // Show selected tab
        document.getElementById(`${tabName}-tab`).classList.remove('hidden');
        const btn = document.querySelector(`[data-tab="${tabName}"]`);
        if (btn) {
          btn.classList.add('active', 'text-primary', 'border-b-2', 'border-primary');
          btn.classList.remove('text-gray-600', 'dark:text-gray-400');
        }
      }
      
      // Tab navigation
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const tab = btn.getAttribute('data-tab');
          showTab(tab);
        });
      });
      
      // Validate and close button
      document.getElementById('validate-close-btn')?.addEventListener('click', async () => {
        if (!confirm('Validate all matches and close this bracket? This will mark it as COMPLETED.')) {
          return;
        }
        
        try {
          await req(`/brackets/${bracketId}`, 'PATCH', { status: 'COMPLETED' });
          alert('Bracket validated and closed successfully!');
          await loadBracketResults();
        } catch (err) {
          alert('Error: ' + err.message);
        }
      });
      
      // Auto-refresh for Swiss brackets (every 5 seconds)
      function startAutoRefresh() {
        if (refreshInterval) {
          clearInterval(refreshInterval);
        }
        
        // Check if we're viewing a Swiss bracket
        const swissView = document.getElementById('swiss-view');
        if (swissView && !swissView.classList.contains('hidden')) {
          refreshInterval = setInterval(() => {
            loadBracketResults();
          }, 5000); // Refresh every 5 seconds
        }
      }
      
      // Refresh button handler
      document.getElementById('refresh-swiss-matches-btn')?.addEventListener('click', () => {
        loadBracketResults();
      });
      
      // Stop auto-refresh when page is hidden
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
          if (refreshInterval) {
            clearInterval(refreshInterval);
            refreshInterval = null;
          }
        } else {
          startAutoRefresh();
        }
      });
      
      // Load data on page load
      loadBracketResults().then(() => {
        startAutoRefresh();
      });
    })();
  </script>
</body>
</html>
