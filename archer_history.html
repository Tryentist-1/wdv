<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Archer History</title>
  <link rel="stylesheet" href="css/main.css">
  <script src="js/scorecard_view.js"></script>
  <style>
    .history-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 2rem;
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .archer-info {
      background: white;
      padding: 1.5rem;
      border-radius: 8px;
      margin-bottom: 2rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .archer-info h2 {
      margin: 0 0 0.5rem 0;
      color: #2c3e50;
    }
    
    .archer-meta {
      display: flex;
      gap: 1.5rem;
      flex-wrap: wrap;
      color: #555;
      font-size: 0.95rem;
    }
    
    .history-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-radius: 8px;
      overflow: hidden;
    }
    
    .history-table thead {
      background: #34495e;
      color: white;
    }
    
    .history-table th {
      padding: 0.75rem;
      text-align: left;
      font-weight: 600;
      font-size: 0.9rem;
    }
    
    .history-table td {
      padding: 0.75rem;
      border-bottom: 1px solid #ecf0f1;
    }
    
    .history-table tbody tr:hover {
      background: #f8f9fa;
      cursor: pointer;
    }
    
    .score-cell {
      font-weight: 700;
      font-size: 1.1rem;
      color: #2c3e50;
    }
    
    .no-history {
      text-align: center;
      padding: 3rem;
      color: #888;
      font-size: 1.1rem;
    }
    
    .loading {
      text-align: center;
      padding: 3rem;
      color: #888;
    }
    
    .error-message {
      background: #fee;
      border: 1px solid #fcc;
      color: #c33;
      padding: 1rem;
      border-radius: 8px;
      margin: 2rem 0;
    }
    
    @media (max-width: 768px) {
      .history-table {
        font-size: 0.85rem;
      }
      
      .history-table th,
      .history-table td {
        padding: 0.5rem 0.3rem;
      }
    }
  </style>
</head>
<body>
  <div class="main-container">
    <!-- Header -->
    <div class="history-header">
      <h1 id="page-title">Archer History</h1>
    </div>

    <!-- Archer Info -->
    <div id="archer-info" class="archer-info" style="display:none;">
      <h2 id="archer-name">-</h2>
      <div class="archer-meta">
        <span>üè´ School: <strong id="archer-school">-</strong></span>
        <span>üìä Level: <strong id="archer-level">-</strong></span>
        <span>üë§ Gender: <strong id="archer-gender">-</strong></span>
        <span>üéØ Total Rounds: <strong id="total-rounds">0</strong></span>
      </div>
    </div>

    <!-- Loading/Error States -->
    <div id="loading" class="loading">Loading history...</div>
    <div id="error" class="error-message" style="display:none;"></div>

    <!-- History Table -->
    <div id="history-container" style="display:none;">
      <table class="history-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Event</th>
            <th>Round</th>
            <th>Division</th>
            <th>Bale</th>
            <th>Target</th>
            <th>Ends</th>
            <th>Score</th>
            <th>10s</th>
            <th>Xs</th>
          </tr>
        </thead>
        <tbody id="history-body">
          <!-- Populated dynamically -->
        </tbody>
      </table>
    </div>

    <div id="no-history" class="no-history" style="display:none;">
      <p>No scoring history found.</p>
      <p>Start scoring to build your history!</p>
    </div>
  </div>

  <footer class="global-footer">
    <a href="index.html" class="btn btn-secondary">‚Üê Back to Home</a>
  </footer>

  <script>
    const API_BASE = 'https://tryentist.com/wdv/api/v1';
    const urlParams = new URLSearchParams(window.location.search);
    const archerId = urlParams.get('archer') || urlParams.get('id') || urlParams.get('extId');

    async function loadHistory() {
      if (!archerId) {
        showError('No archer ID provided. Please use ?archer={id} or ?extId={localId} in the URL.');
        return;
      }

      try {
        // Try with the provided ID first (could be UUID or external ID)
        let res = await fetch(`${API_BASE}/archers/${encodeURIComponent(archerId)}/history`);
        
        // If 404 and looks like external ID (contains hyphens but not UUID format), try searching by external ID
        if (!res.ok && res.status === 404 && archerId.includes('-') && !archerId.match(/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i)) {
          console.log('First attempt failed, trying to find archer by external ID...');
          // Get all archers and find by external ID
          const archersRes = await fetch(`${API_BASE}/archers`);
          if (archersRes.ok) {
            const archersData = await archersRes.json();
            const archer = (archersData.archers || []).find(a => 
              (a.extId || '').toLowerCase() === archerId.toLowerCase() ||
              `${a.first_name}-${a.last_name}`.toLowerCase().replace(/\s+/g, '-') === archerId.toLowerCase()
            );
            if (archer && archer.id) {
              console.log('Found archer by external ID, fetching history with UUID:', archer.id);
              res = await fetch(`${API_BASE}/archers/${encodeURIComponent(archer.id)}/history`);
            }
          }
        }
        
        if (!res.ok) {
          if (res.status === 404) {
            showError('Archer not found. They may not have scored any rounds yet.');
          } else {
            throw new Error(`HTTP ${res.status}`);
          }
          return;
        }
        
        const data = await res.json();
        console.log('Archer history:', data);

        // Update archer info
        document.getElementById('archer-name').textContent = data.archer.fullName;
        document.getElementById('archer-school').textContent = data.archer.school || 'N/A';
        document.getElementById('archer-level').textContent = data.archer.level || 'N/A';
        document.getElementById('archer-gender').textContent = data.archer.gender === 'M' ? 'Male' : data.archer.gender === 'F' ? 'Female' : 'N/A';
        document.getElementById('total-rounds').textContent = data.totalRounds;
        document.getElementById('archer-info').style.display = 'block';

        // Render history
        if (data.history.length === 0) {
          document.getElementById('no-history').style.display = 'block';
        } else {
          renderHistory(data.history);
          document.getElementById('history-container').style.display = 'block';
        }

        document.getElementById('loading').style.display = 'none';
      } catch (err) {
        console.error('Error loading history:', err);
        showError('Failed to load archer history: ' + err.message);
      }
    }

    function renderHistory(history) {
      const tbody = document.getElementById('history-body');
      tbody.innerHTML = '';

      history.forEach(round => {
        const row = document.createElement('tr');
        
        const divisionNames = {
          'BVAR': 'Boys Varsity',
          'GVAR': 'Girls Varsity',
          'BJV': 'Boys JV',
          'GJV': 'Girls JV'
        };

        row.innerHTML = `
          <td>${round.event_date || 'N/A'}</td>
          <td>${round.event_name || 'Unknown Event'} <span style="color: #3498db; font-size: 0.85rem;">üìÑ</span></td>
          <td>${round.round_type || 'R300'}</td>
          <td>${divisionNames[round.division] || round.division || 'N/A'}</td>
          <td>${round.bale_number || '-'}</td>
          <td>${round.target_assignment || '-'}</td>
          <td>${round.ends_completed || 0}</td>
          <td class="score-cell">${round.final_score || 0}</td>
          <td>${round.total_tens || 0}</td>
          <td>${round.total_xs || 0}</td>
        `;
        
        // Make row clickable to view scorecard
        row.style.cursor = 'pointer';
        row.onclick = () => showRoundScorecard(round);

        tbody.appendChild(row);
      });
    }

    function showError(message) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').textContent = message;
      document.getElementById('error').style.display = 'block';
    }
    
    async function showRoundScorecard(round) {
      // Fetch detailed scorecard data from API
      try {
        if (typeof ScorecardView === 'undefined') {
          alert('Scorecard viewer is not loaded. Please refresh the page.');
          return;
        }
        
        // Check if we need to fetch from API or if we have the data already
        if (!round.round_id || !round.archer_id) {
          alert('Missing round or archer information');
          return;
        }
        
        const res = await fetch(`${API_BASE}/rounds/${round.round_id}/archers/${round.archer_id}/scorecard`);
        if (!res.ok) {
          if (res.status === 404) {
            alert('Scorecard not found. This round may not have been scored yet.');
          } else {
            alert(`Unable to load scorecard details (HTTP ${res.status})`);
          }
          return;
        }
        
        const scorecardData = await res.json();
        console.log('Scorecard data:', scorecardData);
        
        // Extract scores from ends
        const scores = (scorecardData.ends || []).map(end => [
          end.a1 || '',
          end.a2 || '',
          end.a3 || ''
        ]);
        
        const archerData = {
          id: round.archer_id,
          firstName: round.first_name || '',
          lastName: round.last_name || '',
          school: round.school || '',
          level: round.level || '',
          gender: round.gender || '',
          scores: scores,
          verified: scorecardData.verified || false,
          completed: (scorecardData.ends_completed >= 10)
        };
        
        const roundData = {
          totalEnds: 10,
          eventName: round.event_name || '',
          division: round.division || '',
          roundType: round.round_type || 'R300'
        };
        
        ScorecardView.showScorecardModal(archerData, roundData);
      } catch (err) {
        console.error('Error loading scorecard:', err);
        alert('Error loading scorecard: ' + err.message + '\n\nCheck console for details.');
      }
    }

    // Load history on page load
    document.addEventListener('DOMContentLoaded', loadHistory);
  </script>
</body>
</html>

