<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Archer History</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            // Score Colors
            'score-gold': '#FFD700',
            'score-red': '#DC143C',
            'score-blue': '#4169E1',
            'score-black': '#000000',
            'score-white': '#FFFFFF',
            'score-miss': '#808080',
            
            // Brand Colors
            'primary': {
              DEFAULT: '#2d7dd9',
              dark: '#1b5bbf',
              light: '#e7f1ff',
            },
            'secondary': {
              DEFAULT: '#6c757d',
              dark: '#5a6268',
              light: '#e9ecef',
            },
            'success': {
              DEFAULT: '#28a745',
              dark: '#1e7e34',
              light: '#d1e7dd',
            },
            'danger': {
              DEFAULT: '#d92d20',
              dark: '#b0241a',
              light: '#f8d7da',
            },
            'warning': {
              DEFAULT: '#ffc107',
              dark: '#d39e00',
              light: '#fff3cd',
            }
          }
        }
      }
    }
  </script>
  <script src="js/scorecard_view.js"></script>
  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen transition-colors duration-200">
  <div class="max-w-6xl mx-auto px-4 py-6">
    <!-- Header -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6 transition-colors duration-200 flex justify-between items-center">
      <h1 id="page-title" class="text-3xl font-bold text-gray-800 dark:text-white">Archer History</h1>
      <button id="dark-mode-toggle" class="px-3 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors" title="Toggle dark mode">
        <span class="dark:hidden">üåô</span>
        <span class="hidden dark:inline">‚òÄÔ∏è</span>
      </button>
    </div>

    <!-- Archer Info -->
    <div id="archer-info" class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6 transition-colors duration-200 hidden">
      <h2 id="archer-name" class="text-2xl font-bold text-gray-800 dark:text-white mb-3">-</h2>
      <div class="flex gap-6 flex-wrap text-gray-600 dark:text-gray-400 text-sm">
        <span>üè´ School: <strong id="archer-school" class="text-gray-800 dark:text-white">-</strong></span>
        <span>üìä Level: <strong id="archer-level" class="text-gray-800 dark:text-white">-</strong></span>
        <span>üë§ Gender: <strong id="archer-gender" class="text-gray-800 dark:text-white">-</strong></span>
        <span>üéØ Total Rounds: <strong id="total-rounds" class="text-gray-800 dark:text-white">0</strong></span>
      </div>
    </div>

    <!-- Loading/Error States -->
    <div id="loading" class="text-center py-12 text-gray-600 dark:text-gray-400">Loading history...</div>
    <div id="error" class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-400 px-4 py-3 rounded-lg my-6 hidden"></div>

    <!-- History Table -->
    <div id="history-container" class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden mb-6 hidden">
      <div class="overflow-x-auto">
        <table class="w-full border-collapse text-sm">
          <thead class="bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 border-b-2 border-gray-300 dark:border-gray-600">
            <tr>
              <th class="px-3 py-3 text-left font-semibold">Date</th>
              <th class="px-3 py-3 text-left font-semibold">Event</th>
              <th class="px-3 py-3 text-left font-semibold">Round</th>
              <th class="px-3 py-3 text-left font-semibold">Division</th>
              <th class="px-3 py-3 text-left font-semibold">Bale</th>
              <th class="px-3 py-3 text-left font-semibold">Target</th>
              <th class="px-3 py-3 text-left font-semibold">Ends</th>
              <th class="px-3 py-3 text-left font-semibold">Score</th>
              <th class="px-3 py-3 text-left font-semibold">10s</th>
              <th class="px-3 py-3 text-left font-semibold">Xs</th>
              <th class="px-3 py-3 text-left font-semibold">Actions</th>
            </tr>
          </thead>
          <tbody id="history-body">
            <!-- Populated dynamically -->
          </tbody>
        </table>
      </div>
    </div>

    <div id="no-history" class="text-center py-12 text-gray-500 dark:text-gray-400 hidden">
      <p class="text-lg mb-2">No scoring history found.</p>
      <p>Start scoring to build your history!</p>
    </div>
  </div>

  <footer class="fixed bottom-0 left-0 right-0 px-4 py-3 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 shadow-lg transition-colors duration-200">
    <div class="max-w-6xl mx-auto">
      <a href="archer_list.html" class="inline-block px-6 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors min-h-[44px] flex items-center justify-center">‚Üê Back to Archer List</a>
    </div>
  </footer>

  <script>
    // Dark mode toggle
    const darkModeToggle = document.getElementById('dark-mode-toggle');
    const htmlElement = document.documentElement;
    
    // Check for saved preference or default to light mode
    const savedTheme = localStorage.getItem('theme') || 'light';
    if (savedTheme === 'dark') {
      htmlElement.classList.add('dark');
    }
    
    darkModeToggle.addEventListener('click', () => {
      htmlElement.classList.toggle('dark');
      const newTheme = htmlElement.classList.contains('dark') ? 'dark' : 'light';
      localStorage.setItem('theme', newTheme);
    });
    
    // Use local API when running on localhost, otherwise use production
    const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
      ? `${window.location.protocol}//${window.location.hostname}:${window.location.port || 8001}/api/index.php/v1`
      : 'https://tryentist.com/wdv/api/v1';
    const urlParams = new URLSearchParams(window.location.search);
    const archerId = urlParams.get('archer') || urlParams.get('id') || urlParams.get('extId');
    
    // Store archer data globally so it can be accessed when viewing scorecards
    let currentArcherData = null;

    async function loadHistory() {
      if (!archerId) {
        showError('No archer ID provided. Please use ?archer={id} or ?extId={localId} in the URL.');
        return;
      }

      try {
        // Try with the provided ID first (could be UUID or external ID)
        let res = await fetch(`${API_BASE}/archers/${encodeURIComponent(archerId)}/history`);
        
        // If 404 and looks like external ID (contains hyphens but not UUID format), try searching by external ID
        if (!res.ok && res.status === 404 && archerId.includes('-') && !archerId.match(/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i)) {
          console.log('First attempt failed, trying to find archer by external ID...');
          // Get all archers and find by external ID
          const archersRes = await fetch(`${API_BASE}/archers`);
          if (archersRes.ok) {
            const archersData = await archersRes.json();
            const archer = (archersData.archers || []).find(a => 
              (a.extId || '').toLowerCase() === archerId.toLowerCase() ||
              `${a.first_name}-${a.last_name}`.toLowerCase().replace(/\s+/g, '-') === archerId.toLowerCase()
            );
            if (archer && archer.id) {
              console.log('Found archer by external ID, fetching history with UUID:', archer.id);
              res = await fetch(`${API_BASE}/archers/${encodeURIComponent(archer.id)}/history`);
            }
          }
        }
        
        if (!res.ok) {
          if (res.status === 404) {
            showError('Archer not found. They may not have scored any rounds yet.');
          } else {
            throw new Error(`HTTP ${res.status}`);
          }
          return;
        }
        
        const data = await res.json();
        console.log('Archer history:', data);
        
        // Store archer data globally for scorecard viewing
        currentArcherData = data.archer;

        // Update archer info
        document.getElementById('archer-name').textContent = data.archer.fullName;
        document.getElementById('archer-school').textContent = data.archer.school || 'N/A';
        document.getElementById('archer-level').textContent = data.archer.level || 'N/A';
        document.getElementById('archer-gender').textContent = data.archer.gender === 'M' ? 'Male' : data.archer.gender === 'F' ? 'Female' : 'N/A';
        document.getElementById('total-rounds').textContent = data.totalRounds;
        document.getElementById('archer-info').classList.remove('hidden');

        // Render history
        if (data.history.length === 0) {
          document.getElementById('no-history').classList.remove('hidden');
        } else {
          renderHistory(data.history);
          document.getElementById('history-container').classList.remove('hidden');
        }

        document.getElementById('loading').classList.add('hidden');
      } catch (err) {
        console.error('Error loading history:', err);
        showError('Failed to load archer history: ' + err.message);
      }
    }

    function renderHistory(history) {
      const tbody = document.getElementById('history-body');
      tbody.innerHTML = '';

      history.forEach(round => {
        const row = document.createElement('tr');
        
        const divisionNames = {
          'BVAR': 'Boys Varsity',
          'GVAR': 'Girls Varsity',
          'BJV': 'Boys JV',
          'GJV': 'Girls JV'
        };

        row.className = 'border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer transition-colors text-gray-800 dark:text-gray-200';
        const isLocked = round.locked || round.card_status === 'VER';
        const canDelete = !isLocked && (round.ends_completed === 0 || round.final_score === 0);
        
        row.innerHTML = `
          <td class="px-3 py-3">${round.event_date || 'N/A'}</td>
          <td class="px-3 py-3">${round.event_name || 'Unknown Event'} <span class="text-primary text-xs">üìÑ</span></td>
          <td class="px-3 py-3">${round.round_type || 'R300'}</td>
          <td class="px-3 py-3">${divisionNames[round.division] || round.division || 'N/A'}</td>
          <td class="px-3 py-3">${round.bale_number || '-'}</td>
          <td class="px-3 py-3">${round.target_assignment || '-'}</td>
          <td class="px-3 py-3">${round.ends_completed || 0}</td>
          <td class="px-3 py-3 font-bold text-lg">${round.final_score || 0}</td>
          <td class="px-3 py-3">${round.total_tens || 0}</td>
          <td class="px-3 py-3">${round.total_xs || 0}</td>
          <td class="px-3 py-3">
            ${canDelete ? `<button onclick="deleteScorecard('${round.round_id}', '${round.round_archer_id}', '${round.event_name}', this)" class="px-2 py-1 bg-red-600 hover:bg-red-700 text-white text-xs rounded transition-colors" title="Delete abandoned scorecard">
              <i class="fas fa-trash"></i>
            </button>` : (isLocked ? '<span class="text-gray-400 text-xs">üîí Locked</span>' : '<span class="text-gray-400 text-xs">-</span>')}
          </td>
        `;
        
        // Make row clickable to view scorecard
        row.onclick = () => showRoundScorecard(round);

        tbody.appendChild(row);
      });
    }

    function showError(message) {
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('error').textContent = message;
      document.getElementById('error').classList.remove('hidden');
    }
    
    async function showRoundScorecard(round) {
      // Fetch detailed scorecard data from API
      try {
        if (typeof ScorecardView === 'undefined') {
          alert('Scorecard viewer is not loaded. Please refresh the page.');
          return;
        }
        
        console.log('Round data received:', round);
        
        // Extract the correct field names (API might return different field names)
        const roundId = round.round_id || round.roundId || round.id;
        const archerIdForRequest = round.archer_id || round.archerId;
        
        // Check if we need to fetch from API or if we have the data already
        if (!roundId || !archerIdForRequest) {
          console.error('Missing round or archer information. Round data:', round);
          alert('Missing round or archer information. Round ID: ' + roundId + ', Archer ID: ' + archerIdForRequest);
          return;
        }
        
        console.log('Fetching scorecard for round:', roundId, 'archer:', archerIdForRequest);
        const res = await fetch(`${API_BASE}/rounds/${roundId}/archers/${archerIdForRequest}/scorecard`);
        if (!res.ok) {
          if (res.status === 404) {
            alert('Scorecard not found. This round may not have been scored yet.');
          } else {
            alert(`Unable to load scorecard details (HTTP ${res.status})`);
          }
          return;
        }
        
        const scorecardData = await res.json();
        console.log('Scorecard data:', scorecardData);
        
        // Extract scores from ends
        const scores = (scorecardData.ends || []).map(end => [
          end.a1 || '',
          end.a2 || '',
          end.a3 || ''
        ]);
        
        // Use globally stored archer data for name and details
        const archerData = {
          id: round.archer_id,
          firstName: currentArcherData ? currentArcherData.firstName : '',
          lastName: currentArcherData ? currentArcherData.lastName : '',
          school: currentArcherData ? currentArcherData.school : '',
          level: currentArcherData ? currentArcherData.level : '',
          gender: currentArcherData ? currentArcherData.gender : '',
          scores: scores,
          verified: scorecardData.verified || false,
          completed: (scorecardData.ends_completed >= 10)
        };
        
        const roundData = {
          totalEnds: 10,
          eventName: round.event_name || '',
          division: round.division || '',
          roundType: round.round_type || 'R300'
        };
        
        ScorecardView.showScorecardModal(archerData, roundData);
      } catch (err) {
        console.error('Error loading scorecard:', err);
        alert('Error loading scorecard: ' + err.message + '\n\nCheck console for details.');
      }
    }

    async function deleteScorecard(roundId, roundArcherId, eventName, buttonElement) {
      if (!confirm(`Delete this abandoned scorecard from "${eventName}"?\n\nThis action cannot be undone.`)) {
        return;
      }
      
      try {
        // Disable button during request
        buttonElement.disabled = true;
        buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        
        const response = await fetch(`${API_BASE}/rounds/${roundId}/archers/${roundArcherId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) {
          if (response.status === 401 || response.status === 403) {
            throw new Error('You need coach permissions to delete scorecards. Please authenticate in the Coach Console first.');
          }
          throw new Error(`Failed to delete scorecard (HTTP ${response.status})`);
        }
        
        const result = await response.json();
        if (result.ok) {
          alert('Scorecard deleted successfully!');
          // Reload the history to reflect changes
          loadHistory();
        } else {
          throw new Error(result.error || 'Delete failed');
        }
      } catch (error) {
        console.error('Delete scorecard error:', error);
        alert('Failed to delete scorecard: ' + error.message);
        
        // Re-enable button on error
        buttonElement.disabled = false;
        buttonElement.innerHTML = '<i class="fas fa-trash"></i>';
      }
    }

    // Load history on page load
    document.addEventListener('DOMContentLoaded', loadHistory);
  </script>
</body>
</html>

