<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Archer History</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="css/tailwind-compiled.css">
  <link rel="stylesheet" href="css/unified-scorecard-list.css">
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            // Score Colors
            'score-gold': '#FFD700',
            'score-red': '#DC143C',
            'score-blue': '#4169E1',
            'score-black': '#000000',
            'score-white': '#FFFFFF',
            'score-miss': '#808080',
            
            // Brand Colors
            'primary': {
              DEFAULT: '#2d7dd9',
              dark: '#1b5bbf',
              light: '#e7f1ff',
            },
            'secondary': {
              DEFAULT: '#6c757d',
              dark: '#5a6268',
              light: '#e9ecef',
            },
            'success': {
              DEFAULT: '#28a745',
              dark: '#1e7e34',
              light: '#d1e7dd',
            },
            'danger': {
              DEFAULT: '#d92d20',
              dark: '#b0241a',
              light: '#f8d7da',
            },
            'warning': {
              DEFAULT: '#ffc107',
              dark: '#d39e00',
              light: '#fff3cd',
            }
          }
        }
      }
    }
  </script>
  <script src="js/scorecard_view.js"></script>
  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen transition-colors duration-200">
  <div class="max-w-6xl mx-auto px-4 py-6">
    <!-- Header -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6 transition-colors duration-200 flex justify-between items-center">
      <h1 id="page-title" class="text-3xl font-bold text-gray-800 dark:text-white">Archer History</h1>
      <button id="dark-mode-toggle" class="px-3 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors" title="Toggle dark mode">
        <span class="dark:hidden">üåô</span>
        <span class="hidden dark:inline">‚òÄÔ∏è</span>
      </button>
    </div>

    <!-- Archer Info -->
    <div id="archer-info" class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6 transition-colors duration-200 hidden">
      <h2 id="archer-name" class="text-2xl font-bold text-gray-800 dark:text-white mb-3">-</h2>
      <div class="flex gap-6 flex-wrap text-gray-600 dark:text-gray-400 text-sm">
        <span>üè´ School: <strong id="archer-school" class="text-gray-800 dark:text-white">-</strong></span>
        <span>üìä Level: <strong id="archer-level" class="text-gray-800 dark:text-white">-</strong></span>
        <span>üë§ Gender: <strong id="archer-gender" class="text-gray-800 dark:text-white">-</strong></span>
        <span>üéØ Total Rounds: <strong id="total-rounds" class="text-gray-800 dark:text-white">0</strong></span>
      </div>
    </div>

    <!-- Loading/Error States -->
    <div id="loading" class="text-center py-12 text-gray-600 dark:text-gray-400">Loading history...</div>
    <div id="error" class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-400 px-4 py-3 rounded-lg my-6 hidden"></div>

    <!-- History List -->
    <div id="history-container" class="mb-6 hidden">
      <div id="history-body" class="space-y-3">
        <!-- Populated dynamically with unified scorecard list items -->
      </div>
    </div>

    <div id="no-history" class="text-center py-12 text-gray-500 dark:text-gray-400 hidden">
      <p class="text-lg mb-2">No scoring history found.</p>
      <p>Start scoring to build your history!</p>
    </div>
  </div>

  <footer class="fixed bottom-0 left-0 right-0 px-4 py-3 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 shadow-lg transition-colors duration-200">
    <div class="max-w-6xl mx-auto">
      <a href="archer_list.html" class="inline-block px-6 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors min-h-[44px] flex items-center justify-center">‚Üê Back to Archer List</a>
    </div>
  </footer>

  <script>
    // Dark mode toggle
    const darkModeToggle = document.getElementById('dark-mode-toggle');
    const htmlElement = document.documentElement;
    
    // Check for saved preference or default to light mode
    const savedTheme = localStorage.getItem('theme') || 'light';
    if (savedTheme === 'dark') {
      htmlElement.classList.add('dark');
    }
    
    darkModeToggle.addEventListener('click', () => {
      htmlElement.classList.toggle('dark');
      const newTheme = htmlElement.classList.contains('dark') ? 'dark' : 'light';
      localStorage.setItem('theme', newTheme);
    });
    
    // Use local API when running on localhost, otherwise use production
    const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
      ? `${window.location.protocol}//${window.location.hostname}:${window.location.port || 8001}/api/index.php/v1`
      : 'https://tryentist.com/wdv/api/v1';
    const urlParams = new URLSearchParams(window.location.search);
    const archerId = urlParams.get('archer') || urlParams.get('id') || urlParams.get('extId');
    
    // Store archer data globally so it can be accessed when viewing scorecards
    let currentArcherData = null;

    async function loadHistory() {
      if (!archerId) {
        showError('No archer ID provided. Please use ?archer={id} or ?extId={localId} in the URL.');
        return;
      }

      try {
        // Try with the provided ID first (could be UUID or external ID)
        let res = await fetch(`${API_BASE}/archers/${encodeURIComponent(archerId)}/history`);
        
        // If 404 and looks like external ID (contains hyphens but not UUID format), try searching by external ID
        if (!res.ok && res.status === 404 && archerId.includes('-') && !archerId.match(/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i)) {
          console.log('First attempt failed, trying to find archer by external ID...');
          // Get all archers and find by external ID
          const archersRes = await fetch(`${API_BASE}/archers`);
          if (archersRes.ok) {
            const archersData = await archersRes.json();
            const archer = (archersData.archers || []).find(a => 
              (a.extId || '').toLowerCase() === archerId.toLowerCase() ||
              `${a.first_name}-${a.last_name}`.toLowerCase().replace(/\s+/g, '-') === archerId.toLowerCase()
            );
            if (archer && archer.id) {
              console.log('Found archer by external ID, fetching history with UUID:', archer.id);
              res = await fetch(`${API_BASE}/archers/${encodeURIComponent(archer.id)}/history`);
            }
          }
        }
        
        if (!res.ok) {
          if (res.status === 404) {
            showError('Archer not found. They may not have scored any rounds yet.');
          } else {
            throw new Error(`HTTP ${res.status}`);
          }
          return;
        }
        
        const data = await res.json();
        console.log('Archer history:', data);
        
        // Store archer data globally for scorecard viewing
        currentArcherData = data.archer;

        // Update archer info
        document.getElementById('archer-name').textContent = data.archer.fullName;
        document.getElementById('archer-school').textContent = data.archer.school || 'N/A';
        document.getElementById('archer-level').textContent = data.archer.level || 'N/A';
        document.getElementById('archer-gender').textContent = data.archer.gender === 'M' ? 'Male' : data.archer.gender === 'F' ? 'Female' : 'N/A';
        document.getElementById('total-rounds').textContent = data.totalRounds;
        document.getElementById('archer-info').classList.remove('hidden');

        // Render history
        if (data.history.length === 0) {
          document.getElementById('no-history').classList.remove('hidden');
        } else {
          renderHistory(data.history);
          document.getElementById('history-container').classList.remove('hidden');
        }

        document.getElementById('loading').classList.add('hidden');
      } catch (err) {
        console.error('Error loading history:', err);
        showError('Failed to load archer history: ' + err.message);
      }
    }

    function renderHistory(history) {
      const container = document.getElementById('history-body');
      container.innerHTML = '';

      if (history.length === 0) {
        container.innerHTML = '<div class="text-center py-12 text-gray-500 dark:text-gray-400">No scoring history found for this archer.</div>';
        return;
      }

      const divisionNames = {
        'BVAR': 'Boys Varsity',
        'GVAR': 'Girls Varsity', 
        'BJV': 'Boys JV',
        'GJV': 'Girls JV'
      };

      history.forEach(round => {
        const item = document.createElement('div');
        item.className = 'scorecard-list-item';
        
        const isLocked = round.locked || round.card_status === 'VER';
        const canDelete = !isLocked && (
          round.ends_completed === 0 || 
          round.final_score === 0 || 
          (round.ends_completed <= 3 && round.final_score < 100) ||
          round.event_name?.toLowerCase().includes('test') || 
          round.event_name?.toLowerCase().includes('practice')
        );
        
        // Status badge
        let statusBadge = '';
        if (round.card_status === 'VER') {
          statusBadge = '<span class="status-badge verified">‚úì VER</span>';
        } else if (round.card_status === 'VOID') {
          statusBadge = '<span class="status-badge void">‚úó VOID</span>';
        } else if (isLocked) {
          statusBadge = '<span class="status-badge locked">üîí LOCKED</span>';
        } else {
          statusBadge = '<span class="status-badge pending">‚è≥ PEND</span>';
        }
        
        // Calculate average arrow score
        const avgArrow = round.final_score && round.ends_completed ? 
          (round.final_score / (round.ends_completed * 3)).toFixed(1) : '0.0';
        
        // Format date
        const eventDate = round.event_date ? new Date(round.event_date).toLocaleDateString('en-US', { 
          month: 'short', day: 'numeric', year: '2-digit' 
        }) : 'N/A';
        
        item.innerHTML = `
          <div class="scorecard-event-name">${round.event_name || 'Unknown Event'}</div>
          
          <div class="scorecard-event-details">
            <span class="scorecard-event-detail">${eventDate}</span>
            <span class="scorecard-event-detail">‚Ä¢ ${round.round_type || 'R300'}</span>
            <span class="scorecard-event-detail">‚Ä¢ ${divisionNames[round.division] || round.division || 'Open Div'}</span>
            <span class="scorecard-event-detail">‚Ä¢ Bale ${round.bale_number || '?'} ${round.target_assignment || ''}</span>
          </div>
          
          <div class="scorecard-stats-grid">
            <div class="scorecard-stat">
              <div class="scorecard-stat-label">STATUS</div>
              <div class="scorecard-stat-value">${statusBadge}</div>
            </div>
            <div class="scorecard-stat">
              <div class="scorecard-stat-label">TOTAL</div>
              <div class="scorecard-stat-value large">${round.final_score || 0}</div>
            </div>
            <div class="scorecard-stat">
              <div class="scorecard-stat-label">AVG</div>
              <div class="scorecard-stat-value">${avgArrow}</div>
            </div>
            <div class="scorecard-stat">
              <div class="scorecard-stat-label">Xs</div>
              <div class="scorecard-stat-value">${round.total_xs || 0}</div>
            </div>
            <div class="scorecard-stat">
              <div class="scorecard-stat-label">10s</div>
              <div class="scorecard-stat-value">${(round.total_tens || 0) + (round.total_xs || 0)}</div>
            </div>
          </div>
          
          <div class="scorecard-actions">
            ${canDelete ? `
              <button onclick="deleteScorecard('${round.round_id}', '${round.round_archer_id}', '${round.event_name}', this)" 
                      class="scorecard-action-btn delete" title="Delete abandoned scorecard">
                <i class="fas fa-trash-alt"></i>
              </button>
            ` : ''}
            <button onclick="event.stopPropagation(); showRoundScorecard(${JSON.stringify(round).replace(/"/g, '&quot;')})" 
                    class="scorecard-action-btn view" title="View scorecard details">
              <i class="fas fa-eye"></i>
            </button>
          </div>
        `;

        // Make the whole item clickable except for action buttons
        item.onclick = (e) => {
          if (e.target.closest('.scorecard-actions')) return;
          showRoundScorecard(round);
        };

        container.appendChild(item);
      });
    }

    function showError(message) {
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('error').textContent = message;
      document.getElementById('error').classList.remove('hidden');
    }
    
    async function showRoundScorecard(round) {
      // Fetch detailed scorecard data from API
      try {
        if (typeof ScorecardView === 'undefined') {
          alert('Scorecard viewer is not loaded. Please refresh the page.');
          return;
        }
        
        console.log('Round data received:', round);
        
        // Extract the correct field names (API might return different field names)
        const roundId = round.round_id || round.roundId || round.id;
        const archerIdForRequest = round.archer_id || round.archerId;
        
        // Check if we need to fetch from API or if we have the data already
        if (!roundId || !archerIdForRequest) {
          console.error('Missing round or archer information. Round data:', round);
          alert('Missing round or archer information. Round ID: ' + roundId + ', Archer ID: ' + archerIdForRequest);
          return;
        }
        
        console.log('Fetching scorecard for round:', roundId, 'archer:', archerIdForRequest);
        const res = await fetch(`${API_BASE}/rounds/${roundId}/archers/${archerIdForRequest}/scorecard`);
        if (!res.ok) {
          if (res.status === 404) {
            alert('Scorecard not found. This round may not have been scored yet.');
          } else {
            alert(`Unable to load scorecard details (HTTP ${res.status})`);
          }
          return;
        }
        
        const scorecardData = await res.json();
        console.log('Scorecard data:', scorecardData);
        
        // Extract scores from ends
        const scores = (scorecardData.ends || []).map(end => [
          end.a1 || '',
          end.a2 || '',
          end.a3 || ''
        ]);
        
        // Use globally stored archer data for name and details
        const archerData = {
          id: round.archer_id,
          firstName: currentArcherData ? currentArcherData.firstName : '',
          lastName: currentArcherData ? currentArcherData.lastName : '',
          school: currentArcherData ? currentArcherData.school : '',
          level: currentArcherData ? currentArcherData.level : '',
          gender: currentArcherData ? currentArcherData.gender : '',
          scores: scores,
          verified: scorecardData.verified || false,
          completed: (scorecardData.ends_completed >= 10)
        };
        
        const roundData = {
          totalEnds: 10,
          eventName: round.event_name || '',
          division: round.division || '',
          roundType: round.round_type || 'R300'
        };
        
        ScorecardView.showScorecardModal(archerData, roundData);
      } catch (err) {
        console.error('Error loading scorecard:', err);
        alert('Error loading scorecard: ' + err.message + '\n\nCheck console for details.');
      }
    }

    async function deleteScorecard(roundId, roundArcherId, eventName, buttonElement) {
      if (!confirm(`Delete this abandoned scorecard from "${eventName}"?\n\nThis action cannot be undone.`)) {
        return;
      }
      
      try {
        // Disable button during request
        buttonElement.disabled = true;
        buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        
        // Check if current user is the owner of this scorecard
        const isOwner = currentArcherData && currentArcherData.id === archerId;
        
        let headers = {
          'Content-Type': 'application/json'
        };
        
        if (isOwner) {
          // Archer deleting their own scorecard - use archer authentication
          headers['X-Archer-ID'] = archerId;
          headers['X-Archer-Self'] = 'true';
        } else {
          // Coach or other user - use coach credentials
          const coachApiKey = localStorage.getItem('coach_api_key') || 
                             localStorage.getItem('coach_passcode') || 
                             getCookie('coach_auth') || 
                             'wdva26'; // Default coach passcode
          
          headers['X-Passcode'] = coachApiKey;
          headers['X-API-Key'] = coachApiKey;
        }
        
        const response = await fetch(`${API_BASE}/rounds/${roundId}/archers/${roundArcherId}`, {
          method: 'DELETE',
          headers: headers
        });
        
        if (!response.ok) {
          if (response.status === 401 || response.status === 403) {
            if (isOwner) {
              throw new Error('You can only delete your own abandoned scorecards. Make sure you have set yourself in the Archer Details.');
            } else {
              throw new Error('Authentication required. Please visit the Coach Console to authenticate first, then try again.');
            }
          }
          const errorText = await response.text().catch(() => 'Unknown error');
          throw new Error(`Failed to delete scorecard (HTTP ${response.status}): ${errorText}`);
        }
        
        const result = await response.json();
        if (result.ok) {
          alert('Scorecard deleted successfully!');
          // Reload the history to reflect changes
          loadHistory();
        } else {
          throw new Error(result.error || 'Delete failed');
        }
      } catch (error) {
        console.error('Delete scorecard error:', error);
        alert('Failed to delete scorecard: ' + error.message);
        
        // Re-enable button on error
        buttonElement.disabled = false;
        buttonElement.innerHTML = '<i class="fas fa-trash-alt"></i>';
      }
    }
    
    // Helper function to get cookie value
    function getCookie(name) {
      const nameEQ = name + '=';
      const ca = document.cookie.split(';');
      for (let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) === ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
      }
      return null;
    }

    // Load history on page load
    document.addEventListener('DOMContentLoaded', loadHistory);
  </script>
</body>
</html>

