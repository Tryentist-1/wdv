<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Event Results</title>
  <link rel="stylesheet" href="css/main.css">
  <script src="js/scorecard_view.js"></script>
  <style>
    .results-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 2rem;
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .results-header h1 {
      margin: 0 0 0.5rem 0;
    }
    
    .results-meta {
      display: flex;
      justify-content: center;
      gap: 2rem;
      flex-wrap: wrap;
      font-size: 0.95rem;
      opacity: 0.95;
    }
    
    .division-section {
      margin-bottom: 3rem;
    }
    
    .division-header {
      background: #2c3e50;
      color: white;
      padding: 1rem;
      border-radius: 8px 8px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .division-name {
      font-size: 1.3rem;
      font-weight: 600;
    }
    
    .division-count {
      font-size: 0.9rem;
      opacity: 0.9;
    }
    
    .leaderboard-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-radius: 0 0 8px 8px;
      overflow: hidden;
    }
    
    .leaderboard-table thead {
      background: #34495e;
      color: white;
    }
    
    .leaderboard-table th {
      padding: 0.75rem;
      text-align: left;
      font-weight: 600;
      font-size: 0.9rem;
    }
    
    .leaderboard-table td {
      padding: 0.75rem;
      border-bottom: 1px solid #ecf0f1;
    }
    
    .leaderboard-table tbody tr:hover {
      background: #f8f9fa;
      cursor: pointer;
    }
    
    .rank-cell {
      font-weight: 700;
      font-size: 1.1rem;
      color: #2c3e50;
      width: 50px;
      text-align: center;
    }
    
    .rank-1 { color: #f39c12; }
    .rank-2 { color: #95a5a6; }
    .rank-3 { color: #cd7f32; }
    
    .archer-name {
      font-weight: 600;
    }
    
    .score-total {
      font-weight: 700;
      font-size: 1.1rem;
      color: #27ae60;
    }
    
    .no-scores {
      text-align: center;
      padding: 3rem;
      color: #7f8c8d;
      font-style: italic;
    }
    
    .empty-division {
      text-align: center;
      padding: 2rem;
      color: #95a5a6;
      background: #ecf0f1;
      border-radius: 0 0 8px 8px;
    }
    
    @media (max-width: 768px) {
      .results-header {
        padding: 1.5rem 1rem;
      }
      
      .results-meta {
        font-size: 0.85rem;
        gap: 1rem;
      }
      
      .leaderboard-table {
        font-size: 0.85rem;
      }
      
      .leaderboard-table th,
      .leaderboard-table td {
        padding: 0.5rem 0.3rem;
      }
    }
  </style>
</head>
<body>
  <div class="main-container">
    <!-- Results Header -->
    <div id="results-header" class="results-header">
      <h1 id="event-name">Loading...</h1>
      <div class="results-meta">
        <span>üìÖ <span id="event-date">-</span></span>
        <span>üìä Status: <span id="event-status">-</span></span>
      </div>
      <div style="margin-top: 1rem;">
        <button id="toggle-void-btn" class="btn btn-secondary">Show Voided Cards</button>
      </div>
    </div>

    <!-- Division Sections -->
    <div id="divisions-container">
      <!-- Populated dynamically -->
    </div>
  </div>

  <footer class="global-footer">
    <a href="coach.html" class="btn btn-secondary">‚Üê Back to Coach Console</a>
    <button id="refresh-btn" class="btn btn-primary">üîÑ Refresh</button>
  </footer>

  <script>
    function getApiBase() {
      // Detect localhost environments; default to production otherwise
      const { protocol, hostname, port } = window.location;
      if (hostname === 'localhost' || hostname === '127.0.0.1') {
        const resolvedPort = port || '8001';
        return `${protocol}//${hostname}:${resolvedPort}/api/index.php/v1`;
      }
      return 'https://tryentist.com/wdv/api/v1';
    }

    const API_BASE = getApiBase();
    const urlParams = new URLSearchParams(window.location.search);
    const eventId = urlParams.get('event');

    const DIVISION_NAMES = {
      'OPEN': 'Open (Mixed)',
      'BVAR': 'Boys Varsity',
      'GVAR': 'Girls Varsity',
      'BJV': 'Boys JV',
      'GJV': 'Girls JV'
    };

    let showVoided = false;
    let latestSnapshot = null;

    async function loadResults() {
      if (!eventId) {
        alert('No event ID provided');
        window.location.href = 'coach.html';
        return;
      }

      try {
        // Fetch event snapshot (PUBLIC endpoint - no auth required)
        const res = await fetch(`${API_BASE}/events/${eventId}/snapshot`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        
        const data = await res.json();
        console.log('API Response:', data);
        latestSnapshot = data;

        // Update header
        document.getElementById('event-name').textContent = data.event.name;
        document.getElementById('event-date').textContent = data.event.date;
        document.getElementById('event-status').textContent = data.event.status;

        // Render divisions
        renderDivisions(data.divisions || {});
      } catch (err) {
        console.error('Error loading results:', err);
        alert('Error loading results: ' + err.message);
      }
    }

    function renderDivisions(divisions) {
      const container = document.getElementById('divisions-container');
      container.innerHTML = '';

      // Define preferred order then filter to existing divisions
      const preferred = ['BVAR', 'GVAR', 'BJV', 'GJV', 'OPEN'];
      const existingKeys = Object.keys(divisions || {});
      const orderedKeys = preferred.filter(k => existingKeys.includes(k)).concat(
        existingKeys.filter(k => !preferred.includes(k))
      );

      if (orderedKeys.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'no-scores';
        empty.textContent = 'No divisions configured for this event yet.';
        container.appendChild(empty);
        return;
      }

      orderedKeys.forEach(divCode => {
        const division = divisions[divCode];
        const section = document.createElement('div');
        section.className = 'division-section';
        const allArchers = division ? (division.archers || []) : [];
        const visibleArchers = filterArchersForDisplay(allArchers);
        const hiddenCount = allArchers.length - visibleArchers.length;

        // Division Header
        const header = document.createElement('div');
        header.className = 'division-header';
        header.innerHTML = `
          <div class="division-name">${DIVISION_NAMES[divCode]}</div>
          <div class="division-count">${visibleArchers.length} showing${hiddenCount > 0 ? ` ‚Ä¢ ${hiddenCount} hidden` : ''}</div>
        `;
        section.appendChild(header);

        // Division Table
        if (visibleArchers.length === 0) {
          const empty = document.createElement('div');
          empty.className = 'empty-division';
          if (hiddenCount > 0) {
            empty.textContent = 'All scorecards are voided. Use "Show Voided Cards" to reveal them.';
          } else {
            empty.textContent = 'No archers assigned to this division';
          }
          section.appendChild(empty);
        } else {
          const table = createLeaderboardTable(visibleArchers);
          section.appendChild(table);
        }

        container.appendChild(section);
      });
    }

    function normTotal(a) {
      // Support different shapes from API (scorecard wrapper vs flat)
      if (a.runningTotal != null) return a.runningTotal;
      if (a.scorecard && a.scorecard.runningTotal != null) return a.scorecard.runningTotal;
      if (a.total != null) return a.total;
      return 0;
    }

    function getCardStatus(archer) {
      return ((archer.cardStatus || archer.status || 'PENDING') + '').toUpperCase();
    }

    function renderStatusBadge(status) {
      let color = '#f1c40f';
      if (status === 'VER') color = '#2ecc71';
      if (status === 'VOID') color = '#e74c3c';
      return `<span class="status-badge" style="background:${color};color:#fff;">${status}</span>`;
    }

    function filterArchersForDisplay(archers = []) {
      return archers.filter(a => {
        const status = getCardStatus(a);
        if (!showVoided && status === 'VOID') return false;
        return true;
      });
    }

    function createLeaderboardTable(archers) {
      // Sort by total (descending)
      const sorted = [...archers].sort((a, b) => normTotal(b) - normTotal(a));

      const table = document.createElement('table');
      table.className = 'leaderboard-table';

      // Table Header
      table.innerHTML = `
        <thead>
          <tr>
            <th>Rank</th>
            <th>Archer</th>
            <th>School</th>
            <th>Bale</th>
            <th>Target</th>
            <th>Status</th>
            <th>Total</th>
            <th>Avg</th>
            <th>Xs</th>
            <th>10s</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;

      const tbody = table.querySelector('tbody');

      sorted.forEach((archer, index) => {
        const rank = index + 1;
        const row = document.createElement('tr');
        
        const rankClass = rank <= 3 ? `rank-${rank}` : '';
        const total = normTotal(archer);
        const arrowsShot = (archer.scorecard && archer.scorecard.ends) ? archer.scorecard.ends.length * 3 : undefined;
        const avgVal = (arrowsShot && arrowsShot > 0) ? (total / arrowsShot) : (archer.avgPerArrow || 0);
        const avg = (typeof avgVal === 'number') ? avgVal.toFixed(1) : '0.0';
        const bale = archer.bale || archer.baleNumber || archer.bale_number || '-';
        const target = archer.target || archer.targetAssignment || archer.target_assignment || '-';
        const name = archer.archerName || archer.name || [archer.firstName, archer.lastName].filter(Boolean).join(' ');
        const status = getCardStatus(archer);
        const statusBadge = renderStatusBadge(status);

        row.innerHTML = `
          <td class="rank-cell ${rankClass}">${rank}</td>
          <td class="archer-name">${name} <span style="color: #3498db; font-size: 0.85rem;">üìÑ</span></td>
          <td>${archer.school || '-'}</td>
          <td>${bale}</td>
          <td>${target}</td>
          <td>${statusBadge}</td>
          <td class="score-total">${total}</td>
          <td>${avg}</td>
          <td>${archer.xs || (archer.scorecard && archer.scorecard.xs) || 0}</td>
          <td>${archer.tens || (archer.scorecard && archer.scorecard.tens) || 0}</td>
        `;
        
        // Make row clickable to view scorecard
        row.style.cursor = 'pointer';
        row.onclick = () => showArcherScorecard(archer);

        tbody.appendChild(row);
      });

      return table;
    }
    
    function showArcherScorecard(archer) {
      try {
        console.log('Showing scorecard for archer:', archer);
        
        // Check if we have scorecard data with ends
        if (!archer.scorecard || !archer.scorecard.ends || archer.scorecard.ends.length === 0) {
          console.warn('No scorecard data available for archer:', archer);
          alert('No scoring data available for this archer yet.');
          return;
        }
        
        // Extract scores from the archer data
        const scores = archer.scorecard.ends.map(end => [
          end.a1 || '', 
          end.a2 || '', 
          end.a3 || ''
        ]);
        
        const total = normTotal(archer);
        const status = getCardStatus(archer);
        
        // Use firstName/lastName from API (with fallback to parsing archerName if needed)
        const firstName = archer.firstName || archer.first_name || '';
        const lastName = archer.lastName || archer.last_name || '';
        
        // Handle multiple possible field names for archer properties
        const archerData = {
          id: archer.archerId || archer.id || archer.archer_id,
          firstName: firstName,
          lastName: lastName,
          school: archer.school || '',
          level: archer.level || '',
          gender: archer.gender || '',
          scores: scores,
          cardStatus: status,
          verified: status === 'VER',
          completed: status !== 'VOID'
        };
        
        const roundData = {
          totalEnds: 10,
          eventName: document.getElementById('event-name').textContent,
          division: archer.division || '',
          roundType: 'R300'
        };
        
        if (typeof ScorecardView === 'undefined') {
          alert('Scorecard viewer is not loaded. Please refresh the page.');
          return;
        }
        
        console.log('Opening scorecard modal with data:', { archerData, roundData });
        ScorecardView.showScorecardModal(archerData, roundData);
      } catch (err) {
        console.error('Error displaying scorecard:', err);
        alert('Unable to display scorecard. Error: ' + err.message);
      }
    }

    // Load results on page load
    document.addEventListener('DOMContentLoaded', loadResults);

    // Refresh button
    document.getElementById('refresh-btn').onclick = loadResults;
    document.getElementById('toggle-void-btn').onclick = () => {
      showVoided = !showVoided;
      const btn = document.getElementById('toggle-void-btn');
      btn.textContent = showVoided ? 'Hide Voided Cards' : 'Show Voided Cards';
      if (latestSnapshot) {
        renderDivisions(latestSnapshot.divisions || {});
      }
    };

    // Auto-refresh every 30 seconds for active events
    setInterval(() => {
      const status = document.getElementById('event-status').textContent;
      if (status === 'Active') {
        loadResults();
      }
    }, 30000);
  </script>
</body>
</html>

