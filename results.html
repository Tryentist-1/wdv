<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Event Results</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="css/tailwind-compiled.css">
  <link rel="stylesheet" href="css/unified-scorecard-list.css">
  <script src="js/scorecard_view.js"></script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen transition-colors duration-200">
  <div class="max-w-7xl mx-auto px-4 py-6 pb-24">
    <!-- Results Header -->
    <div id="results-header" class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6 transition-colors duration-200">
      <div class="flex justify-between items-start mb-4">
        <h1 id="event-name" class="text-3xl font-bold text-gray-800 dark:text-white">Loading...</h1>
        <button id="dark-mode-toggle" class="px-3 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors" title="Toggle dark mode">
          <span class="dark:hidden">üåô</span>
          <span class="hidden dark:inline">‚òÄÔ∏è</span>
        </button>
      </div>
      <div class="flex justify-center gap-8 flex-wrap text-gray-600 dark:text-gray-400 text-sm mb-4">
        <span>üìÖ <span id="event-date">-</span></span>
        <span>üìä Status: <span id="event-status">-</span></span>
      </div>
      <div class="text-center">
        <button id="toggle-void-btn" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors min-h-[44px]">Show Voided Cards</button>
      </div>
    </div>

    <!-- Division Sections -->
    <div id="divisions-container">
      <!-- Populated dynamically -->
    </div>
  </div>

  <footer class="fixed bottom-0 left-0 right-0 px-4 py-3 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 shadow-lg transition-colors duration-200">
    <div class="max-w-7xl mx-auto flex gap-2 justify-center flex-wrap">
      <a href="coach.html" class="px-6 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors min-h-[44px] flex items-center">‚Üê Back to Coach Console</a>
      <button id="refresh-btn" class="px-6 py-2 bg-primary hover:bg-primary-dark text-white rounded font-semibold transition-colors min-h-[44px]">üîÑ Refresh</button>
    </div>
  </footer>

  <script>
    // Initialize dark mode immediately (before DOMContentLoaded) to prevent flash
    (function() {
      const savedTheme = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
        document.documentElement.classList.add('dark');
      }
    })();
    
    // Dark mode toggle - wait for DOM
    document.addEventListener('DOMContentLoaded', () => {
      const darkModeToggle = document.getElementById('dark-mode-toggle');
      if (darkModeToggle) {
        darkModeToggle.addEventListener('click', () => {
          const htmlElement = document.documentElement;
          htmlElement.classList.toggle('dark');
          const newTheme = htmlElement.classList.contains('dark') ? 'dark' : 'light';
          localStorage.setItem('theme', newTheme);
        });
      }
    });
    
    function getApiBase() {
      // Detect localhost environments; default to production otherwise
      const { protocol, hostname, port } = window.location;
      if (hostname === 'localhost' || hostname === '127.0.0.1') {
        const resolvedPort = port || '8001';
        return `${protocol}//${hostname}:${resolvedPort}/api/index.php/v1`;
      }
      return 'https://tryentist.com/wdv/api/v1';
    }

    const API_BASE = getApiBase();
    const urlParams = new URLSearchParams(window.location.search);
    const eventId = urlParams.get('event');

    const DIVISION_NAMES = {
      'OPEN': 'Open (Mixed)',
      'BVAR': 'Boys Varsity',
      'GVAR': 'Girls Varsity',
      'BJV': 'Boys JV',
      'GJV': 'Girls JV'
    };

    let showVoided = false;
    let latestSnapshot = null;

    async function loadResults() {
      if (!eventId) {
        alert('No event ID provided');
        window.location.href = 'coach.html';
        return;
      }

      try {
        // Fetch event snapshot (PUBLIC endpoint - no auth required)
        const res = await fetch(`${API_BASE}/events/${eventId}/snapshot`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        
        const data = await res.json();
        console.log('API Response:', data);
        latestSnapshot = data;

        // Update header
        document.getElementById('event-name').textContent = data.event.name;
        document.getElementById('event-date').textContent = data.event.date;
        document.getElementById('event-status').textContent = data.event.status;

        // Render divisions
        renderDivisions(data.divisions || {});
      } catch (err) {
        console.error('Error loading results:', err);
        alert('Error loading results: ' + err.message);
      }
    }

    function renderDivisions(divisions) {
      const container = document.getElementById('divisions-container');
      container.innerHTML = '';

      // Define preferred order then filter to existing divisions
      const preferred = ['BVAR', 'GVAR', 'BJV', 'GJV', 'OPEN'];
      const existingKeys = Object.keys(divisions || {});
      const orderedKeys = preferred.filter(k => existingKeys.includes(k)).concat(
        existingKeys.filter(k => !preferred.includes(k))
      );

      if (orderedKeys.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'no-scores';
        empty.textContent = 'No divisions configured for this event yet.';
        container.appendChild(empty);
        return;
      }

      orderedKeys.forEach(divCode => {
        const division = divisions[divCode];
        const section = document.createElement('div');
        section.className = 'mb-8';
        const allArchers = division ? (division.archers || []) : [];
        const visibleArchers = filterArchersForDisplay(allArchers);
        const hiddenCount = allArchers.length - visibleArchers.length;

        // Division Header
        const header = document.createElement('div');
        header.className = 'bg-gray-800 dark:bg-gray-700 text-white px-4 py-3 rounded-t-lg flex justify-between items-center';
        header.innerHTML = `
          <div class="text-xl font-semibold">${DIVISION_NAMES[divCode]}</div>
          <div class="text-sm opacity-90">${visibleArchers.length} showing${hiddenCount > 0 ? ` ‚Ä¢ ${hiddenCount} hidden` : ''}</div>
        `;
        section.appendChild(header);

        // Division Table
        if (visibleArchers.length === 0) {
          const empty = document.createElement('div');
          empty.className = 'text-center py-8 text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-800 rounded-b-lg';
          if (hiddenCount > 0) {
            empty.textContent = 'All scorecards are voided. Use "Show Voided Cards" to reveal them.';
          } else {
            empty.textContent = 'No archers assigned to this division';
          }
          section.appendChild(empty);
        } else {
          const table = createLeaderboardTable(visibleArchers);
          section.appendChild(table);
        }

        container.appendChild(section);
      });
    }

    function normTotal(a) {
      // Support different shapes from API (scorecard wrapper vs flat)
      if (a.runningTotal != null) return a.runningTotal;
      if (a.scorecard && a.scorecard.runningTotal != null) return a.scorecard.runningTotal;
      if (a.total != null) return a.total;
      return 0;
    }

    function getCardStatus(archer) {
      return ((archer.cardStatus || archer.status || 'PENDING') + '').toUpperCase();
    }

    function renderStatusText(status) {
      if (status === 'VER') {
        return 'VER';
      } else if (status === 'VOID') {
        return 'VOID';
      } else if (status === 'PENDING' || status === 'PEND') {
        return 'PEND';
      } else {
        return 'COMP';
      }
    }

    function filterArchersForDisplay(archers = []) {
      return archers.filter(a => {
        const status = getCardStatus(a);
        if (!showVoided && status === 'VOID') return false;
        return true;
      });
    }

    function createLeaderboardTable(archers) {
      // Sort by total (descending)
      const sorted = [...archers].sort((a, b) => normTotal(b) - normTotal(a));

      const container = document.createElement('div');
      container.className = 'scorecard-list-container';
      
      // Add header row
      const header = document.createElement('div');
      header.className = 'scorecard-list-header';
      header.innerHTML = `
        <div>Archer</div>
        <div>Status</div>
        <div>Total</div>
        <div>Avg</div>
        <div>Xs</div>
        <div>10s</div>
      `;
      container.appendChild(header);

      sorted.forEach((archer, index) => {
        const rank = index + 1;
        const total = normTotal(archer);
        const arrowsShot = (archer.scorecard && archer.scorecard.ends) ? archer.scorecard.ends.length * 3 : undefined;
        const avgVal = (arrowsShot && arrowsShot > 0) ? (total / arrowsShot) : (archer.avgPerArrow || 0);
        const avg = (typeof avgVal === 'number') ? avgVal.toFixed(1) : '0.0';
        const bale = archer.bale || archer.baleNumber || archer.bale_number || '-';
        const target = archer.target || archer.targetAssignment || archer.target_assignment || '-';
        const name = archer.archerName || archer.name || [archer.firstName, archer.lastName].filter(Boolean).join(' ');
        const status = getCardStatus(archer);
        const statusText = renderStatusText(status);
        
        // Rank styling
        const rankColor = rank === 1 ? 'text-yellow-500' : rank === 2 ? 'text-gray-400' : rank === 3 ? 'text-orange-600' : 'text-gray-600';
        const rankIcon = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : `#${rank}`;

        const item = document.createElement('div');
        item.className = 'scorecard-list-item';
        item.onclick = () => showArcherScorecard(archer);

        item.innerHTML = `
          <div class="scorecard-event-info">
            <div class="scorecard-event-name">
              <span class="${rankColor} font-bold mr-2">${rankIcon}</span>
              ${name}
            </div>
            <div class="scorecard-event-details">${archer.school || 'No School'} ‚Ä¢ Bale ${bale} ‚Ä¢ Target ${target}</div>
          </div>
          <div class="scorecard-stat-value">${statusText}</div>
          <div class="scorecard-stat-value total">${total}</div>
          <div class="scorecard-stat-value">${avg}</div>
          <div class="scorecard-stat-value">${archer.xs || (archer.scorecard && archer.scorecard.xs) || 0}</div>
          <div class="scorecard-stat-value">${archer.tens || (archer.scorecard && archer.scorecard.tens) || 0}</div>
        `;

        container.appendChild(item);
      });

      return container;
    }
    
    function showArcherScorecard(archer) {
      try {
        console.log('Showing scorecard for archer:', archer);
        
        // Check if we have scorecard data with ends
        if (!archer.scorecard || !archer.scorecard.ends || archer.scorecard.ends.length === 0) {
          console.warn('No scorecard data available for archer:', archer);
          alert('No scoring data available for this archer yet.');
          return;
        }
        
        // Extract scores from the archer data
        const scores = archer.scorecard.ends.map(end => [
          end.a1 || '', 
          end.a2 || '', 
          end.a3 || ''
        ]);
        
        const total = normTotal(archer);
        const status = getCardStatus(archer);
        
        // Use firstName/lastName from API (with fallback to parsing archerName if needed)
        const firstName = archer.firstName || archer.first_name || '';
        const lastName = archer.lastName || archer.last_name || '';
        
        // Handle multiple possible field names for archer properties
        const archerData = {
          id: archer.archerId || archer.id || archer.archer_id,
          firstName: firstName,
          lastName: lastName,
          school: archer.school || '',
          level: archer.level || '',
          gender: archer.gender || '',
          scores: scores,
          cardStatus: status,
          verified: status === 'VER',
          completed: status !== 'VOID'
        };
        
        const roundData = {
          totalEnds: 10,
          eventName: document.getElementById('event-name').textContent,
          division: archer.division || '',
          roundType: 'R300'
        };
        
        if (typeof ScorecardView === 'undefined') {
          alert('Scorecard viewer is not loaded. Please refresh the page.');
          return;
        }
        
        console.log('Opening scorecard modal with data:', { archerData, roundData });
        ScorecardView.showScorecardModal(archerData, roundData);
      } catch (err) {
        console.error('Error displaying scorecard:', err);
        alert('Unable to display scorecard. Error: ' + err.message);
      }
    }

    // Load results on page load
    document.addEventListener('DOMContentLoaded', loadResults);

    // Refresh button
    document.getElementById('refresh-btn').onclick = loadResults;
    document.getElementById('toggle-void-btn').onclick = () => {
      showVoided = !showVoided;
      const btn = document.getElementById('toggle-void-btn');
      btn.textContent = showVoided ? 'Hide Voided Cards' : 'Show Voided Cards';
      if (latestSnapshot) {
        renderDivisions(latestSnapshot.divisions || {});
      }
    };

    // Auto-refresh every 30 seconds for active events
    setInterval(() => {
      const status = document.getElementById('event-status').textContent;
      if (status === 'Active') {
        loadResults();
      }
    }, 30000);
  </script>
</body>
</html>

