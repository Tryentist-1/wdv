<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scorecard Editor</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'score-gold': '#FFD700',
                        'score-red': '#DC143C',
                        'score-blue': '#4169E1',
                        'score-black': '#000000',
                        'score-white': '#FFFFFF',
                        'score-miss': '#808080',
                        'primary': {
                            DEFAULT: '#2d7dd9',
                            dark: '#1b5bbf',
                        },
                        'success': {
                            DEFAULT: '#28a745',
                            dark: '#1e7e34',
                        },
                        'danger': {
                            DEFAULT: '#d92d20',
                            dark: '#b0241a',
                        },
                        'warning': {
                            DEFAULT: '#ffc107',
                            dark: '#ff9800',
                        },
                    }
                }
            }
        };
    </script>
    
    <style>
        /* Score cell styling */
        .score-cell {
            width: 40px;
            height: 40px;
            text-align: center;
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .score-cell:hover:not(.locked) {
            border-color: #2d7dd9;
            transform: scale(1.05);
        }
        
        .score-cell.locked {
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .score-cell.editing {
            border-color: #28a745;
            background-color: #e7f5e9;
        }
        
        /* Score colors */
        .score-X, .score-10 { background-color: #FFD700; color: #000; }
        .score-9 { background-color: #FFD700; color: #000; }
        .score-8 { background-color: #DC143C; color: #FFF; }
        .score-7 { background-color: #DC143C; color: #FFF; }
        .score-6 { background-color: #4169E1; color: #FFF; }
        .score-5 { background-color: #4169E1; color: #FFF; }
        .score-4 { background-color: #000000; color: #FFF; }
        .score-3 { background-color: #000000; color: #FFF; }
        .score-2 { background-color: #FFFFFF; color: #000; border: 1px solid #ccc; }
        .score-1 { background-color: #FFFFFF; color: #000; border: 1px solid #ccc; }
        .score-M { background-color: #808080; color: #FFF; }
        .score-empty { background-color: #f3f4f6; color: #9ca3af; }
        
        /* Dark mode adjustments */
        .dark .score-empty { background-color: #374151; }
        .dark .score-2, .dark .score-1 { background-color: #e5e7eb; }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-200">
    
    <!-- Header -->
    <header class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-gray-800 dark:text-white">Scorecard Editor</h1>
                <p class="text-sm text-gray-600 dark:text-gray-400">View and edit scorecard with verification tracking</p>
            </div>
            <button onclick="window.history.back()" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded hover:bg-gray-300 dark:hover:bg-gray-600 transition">
                ‚Üê Back
            </button>
        </div>
    </header>
    
    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-6">
        
        <!-- Search Interface (shown when no ID provided) -->
        <div id="search-interface" class="hidden">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-4">Find Scorecard</h2>
                <p class="text-gray-600 dark:text-gray-400 mb-4">Search for an archer to view their scorecards:</p>
                
                <div class="mb-4">
                    <input type="text" id="archer-search-input" placeholder="üîç Search by archer name..." 
                           class="w-full px-4 py-3 border-2 border-gray-300 dark:border-gray-600 rounded-lg text-base bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:border-primary focus:outline-none transition-colors">
                </div>
                
                <div id="search-results" class="space-y-2">
                    <!-- Results will be populated here -->
                </div>
            </div>
            
            <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
                <h3 class="font-bold text-blue-800 dark:text-blue-300 mb-2">üí° Other Ways to Find Scorecard IDs:</h3>
                <ul class="text-sm text-blue-700 dark:text-blue-400 space-y-1 ml-4">
                    <li>‚Ä¢ <strong>From Pivot View:</strong> Go to <a href="archer_results_pivot.html" class="underline">Results Pivot</a> and click on a score</li>
                    <li>‚Ä¢ <strong>From Archer History:</strong> Go to <a href="archer_history.html" class="underline">Archer History</a> and select an archer</li>
                    <li>‚Ä¢ <strong>From Data Admin:</strong> Go to <a href="api/data_admin.php" class="underline">Admin Panel</a> and search the database</li>
                    <li>‚Ä¢ <strong>Direct URL:</strong> Use <code class="bg-blue-100 dark:bg-blue-900 px-1 rounded">?id={round_archer_id}&mode=coach</code></li>
                </ul>
            </div>
        </div>
        
        <!-- Loading State -->
        <div id="loading" class="hidden text-center py-12">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
            <p class="mt-4 text-gray-600 dark:text-gray-400">Loading scorecard...</p>
        </div>
        
        <!-- Error State -->
        <div id="error" class="hidden bg-danger/10 border border-danger text-danger px-6 py-4 rounded-lg">
            <h3 class="font-bold mb-2">Error Loading Scorecard</h3>
            <p id="error-message"></p>
        </div>
        
        <!-- Scorecard Container -->
        <div id="scorecard-container" class="hidden">
            
            <!-- Archer Info Card -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 id="archer-name" class="text-3xl font-bold text-gray-800 dark:text-white mb-2"></h2>
                        <div class="flex gap-4 text-sm text-gray-600 dark:text-gray-400">
                            <span id="archer-school" class="font-medium"></span>
                            <span id="archer-level"></span>
                            <span id="archer-gender"></span>
                            <span id="archer-bale"></span>
                        </div>
                        <div class="mt-2">
                            <span id="event-name" class="text-lg font-semibold text-gray-700 dark:text-gray-300"></span>
                            <span id="round-type" class="ml-2 text-sm text-gray-600 dark:text-gray-400"></span>
                        </div>
                    </div>
                    <div id="status-badge"></div>
                </div>
                
                <!-- Lock/Unlock Controls (Coach only) -->
                <div id="lock-controls" class="hidden mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                    <div class="flex gap-3 items-center">
                        <button id="unlock-btn" class="px-4 py-2 bg-warning text-white rounded hover:bg-warning-dark transition font-semibold">
                            üîì Unlock for Editing
                        </button>
                        <button id="lock-btn" class="hidden px-4 py-2 bg-success text-white rounded hover:bg-success-dark transition font-semibold">
                            üîí Lock & Save
                        </button>
                        <input type="text" id="edit-reason" placeholder="Reason for edit (required)" 
                               class="hidden flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-800 dark:text-white">
                    </div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">
                        ‚ö†Ô∏è Unlocking will allow score corrections. All changes are logged in verification history.
                    </p>
                </div>
            </div>
            
            <!-- Scorecard Table -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
                <div class="overflow-x-auto">
                    <table id="scorecard-table" class="w-full border-collapse">
                        <!-- Table will be dynamically generated -->
                    </table>
                </div>
                
                <!-- Score Totals -->
                <div class="mt-6 grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-4">
                        <div class="text-sm text-gray-600 dark:text-gray-400">Total Score</div>
                        <div id="total-score" class="text-3xl font-bold text-gray-800 dark:text-white">0</div>
                    </div>
                    <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-4">
                        <div class="text-sm text-gray-600 dark:text-gray-400">X Count</div>
                        <div id="x-count" class="text-3xl font-bold text-gray-800 dark:text-white">0</div>
                    </div>
                    <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-4">
                        <div class="text-sm text-gray-600 dark:text-gray-400">10 Count</div>
                        <div id="ten-count" class="text-3xl font-bold text-gray-800 dark:text-white">0</div>
                    </div>
                    <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-4">
                        <div class="text-sm text-gray-600 dark:text-gray-400">Avg/Arrow</div>
                        <div id="avg-arrow" class="text-3xl font-bold text-gray-800 dark:text-white">0.0</div>
                    </div>
                </div>
            </div>
            
            <!-- Verification History -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Verification History</h3>
                <div id="verification-history" class="space-y-2">
                    <!-- History will be dynamically generated -->
                </div>
            </div>
            
        </div>
    </main>
    
    <!-- Score Input Modal -->
    <div id="score-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Edit Score</h3>
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                End <span id="modal-end"></span>, Arrow <span id="modal-arrow"></span>
            </p>
            
            <!-- Score Buttons -->
            <div class="grid grid-cols-4 gap-2 mb-4">
                <button onclick="setScore('X')" class="score-btn score-X px-4 py-3 rounded font-bold text-lg">X</button>
                <button onclick="setScore('10')" class="score-btn score-10 px-4 py-3 rounded font-bold text-lg">10</button>
                <button onclick="setScore('9')" class="score-btn score-9 px-4 py-3 rounded font-bold text-lg">9</button>
                <button onclick="setScore('8')" class="score-btn score-8 px-4 py-3 rounded font-bold text-lg">8</button>
                <button onclick="setScore('7')" class="score-btn score-7 px-4 py-3 rounded font-bold text-lg">7</button>
                <button onclick="setScore('6')" class="score-btn score-6 px-4 py-3 rounded font-bold text-lg">6</button>
                <button onclick="setScore('5')" class="score-btn score-5 px-4 py-3 rounded font-bold text-lg">5</button>
                <button onclick="setScore('4')" class="score-btn score-4 px-4 py-3 rounded font-bold text-lg">4</button>
                <button onclick="setScore('3')" class="score-btn score-3 px-4 py-3 rounded font-bold text-lg">3</button>
                <button onclick="setScore('2')" class="score-btn score-2 px-4 py-3 rounded font-bold text-lg">2</button>
                <button onclick="setScore('1')" class="score-btn score-1 px-4 py-3 rounded font-bold text-lg">1</button>
                <button onclick="setScore('M')" class="score-btn score-M px-4 py-3 rounded font-bold text-lg">M</button>
            </div>
            
            <div class="flex gap-3">
                <button onclick="closeScoreModal()" class="flex-1 px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded hover:bg-gray-300 dark:hover:bg-gray-600 transition">
                    Cancel
                </button>
                <button onclick="clearScore()" class="flex-1 px-4 py-2 bg-danger text-white rounded hover:bg-danger-dark transition">
                    Clear
                </button>
            </div>
        </div>
    </div>
    
    <script src="js/common.js"></script>
    <script>
        const API_BASE = '/wdv/api/v1';
        let currentScorecard = null;
        let currentEndIndex = null;
        let currentArrowIndex = null;
        let isLocked = true;
        let isCoach = false;
        
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const roundArcherId = urlParams.get('id');
        const mode = urlParams.get('mode') || 'view'; // view, coach, practice
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Check if coach mode
            isCoach = mode === 'coach' || localStorage.getItem('coach_passcode');
            
            // For practice mode, always allow editing (no lock controls)
            if (mode === 'practice') {
                isCoach = false;
                isLocked = false;
            }
            
            if (!roundArcherId) {
                // Show search interface instead of error
                showSearchInterface();
                return;
            }
            
            loadScorecard();
        });
        
        function showSearchInterface() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('search-interface').classList.remove('hidden');
            
            const searchInput = document.getElementById('archer-search-input');
            searchInput.addEventListener('input', debounce(searchArchers, 300));
        }
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        async function searchArchers() {
            const query = document.getElementById('archer-search-input').value.trim();
            const resultsDiv = document.getElementById('search-results');
            
            if (query.length < 2) {
                resultsDiv.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400">Type at least 2 characters to search...</p>';
                return;
            }
            
            resultsDiv.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400">Searching...</p>';
            
            try {
                // Search recent events for scorecards matching the query
                const res = await fetch(`${API_BASE}/events/recent?limit=50`);
                if (!res.ok) throw new Error('Search failed');
                
                const data = await res.json();
                const events = data.events || [];
                
                // Collect all scorecards that match the search query
                const matchingCards = new Map(); // Group by archer name
                
                for (const event of events) {
                    if (!event.divisions) continue;
                    
                    for (const division of event.divisions) {
                        if (!division.archers) continue;
                        
                        for (const archer of division.archers) {
                            const archerName = `${archer.firstName || ''} ${archer.lastName || ''}`.trim();
                            const archerNameLower = archerName.toLowerCase();
                            const queryLower = query.toLowerCase();
                            
                            // Check if archer name matches query
                            if (archerNameLower.includes(queryLower)) {
                                if (!matchingCards.has(archerName)) {
                                    matchingCards.set(archerName, {
                                        name: archerName,
                                        firstName: archer.firstName || '',
                                        lastName: archer.lastName || '',
                                        school: archer.school || '',
                                        cards: []
                                    });
                                }
                                
                                matchingCards.get(archerName).cards.push({
                                    roundArcherId: archer.roundArcherId,
                                    eventName: event.name,
                                    eventDate: event.date,
                                    roundType: division.roundType,
                                    division: division.division,
                                    cardStatus: archer.cardStatus || 'PENDING',
                                    score: archer.score || 0
                                });
                            }
                        }
                    }
                }
                
                if (matchingCards.size === 0) {
                    resultsDiv.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400">No archers found</p>';
                    return;
                }
                
                // Render results
                let html = '';
                let count = 0;
                for (const [archerName, archerData] of matchingCards) {
                    if (count >= 10) break; // Limit to 10 archers
                    count++;
                    
                    html += `
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 bg-gray-50 dark:bg-gray-700">
                            <h4 class="font-bold text-gray-800 dark:text-white mb-2">
                                ${archerData.firstName} ${archerData.lastName}
                                ${archerData.school ? `<span class="text-sm font-normal text-gray-600 dark:text-gray-400">(${archerData.school})</span>` : ''}
                            </h4>
                            <div class="space-y-1">
                    `;
                    
                    // Sort cards by date (newest first)
                    archerData.cards.sort((a, b) => (b.eventDate || '').localeCompare(a.eventDate || ''));
                    
                    archerData.cards.forEach(card => {
                        const statusBadge = card.cardStatus === 'VER' ? '‚úì' : 
                                          card.cardStatus === 'VOID' ? '‚úó' : '‚è≥';
                        const statusColor = card.cardStatus === 'VER' ? 'text-success' : 
                                          card.cardStatus === 'VOID' ? 'text-gray-500' : 'text-warning';
                        
                        html += `
                            <a href="?id=${card.roundArcherId}&mode=${mode}" 
                               class="block px-3 py-2 bg-white dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-600 rounded border border-gray-200 dark:border-gray-600 transition-colors">
                                <div class="flex justify-between items-center">
                                    <div class="text-sm">
                                        <span class="font-medium">${card.eventName || 'Event'}</span>
                                        <span class="text-gray-600 dark:text-gray-400">‚Ä¢ ${card.roundType || card.division || 'Round'}</span>
                                        ${card.eventDate ? `<span class="text-gray-500 dark:text-gray-500">‚Ä¢ ${card.eventDate}</span>` : ''}
                                    </div>
                                    <span class="${statusColor} font-bold">${statusBadge}</span>
                                </div>
                                ${card.score > 0 ? `<div class="text-xs text-gray-600 dark:text-gray-400 mt-1">Score: ${card.score}</div>` : ''}
                            </a>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
                
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                console.error('[searchArchers] Error:', error);
                resultsDiv.innerHTML = '<p class="text-sm text-danger">Search failed. Please try again.</p>';
            }
        }
        
        async function loadScorecard() {
            try {
                const res = await fetch(`${API_BASE}/round_archers/${roundArcherId}`);
                if (!res.ok) throw new Error(`Failed to load scorecard: ${res.status}`);
                
                currentScorecard = await res.json();
                renderScorecard();
                
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('scorecard-container').classList.remove('hidden');
            } catch (error) {
                console.error('[loadScorecard] Error:', error);
                showError(error.message);
            }
        }
        
        function renderScorecard() {
            const card = currentScorecard;
            
            // Archer Info
            document.getElementById('archer-name').textContent = card.archer_name || 'Unknown Archer';
            document.getElementById('archer-school').textContent = card.school || '';
            document.getElementById('archer-level').textContent = card.level || '';
            document.getElementById('archer-gender').textContent = card.gender === 'M' ? 'Boys' : card.gender === 'F' ? 'Girls' : '';
            document.getElementById('archer-bale').textContent = card.bale_number ? `Bale ${card.bale_number}${card.target_assignment || ''}` : '';
            
            // Event/Round Info
            document.getElementById('event-name').textContent = card.event_name || '';
            document.getElementById('round-type').textContent = card.round_type || '';
            
            // Status Badge
            // For practice mode, never lock
            if (mode === 'practice') {
                isLocked = false;
            } else {
                isLocked = card.locked || card.card_status === 'VER' || card.card_status === 'VOID';
            }
            
            const statusBadge = document.getElementById('status-badge');
            if (mode === 'practice') {
                statusBadge.innerHTML = '<span class="inline-block px-4 py-2 bg-primary text-white rounded-full text-sm font-bold">PRACTICE</span>';
            } else if (card.card_status === 'VER') {
                statusBadge.innerHTML = '<span class="inline-block px-4 py-2 bg-success text-white rounded-full text-sm font-bold">‚úì VERIFIED</span>';
            } else if (card.card_status === 'VOID') {
                statusBadge.innerHTML = '<span class="inline-block px-4 py-2 bg-gray-500 text-white rounded-full text-sm font-bold">‚úó VOID</span>';
            } else if (card.completed) {
                statusBadge.innerHTML = '<span class="inline-block px-4 py-2 bg-primary text-white rounded-full text-sm font-bold">COMPLETED</span>';
            } else {
                statusBadge.innerHTML = '<span class="inline-block px-4 py-2 bg-warning text-white rounded-full text-sm font-bold">PENDING</span>';
            }
            
            // Lock Controls (Coach only)
            if (isCoach) {
                document.getElementById('lock-controls').classList.remove('hidden');
                if (isLocked) {
                    document.getElementById('unlock-btn').classList.remove('hidden');
                    document.getElementById('lock-btn').classList.add('hidden');
                    document.getElementById('edit-reason').classList.add('hidden');
                } else {
                    document.getElementById('unlock-btn').classList.add('hidden');
                    document.getElementById('lock-btn').classList.remove('hidden');
                    document.getElementById('edit-reason').classList.remove('hidden');
                }
            }
            
            // Render Scorecard Table
            renderScorecardTable();
            
            // Render Verification History
            renderVerificationHistory();
            
            // Calculate and display totals
            calculateTotals();
        }
        
        function renderScorecardTable() {
            const card = currentScorecard;
            const totalEnds = card.total_ends || 10;
            const scores = card.scores || [];
            
            let html = `
                <thead class="bg-gray-700 dark:bg-gray-600 text-white">
                    <tr>
                        <th class="px-3 py-2 text-center font-bold">End</th>
                        <th class="px-3 py-2 text-center font-bold">A1</th>
                        <th class="px-3 py-2 text-center font-bold">A2</th>
                        <th class="px-3 py-2 text-center font-bold">A3</th>
                        <th class="px-3 py-2 text-center font-bold">End Total</th>
                        <th class="px-3 py-2 text-center font-bold">Running</th>
                    </tr>
                </thead>
                <tbody class="text-gray-800 dark:text-gray-200">
            `;
            
            let runningTotal = 0;
            for (let i = 0; i < totalEnds; i++) {
                const end = scores[i] || { arrows: [null, null, null] };
                const arrows = end.arrows || [null, null, null];
                
                const a1 = arrows[0];
                const a2 = arrows[1];
                const a3 = arrows[2];
                
                const endTotal = parseScore(a1) + parseScore(a2) + parseScore(a3);
                runningTotal += endTotal;
                
                html += `
                    <tr class="border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">
                        <td class="px-3 py-2 text-center font-bold">${i + 1}</td>
                        <td class="px-3 py-2">
                            <div class="score-cell ${isLocked ? 'locked' : ''} ${getScoreClass(a1)}" 
                                 onclick="editScore(${i}, 0)">
                                ${formatScore(a1)}
                            </div>
                        </td>
                        <td class="px-3 py-2">
                            <div class="score-cell ${isLocked ? 'locked' : ''} ${getScoreClass(a2)}" 
                                 onclick="editScore(${i}, 1)">
                                ${formatScore(a2)}
                            </div>
                        </td>
                        <td class="px-3 py-2">
                            <div class="score-cell ${isLocked ? 'locked' : ''} ${getScoreClass(a3)}" 
                                 onclick="editScore(${i}, 2)">
                                ${formatScore(a3)}
                            </div>
                        </td>
                        <td class="px-3 py-2 text-center font-bold text-lg">${endTotal}</td>
                        <td class="px-3 py-2 text-center font-bold text-lg text-primary">${runningTotal}</td>
                    </tr>
                `;
            }
            
            html += '</tbody>';
            document.getElementById('scorecard-table').innerHTML = html;
        }
        
        function parseScore(score) {
            if (score === null || score === '' || score === undefined) return 0;
            const upper = String(score).toUpperCase();
            if (upper === 'X') return 10;
            if (upper === 'M') return 0;
            const num = parseInt(score, 10);
            return isNaN(num) ? 0 : num;
        }
        
        function formatScore(score) {
            if (score === null || score === '' || score === undefined) return '-';
            return String(score).toUpperCase();
        }
        
        function getScoreClass(score) {
            if (score === null || score === '' || score === undefined) return 'score-empty';
            const upper = String(score).toUpperCase();
            return `score-${upper}`;
        }
        
        function editScore(endIndex, arrowIndex) {
            if (isLocked) {
                alert('üîí Scorecard is locked. Unlock it first to make changes.');
                return;
            }
            
            currentEndIndex = endIndex;
            currentArrowIndex = arrowIndex;
            
            document.getElementById('modal-end').textContent = endIndex + 1;
            document.getElementById('modal-arrow').textContent = arrowIndex + 1;
            document.getElementById('score-modal').classList.remove('hidden');
        }
        
        function setScore(value) {
            if (!currentScorecard.scores) currentScorecard.scores = [];
            if (!currentScorecard.scores[currentEndIndex]) {
                currentScorecard.scores[currentEndIndex] = { arrows: [null, null, null] };
            }
            
            currentScorecard.scores[currentEndIndex].arrows[currentArrowIndex] = value;
            
            closeScoreModal();
            renderScorecardTable();
            calculateTotals();
        }
        
        function clearScore() {
            setScore(null);
        }
        
        function closeScoreModal() {
            document.getElementById('score-modal').classList.add('hidden');
            currentEndIndex = null;
            currentArrowIndex = null;
        }
        
        function calculateTotals() {
            const scores = currentScorecard.scores || [];
            let totalScore = 0;
            let xCount = 0;
            let tenCount = 0;
            let arrowCount = 0;
            
            scores.forEach(end => {
                if (!end || !end.arrows) return;
                end.arrows.forEach(arrow => {
                    if (arrow === null || arrow === '' || arrow === undefined) return;
                    const upper = String(arrow).toUpperCase();
                    if (upper === 'X') {
                        xCount++;
                        totalScore += 10;
                        arrowCount++;
                    } else if (upper === '10') {
                        tenCount++;
                        totalScore += 10;
                        arrowCount++;
                    } else if (upper !== 'M') {
                        totalScore += parseScore(arrow);
                        arrowCount++;
                    } else {
                        arrowCount++;
                    }
                });
            });
            
            const avgArrow = arrowCount > 0 ? (totalScore / arrowCount).toFixed(2) : '0.00';
            
            document.getElementById('total-score').textContent = totalScore;
            document.getElementById('x-count').textContent = xCount;
            document.getElementById('ten-count').textContent = tenCount;
            document.getElementById('avg-arrow').textContent = avgArrow;
        }
        
        function renderVerificationHistory() {
            const history = currentScorecard.lock_history || [];
            const historyDiv = document.getElementById('verification-history');
            
            if (history.length === 0) {
                historyDiv.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400">No verification history</p>';
                return;
            }
            
            let html = '';
            history.forEach((entry, index) => {
                const date = new Date(entry.timestamp).toLocaleString();
                const action = entry.action.toUpperCase();
                const icon = action === 'LOCK' ? 'üîí' : action === 'UNLOCK' ? 'üîì' : '‚úó';
                const color = action === 'LOCK' ? 'text-success' : action === 'UNLOCK' ? 'text-warning' : 'text-gray-500';
                
                html += `
                    <div class="flex items-start gap-3 p-3 bg-gray-50 dark:bg-gray-700 rounded">
                        <span class="text-2xl">${icon}</span>
                        <div class="flex-1">
                            <div class="font-semibold ${color}">${action}</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">
                                ${date} ‚Ä¢ ${entry.actor || 'Unknown'}
                            </div>
                            ${entry.notes ? `<div class="text-sm mt-1">${entry.notes}</div>` : ''}
                        </div>
                    </div>
                `;
            });
            
            historyDiv.innerHTML = html;
        }
        
        // Unlock button handler
        document.getElementById('unlock-btn').addEventListener('click', async () => {
            if (!confirm('Unlock this scorecard for editing?\n\nThis action will be logged in the verification history.')) {
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/round_archers/${roundArcherId}/verify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'unlock',
                        notes: 'Unlocked for score corrections'
                    })
                });
                
                if (!res.ok) throw new Error('Failed to unlock scorecard');
                
                isLocked = false;
                await loadScorecard();
                alert('‚úì Scorecard unlocked. You can now edit scores.');
            } catch (error) {
                console.error('[unlock] Error:', error);
                alert('Failed to unlock scorecard: ' + error.message);
            }
        });
        
        // Lock button handler
        document.getElementById('lock-btn').addEventListener('click', async () => {
            const reason = document.getElementById('edit-reason').value.trim();
            if (!reason) {
                alert('Please provide a reason for the edit.');
                return;
            }
            
            if (!confirm('Lock and save changes?\n\nThis will verify the scorecard with the updated scores.')) {
                return;
            }
            
            try {
                // First, save the scores
                const saveRes = await fetch(`${API_BASE}/round_archers/${roundArcherId}/scores`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        scores: currentScorecard.scores
                    })
                });
                
                if (!saveRes.ok) throw new Error('Failed to save scores');
                
                // Then lock it
                const lockRes = await fetch(`${API_BASE}/round_archers/${roundArcherId}/verify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'lock',
                        notes: `Score correction: ${reason}`
                    })
                });
                
                if (!lockRes.ok) throw new Error('Failed to lock scorecard');
                
                isLocked = true;
                await loadScorecard();
                alert('‚úì Scorecard locked and saved.');
            } catch (error) {
                console.error('[lock] Error:', error);
                alert('Failed to save and lock scorecard: ' + error.message);
            }
        });
        
        function showError(message) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('error').classList.remove('hidden');
            document.getElementById('error-message').textContent = message;
        }
    </script>
</body>
</html>

