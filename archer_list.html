<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Archer List</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
    <link rel="stylesheet" href="css/tailwind-compiled.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    <style>
        /* Legacy archer row styling - kept for backward compatibility */
        /* TODO: Convert to pure Tailwind classes in renderList() function */
        .archer-select-row {
            display: flex;
            align-items: center;
            padding: 0.8rem 0.4rem;
            border-bottom: 1px solid #f0f2f5;
            cursor: pointer;
            background-color: white;
            transition: background-color 0.2s;
        }

        .dark .archer-select-row {
            border-bottom: 1px solid #374151;
            background-color: #1f2937;
        }

        .archer-select-row:hover {
            background-color: #f8f9fa;
        }

        .dark .archer-select-row:hover {
            background-color: #374151;
        }

        /* Highlight "Me" record - override default styles */
        .archer-select-row.bg-blue-50 {
            background-color: #eff6ff !important;
        }

        .dark .archer-select-row.bg-blue-900\/20 {
            background-color: rgba(30, 58, 138, 0.2) !important;
        }

        .archer-select-row.bg-blue-50:hover {
            background-color: #dbeafe !important;
        }

        .dark .archer-select-row.bg-blue-900\/20:hover {
            background-color: rgba(30, 58, 138, 0.3) !important;
        }

        .archer-name-label {
            font-size: 1.1em;
            font-weight: 500;
            color: #1f2937;
        }

        .dark .archer-name-label {
            color: #f9fafb;
        }

        .archer-details-label {
            font-size: 0.9em;
            color: #6c757d;
        }

        .dark .archer-details-label {
            color: #9ca3af;
        }

        .favorite-star {
            font-size: 1.4em;
            margin-right: 0.8rem;
            min-width: 1.2em;
            text-align: center;
            cursor: pointer;
        }

        /* Success feedback animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translate(-50%, -10px);
            }

            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translate(-50%, 0);
            }

            to {
                opacity: 0;
                transform: translate(-50%, -10px);
            }
        }
    </style>
</head>

<body class="bg-gray-50 dark:bg-gray-900 min-h-screen transition-colors duration-200">
    <div id="app-container" class="flex flex-col min-h-screen">

        <header
            class="px-4 py-3 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 transition-colors duration-200 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800 dark:text-white">Archer List</h1>
        </header>

        <div
            class="px-4 py-3 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 flex gap-2 transition-colors duration-200">
            <div
                class="flex-1 flex items-center border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 focus-within:ring-2 focus-within:ring-primary transition-colors">
                <input
                    class="flex-1 px-3 py-2 bg-transparent text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none border-none"
                    type="text" id="search-input" placeholder="Find an Archer">
                <button id="clear-search-btn"
                    class="px-3 py-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors hidden"
                    type="button" title="Clear search" aria-label="Clear search">
                    <i class="fas fa-times-circle"></i>
                </button>
            </div>
            <button id="add-archer-btn"
                class="px-4 py-2 bg-primary hover:bg-primary-dark text-white rounded font-semibold transition-colors min-h-[44px]"><i
                    class="fas fa-plus"></i> Add</button>
        </div>

        <div
            class="px-4 py-2 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 flex gap-2 flex-wrap transition-colors duration-200">
            <button id="sort-by-name-btn"
                class="px-4 py-2 bg-gray-400 dark:bg-gray-600 text-white rounded font-semibold hover:bg-gray-500 dark:hover:bg-gray-500 transition-colors min-h-[44px] flex items-center gap-1">
                <i class="fas fa-sort text-lg"></i>
                <span>A-Z</span>
            </button>
            <button id="gender-filter-btn"
                class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors min-h-[44px] min-w-[44px] flex items-center justify-center"
                title="Filter by Gender">
                <i class="fas fa-venus-mars text-lg"></i>
            </button>
            <select id="level-filter"
                class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors min-w-[100px] min-h-[44px] cursor-pointer">
                <option value="all">All</option>
                <option value="VAR">VAR</option>
                <option value="JV">JV</option>
            </select>
            <button id="show-favorites-btn"
                class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors min-h-[44px] flex items-center justify-center">
                <i class="fas fa-heart text-red-500 text-lg"></i>
            </button>
            <select id="school-filter"
                class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors min-w-[120px] min-h-[44px] cursor-pointer">
                <option value="all">All Schools</option>
            </select>
            <select id="status-filter"
                class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors min-w-[140px] min-h-[44px] cursor-pointer">
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
                <option value="all">All</option>
            </select>
            <button id="shirt-sizes-btn"
                class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors min-h-[44px] min-w-[44px] flex items-center justify-center"
                title="Shirt Sizes">
                <i class="fas fa-tshirt text-lg"></i>
            </button>
        </div>

        <div id="archer-list-container"
            class="flex-1 px-2 pb-[calc(84px+env(safe-area-inset-bottom)+24px)] overflow-y-auto bg-white dark:bg-gray-800 transition-colors duration-200">
            <!-- Archer list will be rendered here -->
        </div>

        <footer
            class="fixed bottom-0 left-0 right-0 h-[48px] bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 shadow-lg transition-colors duration-200 z-30 safe-area-bottom">
            <div class="flex items-center h-full px-4 gap-2">
                <a href="index.html"
                    class="min-w-[48px] h-[48px] text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white active:bg-gray-100 dark:active:bg-gray-700 rounded-lg transition-colors flex items-center justify-center"
                    aria-label="Home">
                    <i class="fas fa-home text-2xl"></i>
                </a>
                <!-- Keep coach actions near Home so it doesn't get pushed off-screen on small widths -->
                <button id="coach-actions-btn"
                    class="hidden px-4 py-2 bg-orange text-white rounded hover:bg-orange-dark min-w-[44px] min-h-[44px] font-semibold transition-colors flex items-center justify-center"
                    title="Coach Actions">
                    <i class="fas fa-user-shield mr-1"></i>
                    <span class="hidden sm:inline">Coach</span>
                </button>
                <div class="flex-1"></div>
                <button id="load-from-mysql-btn"
                    class="px-3 h-[44px] bg-primary hover:bg-primary-dark text-white rounded font-semibold transition-colors flex items-center justify-center"
                    aria-label="Refresh from server">
                    <i class="fas fa-sync-alt mr-1"></i><span class="hidden sm:inline">Refresh</span>
                </button>
            </div>
        </footer>

    </div>

    <!-- Sync Status Bar (above footer) - MUST be outside flex container for fixed positioning to work -->
    <div id="sync-status-bar"
        class="fixed bottom-[calc(48px+env(safe-area-inset-bottom))] left-0 right-0 px-4 py-1 text-xs text-gray-600 dark:text-gray-400 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 z-20"
        style="position: fixed !important; bottom: calc(48px + env(safe-area-inset-bottom)) !important;">
        <div id="sync-status"></div>
    </div>

    <!-- Coach Actions Modal (Coach-only) -->
    <div id="coach-actions-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-[60] hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full transition-colors duration-200">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-white flex items-center gap-2">
                    <i class="fas fa-user-shield text-primary"></i>
                    Coach Actions
                </h3>
            </div>
            <div class="px-6 py-4 flex flex-col gap-3">
                <button id="coach-action-import-usa-btn"
                    class="w-full px-4 py-2 bg-orange text-white rounded hover:bg-orange-dark min-h-[44px] font-semibold transition-colors flex items-center justify-center gap-2">
                    <i class="fas fa-upload"></i>
                    <span>Import USA Archery CSV</span>
                </button>
                <button id="coach-action-export-usa-btn"
                    class="w-full px-4 py-2 bg-orange text-white rounded hover:bg-orange-dark min-h-[44px] font-semibold transition-colors flex items-center justify-center gap-2">
                    <i class="fas fa-download"></i>
                    <span>Export USA Archery CSV</span>
                </button>
                <button id="coach-action-export-roster-btn"
                    class="w-full px-4 py-2 bg-warning text-gray-800 rounded hover:bg-warning-dark min-h-[44px] font-semibold transition-colors flex items-center justify-center gap-2">
                    <i class="fas fa-file-csv"></i>
                    <span>Export Coach Roster CSV</span>
                </button>
                <button id="coach-action-export-roster-simple-btn"
                    class="w-full px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 min-h-[44px] font-semibold transition-colors flex items-center justify-center gap-2">
                    <i class="fas fa-file-export"></i>
                    <span>Export Coach Roster Simple</span>
                </button>
                <button id="coach-action-export-shirt-order-btn"
                    class="w-full px-4 py-2 bg-primary text-white rounded hover:bg-primary-dark min-h-[44px] font-semibold transition-colors flex items-center justify-center gap-2">
                    <i class="fas fa-tshirt"></i>
                    <span>Export Shirt Order</span>
                </button>
                <button id="coach-action-delete-found-btn"
                    class="w-full px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 min-h-[44px] font-semibold transition-colors flex items-center justify-center gap-2">
                    <i class="fas fa-trash-alt"></i>
                    <span id="coach-action-delete-found-text">Delete Found Set</span>
                </button>
            </div>
            <div class="flex gap-3 px-6 py-4 border-t border-gray-200 dark:border-gray-700">
                <button id="close-coach-actions-btn"
                    class="flex-1 px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors min-h-[44px]">Close</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Archer Modal -->
    <div id="archer-modal"
        class="fixed inset-0 bg-black/60 flex items-start justify-center z-50 hidden p-0 pt-[48px] overscroll-none">
        <div class="bg-white dark:bg-gray-800 rounded-t-2xl shadow-2xl w-full h-[calc(100vh-48px)] flex flex-col transition-all duration-300 transform"
            style="max-height: calc(100vh - 48px);">
            <!-- Compact Header with Avatar Preview -->
            <div
                class="flex-shrink-0 bg-gradient-to-r from-primary to-primary-dark px-4 py-3 rounded-t-2xl sm:rounded-t-lg">
                <div class="flex items-center gap-3">
                    <!-- Avatar in Header (larger to match form) -->
                    <div id="header-avatar"
                        class="w-16 h-16 rounded-full bg-white/20 flex items-center justify-center overflow-hidden border-2 border-white/40 flex-shrink-0">
                        <span id="header-initials" class="text-xl font-bold text-white">?</span>
                        <img id="header-avatar-img" class="hidden w-full h-full object-cover" alt="">
                    </div>
                    <div class="flex-1 min-w-0">
                        <h2 id="modal-title" class="text-lg font-bold text-white truncate">Add Archer</h2>
                        <div id="archer-navigation" class="hidden items-center gap-1 mt-0.5">
                            <button type="button" id="prev-archer-btn"
                                class="w-6 h-6 flex items-center justify-center text-white hover:text-white hover:bg-white/30 rounded transition-colors border border-white/30"
                                title="Previous">
                                <i class="fas fa-chevron-left text-xs"></i>
                            </button>
                            <span id="archer-position" class="text-xs text-white px-1">1/25</span>
                            <button type="button" id="next-archer-btn"
                                class="w-6 h-6 flex items-center justify-center text-white hover:text-white hover:bg-white/30 rounded transition-colors border border-white/30"
                                title="Next">
                                <i class="fas fa-chevron-right text-xs"></i>
                            </button>
                        </div>
                    </div>
                    <button type="button" id="close-modal-btn"
                        class="w-8 h-8 flex items-center justify-center text-white/80 hover:text-white hover:bg-white/20 rounded-full transition-colors"
                        title="Close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <!-- Scrollable Form Content -->
            <form id="archer-form" class="flex-1 overflow-y-auto min-h-0 overscroll-contain"
                style="-webkit-overflow-scrolling: touch; touch-action: pan-y; will-change: scroll-position;">
                <!-- Form content will be injected by JS -->
            </form>
            <!-- Fixed Button Container (outside scrollable area) -->
            <div id="archer-form-buttons"
                class="flex-shrink-0 px-3 py-3 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 flex gap-2 safe-area-bottom">
                <button type="button" id="cancel-archer-btn-fixed"
                    class="flex-1 px-4 py-2.5 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg font-semibold hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors min-h-[44px]">Cancel</button>
                <button type="submit" form="archer-form"
                    class="flex-1 px-4 py-2.5 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold transition-colors min-h-[44px] shadow-sm">
                    <i class="fas fa-check mr-1"></i>Save
                </button>
            </div>
        </div>
    </div>

    <!-- Warning Modal for Changing "You" Setting -->
    <div id="change-self-warning-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[70] hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full transition-colors duration-200">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-white flex items-center gap-2">
                    <i class="fas fa-exclamation-triangle text-yellow-500"></i>
                    Change "Who am I"?
                </h3>
            </div>
            <div class="px-6 py-4">
                <p class="text-gray-700 dark:text-gray-300 mb-4">
                    You already have yourself set as <strong id="current-self-name"
                        class="text-gray-900 dark:text-white"></strong>.
                </p>
                <p class="text-gray-700 dark:text-gray-300 mb-4">
                    Are you sure you want to change this to a different archer?
                </p>
            </div>
            <div class="flex gap-3 px-6 py-4 border-t border-gray-200 dark:border-gray-700">
                <button id="cancel-change-self-btn"
                    class="flex-1 px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors min-h-[44px]">Cancel</button>
                <button id="confirm-change-self-btn"
                    class="flex-1 px-4 py-2 bg-primary hover:bg-primary-dark text-white rounded font-semibold transition-colors min-h-[44px]">Yes,
                    Change It</button>
            </div>
        </div>
    </div>

    <!-- No "Me" Record Modal -->
    <div id="no-me-record-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[80] hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full transition-colors duration-200">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-white flex items-center gap-2">
                    <i class="fas fa-user-circle text-primary"></i>
                    Select Your Profile
                </h3>
            </div>
            <div class="px-6 py-4">
                <p class="text-gray-700 dark:text-gray-300 mb-4">
                    Click the <i class="fas fa-plus text-primary"></i> on the avatar to select your profile.
                </p>
            </div>
            <div class="flex gap-3 px-6 py-4 border-t border-gray-200 dark:border-gray-700">
                <button id="close-no-me-modal-btn"
                    class="flex-1 px-4 py-2 bg-primary hover:bg-primary-dark text-white rounded font-semibold transition-colors min-h-[44px]">OK</button>
            </div>
        </div>
    </div>

    <!-- Nickname Entry Modal -->
    <div id="nickname-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-[70] hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full transition-colors duration-200">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-white flex items-center gap-2">
                    <i class="fas fa-user-edit text-primary"></i>
                    Nickname
                </h3>
            </div>
            <div class="px-6 py-4">
                <input type="text" id="nickname-modal-input"
                    class="w-full px-4 py-2 text-base border border-gray-200 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary"
                    placeholder="Enter nickname">
            </div>
            <div class="flex gap-3 px-6 py-4 border-t border-gray-200 dark:border-gray-700">
                <button id="nickname-modal-cancel"
                    class="flex-1 px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors min-h-[44px] flex items-center justify-center">
                    <i class="fas fa-times mr-2"></i>Cancel
                </button>
                <button id="nickname-modal-save"
                    class="flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 dark:bg-green-500 dark:hover:bg-green-600 text-white rounded font-semibold transition-colors min-h-[44px] flex items-center justify-center">
                    <i class="fas fa-check mr-2"></i>Save
                </button>
            </div>
        </div>
    </div>

    <!-- Image Crop Modal -->
    <div id="crop-modal"
        class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center p-4 z-[60] hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full transition-colors duration-200">
            <div class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-6 py-4">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-white">Crop Photo</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Adjust the crop area to focus on the face</p>
            </div>
            <div class="p-6">
                <div class="max-h-[60vh] overflow-hidden bg-gray-100 dark:bg-gray-900 rounded">
                    <img id="crop-image" src="" alt="Crop preview" class="max-w-full">
                </div>
            </div>
            <div class="flex gap-3 px-6 py-4 border-t border-gray-200 dark:border-gray-700">
                <button type="button" id="cancel-crop-btn"
                    class="flex-1 px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors min-h-[44px]">Cancel</button>
                <button type="button" id="apply-crop-btn"
                    class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white rounded font-semibold transition-colors min-h-[44px]">
                    <i class="fas fa-crop mr-2"></i>Crop & Upload
                </button>
            </div>
        </div>
    </div>

    <script src="js/common.js"></script>
    <script src="js/live_updates.js"></script>
    <script src="js/archer_module.js"></script>
    <script>
        // Initialize dark mode immediately (before DOMContentLoaded) to prevent flash
        // Dark mode preference is set from the home screen (index.html)
        initDarkMode();

        document.addEventListener('DOMContentLoaded', () => {
            const SCHOOL_EMAIL_DOMAIN = '@student.davincischools.org';
            const modal = document.getElementById('archer-modal');
            const addArcherBtn = document.getElementById('add-archer-btn');
            const searchInput = document.getElementById('search-input');
            const statusFilter = document.getElementById('status-filter');
            const schoolFilter = document.getElementById('school-filter');
            const levelFilter = document.getElementById('level-filter');
            const loadFromMySQLBtn = document.getElementById('load-from-mysql-btn');
            const sortByNameBtn = document.getElementById('sort-by-name-btn');

            // Track unsaved changes
            let originalFormState = null;
            let hasUnsavedChanges = false;
            let beforeUnloadHandler = null;
            const showFavoritesBtn = document.getElementById('show-favorites-btn');
            const genderFilterBtn = document.getElementById('gender-filter-btn');
            const shirtSizesBtn = document.getElementById('shirt-sizes-btn');
            let editingIndex = null;
            let showFavoritesOnly = false; // Filter to show only favorites
            let genderFilterValue = 'all'; // 'all', 'M', or 'F'
            let viewMode = 'list'; // 'list' or 'shirtSizes'
            let lastSyncMessage = '';
            let filteredArcherIndices = []; // For navigation

            /**
             * Populate the school filter dropdown with unique school codes from the archer list.
             * @returns {void}
             */
            function populateSchoolFilter() {
                const state = getRosterState();
                const { list } = state;

                // Get unique school codes, sorted alphabetically
                const uniqueSchools = [...new Set(
                    list
                        .map(archer => (archer.school || '').trim().toUpperCase())
                        .filter(school => school !== '')
                )].sort();

                // Clear existing options except "All Schools"
                schoolFilter.innerHTML = '<option value="all">All Schools</option>';

                // Add each unique school as an option
                uniqueSchools.forEach(school => {
                    const option = document.createElement('option');
                    option.value = school;
                    option.textContent = school;
                    schoolFilter.appendChild(option);
                });
            }

            /**
             * Get the currently filtered/found set of archers based on active filters.
             * This applies the same filtering logic used in renderList() and renderShirtSizesList().
             * 
             * @returns {Object[]} Array of filtered archer objects
             */
            function getFilteredArchers() {
                const state = getRosterState();
                const { list, selfExtId, friendSet } = state;
                const filter = searchInput.value.toLowerCase();
                const statusValue = statusFilter.value;
                const schoolValue = schoolFilter.value;
                const levelValue = levelFilter.value;

                let items = list.map((archer, index) => ({ archer, index }));

                // Apply status filter
                if (statusValue !== 'all') {
                    items = items.filter(item => (item.archer.status || 'active').toLowerCase() === statusValue);
                }

                // Apply school filter
                if (schoolValue !== 'all') {
                    items = items.filter(item =>
                        (item.archer.school || '').trim().toUpperCase() === schoolValue.toUpperCase()
                    );
                }

                // Apply level filter
                if (levelValue !== 'all') {
                    items = items.filter(item =>
                        (item.archer.level || 'VAR').toUpperCase() === levelValue.toUpperCase()
                    );
                }

                // Apply gender filter
                if (genderFilterValue !== 'all') {
                    items = items.filter(item =>
                        (item.archer.gender || 'M').toUpperCase() === genderFilterValue.toUpperCase()
                    );
                }

                // Apply search filter
                if (filter) {
                    items = items.filter(({ archer }) =>
                        `${archer.first} ${archer.last}`.toLowerCase().includes(filter) ||
                        (archer.nickname || '').toLowerCase().includes(filter) ||
                        (archer.school || '').toLowerCase().includes(filter)
                    );
                }

                // Apply favorites filter
                if (showFavoritesOnly) {
                    items = items.filter(({ archer }) =>
                        friendSet.has(archer.extId) || (selfExtId && archer.extId === selfExtId)
                    );
                }

                // Apply same sorting as renderList() - sort by first name ascending
                items.sort((a, b) => {
                    const priority = (item) => {
                        if (selfExtId && item.archer.extId === selfExtId) return 0;
                        if (friendSet.has(item.archer.extId)) return 1;
                        return 2;
                    };
                    const aP = priority(a);
                    const bP = priority(b);
                    if (aP !== bP) return aP - bP;

                    // Sort by first name ascending
                    const firstNameA = (a.archer.first || '').toLowerCase();
                    const firstNameB = (b.archer.first || '').toLowerCase();
                    return firstNameA.localeCompare(firstNameB);
                });

                // Return just the archer objects (not the {archer, index} structure)
                return items.map(item => item.archer);
            }

            /**
             * Check if current user is in coach mode.
             *
             * Coach auth can be present in multiple places depending on the page/flow:
             * - `live_updates_config.apiKey` (Live Updates config)
             * - `coach_api_key` or `coach_passcode` (localStorage)
             * - `coach_auth=true` cookie (coach console sets this)
             *
             * @returns {boolean}
             */
            function isCoachMode() {
                try {
                    const configRaw = localStorage.getItem('live_updates_config') || '{}';
                    const config = JSON.parse(configRaw);

                    const hasConfigApiKey = !!(config && config.apiKey && String(config.apiKey).trim());
                    const hasCoachApiKey = !!(localStorage.getItem('coach_api_key') || '').trim();
                    const hasCoachPasscode = !!(localStorage.getItem('coach_passcode') || '').trim();
                    const coachAuthCookie = (typeof getCookie === 'function') ? getCookie('coach_auth') : null;
                    const hasCoachCookie = coachAuthCookie === 'true';

                    const isCoach = hasConfigApiKey || hasCoachApiKey || hasCoachPasscode || hasCoachCookie;

                    console.log('[Coach Mode Check]', {
                        hasConfigApiKey,
                        hasCoachApiKey,
                        hasCoachPasscode,
                        hasCoachCookie,
                        isCoach
                    });
                    return isCoach;
                } catch (e) {
                    console.error('[Coach Mode Check Error]', e);
                    return false;
                }
            }

            function formatTimestamp(ts) {
                if (!ts) return 'Never';
                try {
                    const date = new Date(ts);
                    if (Number.isNaN(date.getTime())) return 'Never';
                    return `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
                } catch {
                    return 'Never';
                }
            }

            function updateSyncStatus(extraMessage) {
                const statusEl = document.getElementById('sync-status');
                if (!statusEl) return;
                const meta = (typeof ArcherModule.getMeta === 'function') ? ArcherModule.getMeta() : {};
                const pending = (typeof ArcherModule.getPendingCount === 'function') ? ArcherModule.getPendingCount() : 0;
                const parts = [];
                if (meta.lastSyncedAt) parts.push(`Last sync: ${formatTimestamp(meta.lastSyncedAt)}`);
                if (meta.lastFetchedAt) parts.push(`Last download: ${formatTimestamp(meta.lastFetchedAt)}`);
                parts.push(pending ? `${pending} change${pending === 1 ? '' : 's'} pending` : 'All changes synced');
                if (lastSyncMessage) parts.push(lastSyncMessage);
                if (extraMessage) parts.push(extraMessage);
                statusEl.textContent = parts.join(' • ');
            }

            function recordSyncMessage(summary, actionLabel) {
                if (!summary) {
                    lastSyncMessage = '';
                    updateSyncStatus();
                    return;
                }
                if (summary.ok) {
                    if (summary.processed > 0 && summary.pending === 0) {
                        lastSyncMessage = `${actionLabel} synced`;
                    } else if (summary.pending > 0) {
                        lastSyncMessage = 'Changes queued (offline)';
                    } else {
                        lastSyncMessage = '';
                    }
                } else {
                    lastSyncMessage = 'Offline – will retry automatically';
                }
                updateSyncStatus();
            }

            function getRosterState() {
                const list = ArcherModule.loadList();
                // Use getSelfArcher() which has the correct matching logic (extId, id, or built extId)
                const selfArcher = (typeof ArcherModule.getSelfArcher === 'function')
                    ? ArcherModule.getSelfArcher()
                    : null;
                const selfExtId = selfArcher ? (selfArcher.extId || ArcherModule.getSelfExtId() || '') : '';
                const friendSet = new Set((selfArcher?.faves || []).filter(Boolean));
                return { list, selfExtId, selfArcher, friendSet };
            }

            function renderList(stateOverride) {
                if (stateOverride && stateOverride.target) {
                    stateOverride = null;
                }
                const container = document.getElementById('archer-list-container');

                // Check view mode and render accordingly
                if (viewMode === 'shirtSizes') {
                    renderShirtSizesList(stateOverride);
                    return;
                }

                const filter = searchInput.value.toLowerCase();
                container.innerHTML = '';

                const state = stateOverride || getRosterState();
                const { list, selfExtId, friendSet } = state;

                let items = list.map((archer, index) => ({ archer, index }));

                const statusValue = statusFilter.value;
                if (statusValue !== 'all') {
                    items = items.filter(item => (item.archer.status || 'active').toLowerCase() === statusValue);
                }

                const schoolValue = schoolFilter.value;
                if (schoolValue !== 'all') {
                    items = items.filter(item =>
                        (item.archer.school || '').trim().toUpperCase() === schoolValue.toUpperCase()
                    );
                }

                const levelValue = levelFilter.value;
                if (levelValue !== 'all') {
                    items = items.filter(item =>
                        (item.archer.level || 'VAR').toUpperCase() === levelValue.toUpperCase()
                    );
                }

                if (genderFilterValue !== 'all') {
                    items = items.filter(item =>
                        (item.archer.gender || 'M').toUpperCase() === genderFilterValue.toUpperCase()
                    );
                }

                if (filter) {
                    items = items.filter(({ archer }) =>
                        `${archer.first} ${archer.last}`.toLowerCase().includes(filter) ||
                        (archer.nickname || '').toLowerCase().includes(filter) ||
                        (archer.school || '').toLowerCase().includes(filter)
                    );
                }

                // Filter to show only favorites if filter is active (includes "Me" record)
                if (showFavoritesOnly) {
                    items = items.filter(({ archer }) =>
                        friendSet.has(archer.extId) || (selfExtId && archer.extId === selfExtId)
                    );
                }

                // Sort by first name ascending
                items.sort((a, b) => {
                    const priority = (item) => {
                        if (selfExtId && item.archer.extId === selfExtId) return 0;
                        if (friendSet.has(item.archer.extId)) return 1;
                        return 2;
                    };
                    const aP = priority(a);
                    const bP = priority(b);
                    if (aP !== bP) return aP - bP;

                    // Sort by first name ascending
                    const firstNameA = (a.archer.first || '').toLowerCase();
                    const firstNameB = (b.archer.first || '').toLowerCase();
                    return firstNameA.localeCompare(firstNameB);
                });

                if (items.length === 0) {
                    container.innerHTML = '<p style="text-align:center; padding: 20px; color: #6c757d;">No archers found.</p>';
                    return;
                }

                // Store filtered indices for navigation
                filteredArcherIndices = items.map(item => item.index);

                items.forEach(({ archer, index }) => {
                    const row = document.createElement('div');
                    const isSelf = !!selfExtId && archer.extId === selfExtId;
                    // Highlight "Me" record with distinct styling
                    if (isSelf) {
                        row.className = 'archer-select-row bg-blue-50 dark:bg-blue-900/20 border-l-4 border-l-primary';
                    } else {
                        row.className = 'archer-select-row';
                    }

                    const isFriend = friendSet.has(archer.extId);

                    // Only show plus badges if NO self is selected at all
                    const showPlusBadge = !selfExtId && !isSelf;

                    // Avatar OR Icon (show avatar if photo exists, otherwise show icon)
                    const avatarOrIcon = document.createElement('div');
                    avatarOrIcon.className = 'relative w-10 h-10 rounded-full overflow-hidden flex items-center justify-center mr-3 flex-shrink-0';

                    if (archer.photoUrl) {
                        // Show photo avatar
                        avatarOrIcon.className += ' bg-gray-200 dark:bg-gray-700';
                        const avatarImg = document.createElement('img');
                        avatarImg.src = archer.photoUrl;
                        avatarImg.alt = `${archer.first} ${archer.last}`;
                        avatarImg.className = 'w-full h-full object-cover';
                        avatarOrIcon.appendChild(avatarImg);

                        // Add visual cue badge ONLY when no self is selected at all
                        if (showPlusBadge) {
                            const badge = document.createElement('div');
                            badge.className = 'absolute -top-1 -right-1 w-5 h-5 bg-primary rounded-full flex items-center justify-center shadow-lg border-2 border-white dark:border-gray-800 z-10';
                            badge.innerHTML = '<i class="fas fa-plus text-white text-xs"></i>';
                            badge.title = 'Tap to set as me';
                            avatarOrIcon.appendChild(badge);
                        }

                        // Make it clickable to set as "me"
                        avatarOrIcon.style.cursor = 'pointer';
                        avatarOrIcon.title = isSelf ? 'This is you (tap to clear)' : 'Tap to set as me';
                        avatarOrIcon.classList.add('hover:ring-2', 'hover:ring-primary', 'hover:ring-offset-2', 'transition-all');
                        avatarOrIcon.onclick = async (e) => {
                            e.stopPropagation();
                            if (isSelf) {
                                if (confirm('Clear "Who am I"?')) {
                                    if (typeof ArcherModule.clearSelf === 'function') ArcherModule.clearSelf();
                                    renderList();
                                }
                            } else {
                                await handleSetSelf(archer);
                            }
                        };
                    } else {
                        // Show person icon
                        if (isSelf) {
                            avatarOrIcon.innerHTML = '<i class="fas fa-user-check text-primary dark:text-primary-light" style="font-size: 1.5rem;"></i>';
                            avatarOrIcon.title = 'This is you (tap to clear)';
                            avatarOrIcon.style.cursor = 'pointer';
                            avatarOrIcon.classList.add('hover:ring-2', 'hover:ring-primary', 'hover:ring-offset-2', 'transition-all');
                            avatarOrIcon.onclick = (e) => {
                                e.stopPropagation();
                                if (confirm('Clear "Who am I"?')) {
                                    if (typeof ArcherModule.clearSelf === 'function') ArcherModule.clearSelf();
                                    renderList();
                                }
                            };
                        } else {
                            avatarOrIcon.innerHTML = '<i class="far fa-user text-gray-400 dark:text-gray-500" style="font-size: 1.5rem;"></i>';
                            avatarOrIcon.title = 'Tap to set as me';
                            avatarOrIcon.style.cursor = 'pointer';
                            avatarOrIcon.classList.add('hover:ring-2', 'hover:ring-primary', 'hover:ring-offset-2', 'transition-all');

                            // Add visual cue badge ONLY when no self is selected at all
                            if (showPlusBadge) {
                                const badge = document.createElement('div');
                                badge.className = 'absolute -top-1 -right-1 w-5 h-5 bg-primary rounded-full flex items-center justify-center shadow-lg border-2 border-white dark:border-gray-800 z-10';
                                badge.innerHTML = '<i class="fas fa-plus text-white text-xs"></i>';
                                badge.title = 'Tap to set as me';
                                avatarOrIcon.appendChild(badge);
                            }

                            avatarOrIcon.onclick = async (e) => {
                                e.stopPropagation();
                                await handleSetSelf(archer);
                            };
                        }
                    }

                    const nameDiv = document.createElement('div');
                    nameDiv.style.flexGrow = '1';

                    // Name with inline badges
                    const nameLabel = document.createElement('div');
                    nameLabel.className = 'archer-name-label';
                    nameLabel.style.display = 'flex';
                    nameLabel.style.alignItems = 'center';
                    nameLabel.style.gap = '0.5rem';
                    nameLabel.style.flexWrap = 'wrap';

                    const nameText = document.createElement('span');
                    // Show nickname instead of first name if nickname exists
                    const displayName = archer.nickname ? archer.nickname : archer.first;
                    nameText.textContent = `${displayName} ${archer.last}`;
                    nameLabel.appendChild(nameText);

                    // Add "You" badge inline
                    if (isSelf) {
                        const youBadge = document.createElement('span');
                        youBadge.textContent = 'You';
                        youBadge.style.fontSize = '0.75rem';
                        youBadge.style.color = '#0d6efd';
                        youBadge.style.fontWeight = '600';
                        youBadge.style.padding = '0.1rem 0.4rem';
                        youBadge.style.backgroundColor = 'rgba(13, 110, 253, 0.1)';
                        youBadge.style.borderRadius = '0.25rem';
                        nameLabel.appendChild(youBadge);
                    }

                    // Add Friend heart inline
                    if (isFriend && !isSelf) {
                        const friendHeart = document.createElement('span');
                        friendHeart.innerHTML = '<i class="fas fa-heart" style="color: #e63946; font-size: 0.85rem;"></i>';
                        friendHeart.title = 'Friend';
                        nameLabel.appendChild(friendHeart);
                    }

                    const detailsLabel = document.createElement('div');
                    const statusBadge = (archer.status || 'active').toUpperCase() === 'ACTIVE' ? 'Active' : 'Inactive';

                    // Build details with PR info
                    let detailsText = `${(archer.school || 'N/A').toUpperCase()} • Grade ${archer.grade || '-'} • ${archer.level || 'VAR'} / ${archer.gender || 'M'} • ${statusBadge}`;

                    // Add PR info if available
                    const jvPr = archer.jvPr ? parseInt(archer.jvPr) : null;
                    const varPr = archer.varPr ? parseInt(archer.varPr) : null;
                    if (jvPr || varPr) {
                        const prParts = [];
                        if (jvPr) prParts.push(`JV PR: ${jvPr}`);
                        if (varPr) prParts.push(`VAR PR: ${varPr}`);
                        detailsText += ` • ${prParts.join(' • ')}`;
                    }

                    detailsLabel.textContent = detailsText;
                    detailsLabel.className = 'archer-details-label';

                    nameDiv.appendChild(nameLabel);
                    nameDiv.appendChild(detailsLabel);

                    // Append avatar and name to row
                    row.appendChild(avatarOrIcon);
                    row.appendChild(nameDiv);

                    // Friend toggle button (for non-self archers)
                    const friendToggle = document.createElement('span');
                    if (!isSelf) {
                        friendToggle.className = 'favorite-star';
                        friendToggle.style.marginRight = '0.5rem';
                        friendToggle.innerHTML = isFriend ? '<i class="fas fa-heart" style="color: #e63946;"></i>' : '<i class="far fa-heart" style="color: #ccc;"></i>';
                        friendToggle.title = isFriend ? 'Remove from friends' : 'Add as friend';
                        friendToggle.onclick = async (e) => {
                            e.stopPropagation();
                            if (!selfExtId) {
                                alert('Set "Who am I" first by tapping your avatar or name.');
                                return;
                            }
                            try {
                                const result = await ArcherModule.toggleFriend(archer.extId);
                                recordSyncMessage(result?.sync, 'Friends updated');
                                renderList();
                            } catch (err) {
                                alert('Unable to update friends: ' + err.message);
                            }
                        };
                    }

                    const historyBtn = document.createElement('a');
                    // Use UUID (id) only for history link
                    const archerHistoryId = archer.id;
                    historyBtn.href = `archer_history.html?archer=${encodeURIComponent(archerHistoryId)}`;
                    historyBtn.className = 'ml-2 p-1 text-blue-500 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 transition-colors';
                    historyBtn.innerHTML = '<i class="fas fa-file-alt"></i>';
                    historyBtn.title = 'View archer history';
                    historyBtn.onclick = (e) => {
                        e.stopPropagation();
                    };

                    if (!isSelf) row.appendChild(friendToggle);
                    row.appendChild(historyBtn);

                    // Coach Mode: Delete Button
                    // Check coach mode (standard check + URL override)
                    const params = new URLSearchParams(window.location.search || '');
                    const isCoach = (typeof isCoachMode === 'function' && isCoachMode()) || params.get('showCoachActions') === '1';

                    if (isCoach && !isSelf) {
                        const deleteBtn = document.createElement('div');
                        deleteBtn.className = 'ml-2 p-1 text-gray-400 hover:text-red-600 transition-colors cursor-pointer';
                        deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                        deleteBtn.title = 'Delete archer';
                        deleteBtn.onclick = async (e) => {
                            e.stopPropagation();
                            if (confirm(`Are you sure you want to delete ${archer.first} ${archer.last}?\n\nThis cannot be undone.`)) {
                                try {
                                    const success = await ArcherModule.deleteArcherById(archer.id);
                                    if (success) {
                                        // Visual feedback
                                        row.style.opacity = '0';
                                        setTimeout(() => renderList(), 300);
                                    } else {
                                        alert('Failed to delete archer.');
                                    }
                                } catch (err) {
                                    alert('Error deleting archer: ' + err.message);
                                }
                            }
                        };
                        row.appendChild(deleteBtn);
                    }

                    row.onclick = () => editArcher(index);

                    container.appendChild(row);
                });
                updateSyncStatus();

                // Check and show modal if no "Me" record after render
                checkAndShowNoMeModal();
            }

            /**
             * Render shirt sizes entry list view
             * Shows larger avatars (3 lines high) with name rows and shirt size button grid
             */
            function renderShirtSizesList(stateOverride) {
                const container = document.getElementById('archer-list-container');
                const filter = searchInput.value.toLowerCase();
                container.innerHTML = '';

                const state = stateOverride || getRosterState();
                const { list, selfExtId, friendSet } = state;

                let items = list.map((archer, index) => ({ archer, index }));

                const statusValue = statusFilter.value;
                if (statusValue !== 'all') {
                    items = items.filter(item => (item.archer.status || 'active').toLowerCase() === statusValue);
                }

                const schoolValue = schoolFilter.value;
                if (schoolValue !== 'all') {
                    items = items.filter(item =>
                        (item.archer.school || '').trim().toUpperCase() === schoolValue.toUpperCase()
                    );
                }

                const levelValue = levelFilter.value;
                if (levelValue !== 'all') {
                    items = items.filter(item =>
                        (item.archer.level || 'VAR').toUpperCase() === levelValue.toUpperCase()
                    );
                }

                if (genderFilterValue !== 'all') {
                    items = items.filter(item =>
                        (item.archer.gender || 'M').toUpperCase() === genderFilterValue.toUpperCase()
                    );
                }

                if (filter) {
                    items = items.filter(({ archer }) =>
                        `${archer.first} ${archer.last}`.toLowerCase().includes(filter) ||
                        (archer.nickname || '').toLowerCase().includes(filter) ||
                        (archer.school || '').toLowerCase().includes(filter)
                    );
                }

                if (showFavoritesOnly) {
                    items = items.filter(({ archer }) =>
                        friendSet.has(archer.extId) || (selfExtId && archer.extId === selfExtId)
                    );
                }

                // Sort by first name ascending
                items.sort((a, b) => {
                    const priority = (item) => {
                        if (selfExtId && item.archer.extId === selfExtId) return 0;
                        if (friendSet.has(item.archer.extId)) return 1;
                        return 2;
                    };
                    const aP = priority(a);
                    const bP = priority(b);
                    if (aP !== bP) return aP - bP;

                    // Sort by first name ascending
                    const firstNameA = (a.archer.first || '').toLowerCase();
                    const firstNameB = (b.archer.first || '').toLowerCase();
                    return firstNameA.localeCompare(firstNameB);
                });

                if (items.length === 0) {
                    container.innerHTML = '<p class="text-center py-8 text-gray-600 dark:text-gray-400">No archers found.</p>';
                    return;
                }

                // Shirt size options in the specified grid layout
                const shirtSizes = [
                    ['L', 'XL', '2X', '3X'],  // Row 1
                    ['M'],                     // Row 2
                    ['S', 'XS']               // Row 3
                ];

                items.forEach(({ archer, index }) => {
                    const row = document.createElement('div');
                    row.className = 'px-4 py-3 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 transition-colors';

                    const isSelf = !!selfExtId && archer.extId === selfExtId;
                    if (isSelf) {
                        row.classList.add('bg-blue-50', 'dark:bg-blue-900/20', 'border-l-4', 'border-l-primary');
                    }

                    // Main content container
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'flex items-start gap-3';

                    // Avatar (3 lines high to match name rows with spacing)
                    // Height calculation: 3 rows (32px + 30px + 30px) + 2 gaps (4px each) = ~100px
                    const avatarDiv = document.createElement('div');
                    avatarDiv.className = 'relative flex-shrink-0';
                    avatarDiv.style.width = '60px';
                    avatarDiv.style.height = '100px'; // Matches 3 name rows with spacing

                    if (archer.photoUrl) {
                        avatarDiv.className += ' rounded-full overflow-hidden bg-gray-200 dark:bg-gray-700';
                        const avatarImg = document.createElement('img');
                        avatarImg.src = archer.photoUrl;
                        avatarImg.alt = `${archer.first} ${archer.last}`;
                        avatarImg.className = 'w-full h-full object-cover';
                        avatarDiv.appendChild(avatarImg);
                    } else {
                        avatarDiv.className += ' rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center';
                        const icon = document.createElement('i');
                        icon.className = isSelf
                            ? 'fas fa-user-check text-primary dark:text-primary-light text-3xl'
                            : 'far fa-user text-gray-400 dark:text-gray-500 text-3xl';
                        avatarDiv.appendChild(icon);
                    }

                    // Left side: Name rows (3 lines)
                    const nameContainer = document.createElement('div');
                    nameContainer.className = 'flex flex-col gap-1 flex-1 min-w-0';

                    // Row 1: Nickname field (clickable to open modal)
                    const nicknameRow = document.createElement('div');
                    nicknameRow.className = 'flex items-center gap-2';
                    const nicknameInput = document.createElement('input');
                    nicknameInput.type = 'text';
                    nicknameInput.value = archer.nickname || '';
                    nicknameInput.placeholder = 'Nickname';
                    nicknameInput.className = 'px-2 py-1 text-sm border border-gray-200 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary flex-1 min-h-[32px]';
                    nicknameInput.readOnly = true;
                    nicknameInput.onclick = () => openNicknameModal(archer, index);
                    nicknameRow.appendChild(nicknameInput);
                    nameContainer.appendChild(nicknameRow);

                    // Row 2: First name
                    const firstRow = document.createElement('div');
                    firstRow.className = 'px-2 py-1 text-sm text-gray-700 dark:text-gray-300';
                    firstRow.textContent = archer.first || '';
                    nameContainer.appendChild(firstRow);

                    // Row 3: Last name
                    const lastRow = document.createElement('div');
                    lastRow.className = 'px-2 py-1 text-sm text-gray-700 dark:text-gray-300';
                    lastRow.textContent = archer.last || '';
                    nameContainer.appendChild(lastRow);

                    // Right side: Shirt size button grid
                    const sizeGrid = document.createElement('div');
                    sizeGrid.className = 'flex flex-col gap-1 flex-shrink-0';

                    shirtSizes.forEach((sizeRow, rowIdx) => {
                        const rowDiv = document.createElement('div');
                        rowDiv.className = 'flex gap-1';

                        sizeRow.forEach(size => {
                            const button = document.createElement('button');
                            button.type = 'button';
                            button.textContent = size;
                            const isSelected = archer.shirtSize === size;
                            button.className = `px-3 py-1.5 text-sm font-semibold rounded min-h-[36px] min-w-[44px] transition-colors ${isSelected
                                ? 'bg-primary text-white hover:bg-primary-dark'
                                : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600'
                                }`;

                            button.onclick = async (e) => {
                                e.stopPropagation();
                                await handleShirtSizeSelect(archer, index, size);
                            };

                            rowDiv.appendChild(button);
                        });

                        sizeGrid.appendChild(rowDiv);
                    });

                    // Assemble: Avatar | Names (left) | Sizes (right)
                    contentDiv.appendChild(avatarDiv);
                    contentDiv.appendChild(nameContainer);
                    contentDiv.appendChild(sizeGrid);
                    row.appendChild(contentDiv);
                    container.appendChild(row);
                });

                updateSyncStatus();
            }

            /**
             * Handle shirt size selection - auto-submit/save
             * @param {Object} archer - The archer object
             * @param {number} index - Index in filtered list (not used, kept for compatibility)
             * @param {string} size - Selected shirt size
             */
            async function handleShirtSizeSelect(archer, index, size) {
                try {
                    const list = ArcherModule.loadList();
                    // Find archer in full list by extId or id
                    const archerIndex = list.findIndex(a =>
                        (a.extId && a.extId === archer.extId) ||
                        (a.id && a.id === archer.id)
                    );

                    if (archerIndex >= 0) {
                        list[archerIndex].shirtSize = size;
                        ArcherModule.saveList(list);

                        // Check if this is a self-edit (no auth required)
                        const state = getRosterState();
                        const isSelfEdit = state.selfArcher &&
                            ((archer.extId && archer.extId === state.selfArcher.extId) ||
                                (archer.id && archer.id === state.selfArcher.id));

                        if (isSelfEdit) {
                            // Use self-update endpoint (no auth required!)
                            try {
                                const updatedArcher = Object.assign({}, list[archerIndex], {
                                    id: list[archerIndex].id || list[archerIndex].archerId,
                                    extId: list[archerIndex].extId
                                });
                                const result = await ArcherModule.updateSelfProfile(updatedArcher);
                                if (result && result.updated) {
                                    showSaveSuccess('Shirt size saved to database! 💾');
                                } else {
                                    showSaveSuccess('Shirt size updated! ✨');
                                }
                            } catch (syncError) {
                                console.warn('Self-update sync failed:', syncError);
                                showSaveSuccess('Shirt size saved locally (will retry) 📱');
                            }
                        } else {
                            // Regular update (requires auth) - use editArcher which handles sync
                            try {
                                const result = await ArcherModule.editArcher(archerIndex, { shirtSize: size });
                                let syncResult = result?.sync;
                                if (syncResult && typeof syncResult.then === 'function') {
                                    try {
                                        syncResult = await syncResult;
                                    } catch (syncError) {
                                        console.error('Sync error:', syncError);
                                        syncResult = { ok: false, error: syncError.message };
                                    }
                                }

                                if (syncResult?.ok && syncResult.processed > 0 && syncResult.pending === 0) {
                                    showSaveSuccess('Shirt size saved to database! 💾');
                                } else if (syncResult?.ok && syncResult.pending > 0) {
                                    showSaveSuccess('Shirt size saved locally (syncing...) ⏳');
                                } else if (syncResult?.ok === false) {
                                    const errorMsg = syncResult?.error || 'Unknown error';
                                    if (errorMsg.includes('API key') || errorMsg.includes('auth') || errorMsg.includes('unauthorized')) {
                                        showSaveSuccess('Shirt size saved locally (coach API key needed) 🔑');
                                    } else {
                                        showSaveSuccess('Shirt size saved locally (offline - will retry) 📱');
                                    }
                                } else {
                                    showSaveSuccess('Shirt size updated! ✨');
                                }
                                recordSyncMessage(syncResult, 'Shirt size updated');
                            } catch (syncError) {
                                console.warn('Sync failed:', syncError);
                                showSaveSuccess('Shirt size saved locally (offline - will retry) 📱');
                            }
                        }

                        // Re-render to show updated selection
                        renderList();
                    }
                } catch (err) {
                    console.error('Failed to update shirt size:', err);
                    alert('Failed to update shirt size: ' + err.message);
                }
            }

            /**
             * Open nickname entry modal
             * @param {Object} archer - The archer object
             * @param {number} index - Index in filtered list (not used, kept for compatibility)
             */
            function openNicknameModal(archer, index) {
                const modal = document.getElementById('nickname-modal');
                const input = document.getElementById('nickname-modal-input');
                const saveBtn = document.getElementById('nickname-modal-save');
                const cancelBtn = document.getElementById('nickname-modal-cancel');

                if (!modal || !input) return;

                input.value = archer.nickname || '';
                modal.classList.remove('hidden');
                input.focus();
                input.select();

                // Save handler
                const saveHandler = async () => {
                    const newNickname = input.value.trim();
                    try {
                        const list = ArcherModule.loadList();
                        // Find archer in full list by extId or id
                        const archerIndex = list.findIndex(a =>
                            (a.extId && a.extId === archer.extId) ||
                            (a.id && a.id === archer.id)
                        );

                        if (archerIndex >= 0) {
                            list[archerIndex].nickname = newNickname;
                            ArcherModule.saveList(list);

                            // Check if this is a self-edit (no auth required)
                            const state = getRosterState();
                            const isSelfEdit = state.selfArcher &&
                                ((archer.extId && archer.extId === state.selfArcher.extId) ||
                                    (archer.id && archer.id === state.selfArcher.id));

                            if (isSelfEdit) {
                                // Use self-update endpoint (no auth required!)
                                try {
                                    const updatedArcher = Object.assign({}, list[archerIndex], {
                                        id: list[archerIndex].id || list[archerIndex].archerId,
                                        extId: list[archerIndex].extId
                                    });
                                    const result = await ArcherModule.updateSelfProfile(updatedArcher);
                                    if (result && result.updated) {
                                        showSaveSuccess('Nickname saved to database! 💾');
                                    } else {
                                        showSaveSuccess('Nickname updated! ✨');
                                    }
                                } catch (syncError) {
                                    console.warn('Self-update sync failed:', syncError);
                                    showSaveSuccess('Nickname saved locally (will retry) 📱');
                                }
                            } else {
                                // Regular update (requires auth) - use editArcher which handles sync
                                try {
                                    const result = await ArcherModule.editArcher(archerIndex, { nickname: newNickname });
                                    let syncResult = result?.sync;
                                    if (syncResult && typeof syncResult.then === 'function') {
                                        try {
                                            syncResult = await syncResult;
                                        } catch (syncError) {
                                            console.error('Sync error:', syncError);
                                            syncResult = { ok: false, error: syncError.message };
                                        }
                                    }

                                    if (syncResult?.ok && syncResult.processed > 0 && syncResult.pending === 0) {
                                        showSaveSuccess('Nickname saved to database! 💾');
                                    } else if (syncResult?.ok && syncResult.pending > 0) {
                                        showSaveSuccess('Nickname saved locally (syncing...) ⏳');
                                    } else if (syncResult?.ok === false) {
                                        const errorMsg = syncResult?.error || 'Unknown error';
                                        if (errorMsg.includes('API key') || errorMsg.includes('auth') || errorMsg.includes('unauthorized')) {
                                            showSaveSuccess('Nickname saved locally (coach API key needed) 🔑');
                                        } else {
                                            showSaveSuccess('Nickname saved locally (offline - will retry) 📱');
                                        }
                                    } else {
                                        showSaveSuccess('Nickname updated! ✨');
                                    }
                                    recordSyncMessage(syncResult, 'Nickname updated');
                                } catch (syncError) {
                                    console.warn('Sync failed:', syncError);
                                    showSaveSuccess('Nickname saved locally (offline - will retry) 📱');
                                }
                            }

                            modal.classList.add('hidden');
                            renderList();
                        }
                    } catch (err) {
                        console.error('Failed to update nickname:', err);
                        alert('Failed to update nickname: ' + err.message);
                    }
                };

                // Cancel handler
                const cancelHandler = () => {
                    modal.classList.add('hidden');
                };

                // Remove old listeners by replacing onclick
                saveBtn.onclick = saveHandler;
                cancelBtn.onclick = cancelHandler;

                // Handle backdrop click - only close if clicking the backdrop itself
                const backdropHandler = (e) => {
                    if (e.target === modal) {
                        cancelHandler();
                    }
                };
                modal.onclick = backdropHandler;

                // Prevent inner content clicks from closing modal
                const innerContent = modal.querySelector('div.bg-white, div.dark\\:bg-gray-800');
                if (innerContent) {
                    innerContent.onclick = (e) => {
                        e.stopPropagation();
                    };
                }

                // Handle Enter and Escape keys
                const keyHandler = (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        saveHandler();
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        cancelHandler();
                    }
                };
                input.onkeydown = keyHandler;
            }

            updateSyncStatus();

            // Store expanded sections state for persistence across navigation
            let expandedSections = new Set();

            function openModal(index = null) {
                // Save which sections are currently expanded (if modal is already open)
                const existingForm = document.getElementById('archer-form');
                if (existingForm && index !== null && editingIndex !== null) {
                    expandedSections.clear();
                    const detailsElements = existingForm.querySelectorAll('details');
                    detailsElements.forEach((details, idx) => {
                        if (details.open) {
                            // Use section identifier (summary text or index)
                            const summary = details.querySelector('summary');
                            const sectionName = summary ? summary.textContent.trim() : `section-${idx}`;
                            expandedSections.add(sectionName);
                        }
                    });
                } else {
                    // Reset on first open or when adding new archer
                    expandedSections.clear();
                }

                editingIndex = index;
                const form = document.getElementById('archer-form');
                form.innerHTML = createFormFieldsHTML();

                // Prevent body scroll when modal is open
                // Store current scroll position
                const scrollY = window.scrollY;
                document.body.style.position = 'fixed';
                document.body.style.top = `-${scrollY}px`;
                document.body.style.width = '100%';
                document.body.style.overflow = 'hidden';

                // Store scroll position for restoration
                modal.dataset.scrollY = scrollY;

                // Ensure form is scrollable - reset scroll position and ensure proper height
                setTimeout(() => {
                    form.scrollTop = 0;
                    // Force browser to recalculate scrollable area
                    const formHeight = form.offsetHeight;
                    const formScrollHeight = form.scrollHeight;
                    // If content is taller than container, ensure scrolling works
                    if (formScrollHeight > formHeight) {
                        form.style.overflowY = 'auto';
                    }

                    // Ensure all nested elements allow touch events for scrolling
                    const allElements = form.querySelectorAll('*');
                    allElements.forEach(el => {
                        // Don't override if element already has touch-action set
                        if (!el.style.touchAction) {
                            el.style.touchAction = 'auto';
                        }
                    });
                }, 100);

                // Restore expanded sections
                if (expandedSections.size > 0) {
                    const detailsElements = form.querySelectorAll('details');
                    detailsElements.forEach((details) => {
                        const summary = details.querySelector('summary');
                        if (summary) {
                            const sectionName = summary.textContent.trim();
                            if (expandedSections.has(sectionName)) {
                                details.open = true;
                            }
                        }
                    });
                }

                // Wire up the fixed cancel button (outside the form)
                const cancelBtn = document.getElementById('cancel-archer-btn-fixed');
                if (cancelBtn) cancelBtn.onclick = closeModal;

                // Close button in header
                const closeModalBtn = document.getElementById('close-modal-btn');
                if (closeModalBtn) closeModalBtn.onclick = closeModal;

                // Store original form state for change detection
                originalFormState = null;
                hasUnsavedChanges = false;

                // Set up change tracking after form is populated
                setTimeout(() => {
                    storeOriginalFormState(form);
                    setupFormChangeTracking(form);
                }, 100);

                const modalTitle = document.getElementById('modal-title');
                const favesInput = form.querySelector('#faves');

                if (index !== null) {
                    const archer = ArcherModule.loadList()[index];
                    // Show nickname instead of first name if nickname exists
                    const displayName = archer.nickname || archer.first || '';
                    modalTitle.textContent = displayName ? `${displayName} ${archer.last || ''}`.trim() : 'Edit Archer';
                    setFormValue(form, 'extId', archer.extId || '');
                    setFormValue(form, 'first', archer.first || '');
                    setFormValue(form, 'last', archer.last || '');
                    setFormValue(form, 'nickname', archer.nickname || '');
                    setFormValue(form, 'photoUrl', archer.photoUrl || '');
                    setFormValue(form, 'school', archer.school || '');
                    setFormValue(form, 'grade', archer.grade || '');
                    setFormValue(form, 'gender', archer.gender || 'M');
                    setFormValue(form, 'level', archer.level || 'VAR');
                    setFormValue(form, 'status', archer.status || 'active');
                    if (favesInput) favesInput.value = (archer.faves || []).join(', ');
                    setFormValue(form, 'email', archer.email || '');
                    setFormValue(form, 'phone', archer.phone || '');
                    setFormValue(form, 'usArcheryId', archer.usArcheryId || '');
                    setFormValue(form, 'jvPr', archer.jvPr || '');
                    setFormValue(form, 'varPr', archer.varPr || '');
                    setFormValue(form, 'shirtSize', archer.shirtSize || '');
                    setFormValue(form, 'pantSize', archer.pantSize || '');
                    setFormValue(form, 'hatSize', archer.hatSize || '');
                    setFormValue(form, 'domEye', archer.domEye || '');
                    setFormValue(form, 'domHand', archer.domHand || '');
                    setFormValue(form, 'heightIn', archer.heightIn || '');
                    setFormValue(form, 'wingspanIn', archer.wingspanIn || '');
                    setFormValue(form, 'drawLengthSugg', archer.drawLengthSugg || '');
                    setFormValue(form, 'riserHeightIn', archer.riserHeightIn || '');
                    setFormValue(form, 'limbLength', archer.limbLength || '');
                    setFormValue(form, 'limbWeightLbs', archer.limbWeightLbs || '');
                    setFormValue(form, 'notesGear', archer.notesGear || '');
                    setFormValue(form, 'notesCurrent', archer.notesCurrent || '');
                    setFormValue(form, 'notesArchive', archer.notesArchive || '');
                    setFormValue(form, 'legacyBale', archer.bale || '');
                    setFormValue(form, 'legacyTarget', archer.target || '');
                    setFormValue(form, 'legacySize', archer.size || '');
                    // Extended profile fields (coach-only)
                    setFormValue(form, 'dob', archer.dob || '');
                    setFormValue(form, 'email2', archer.email2 || '');
                    setFormValue(form, 'nationality', archer.nationality || 'U.S.A.');
                    setFormValue(form, 'ethnicity', archer.ethnicity || '');
                    setFormValue(form, 'discipline', archer.discipline || '');
                    setFormValue(form, 'streetAddress', archer.streetAddress || '');
                    setFormValue(form, 'streetAddress2', archer.streetAddress2 || '');
                    setFormValue(form, 'city', archer.city || '');
                    setFormValue(form, 'state', archer.state || '');
                    setFormValue(form, 'postalCode', archer.postalCode || '');
                    setFormValue(form, 'disability', archer.disability || '');
                    setFormValue(form, 'campAttendance', archer.campAttendance || '');
                    // USA Archery fields
                    setFormValue(form, 'validFrom', archer.validFrom || '');
                    setFormValue(form, 'clubState', archer.clubState || '');
                    setFormValue(form, 'membershipType', archer.membershipType || '');
                    setFormValue(form, 'addressCountry', archer.addressCountry || 'USA');
                    setFormValue(form, 'addressLine3', archer.addressLine3 || '');
                    setFormValue(form, 'disabilityList', archer.disabilityList || '');
                    setFormValue(form, 'militaryService', archer.militaryService || 'No');
                    setFormValue(form, 'introductionSource', archer.introductionSource || '');
                    setFormValue(form, 'introductionOther', archer.introductionOther || '');
                    setFormValue(form, 'nfaaMemberNo', archer.nfaaMemberNo || '');
                    setFormValue(form, 'schoolType', archer.schoolType || '');
                    setFormValue(form, 'schoolFullName', archer.schoolFullName || '');
                } else {
                    modalTitle.textContent = 'Add Archer';
                    setFormValue(form, 'status', 'active');
                    // Hide navigation for new archers
                    const navigationDiv = document.getElementById('archer-navigation');
                    if (navigationDiv) navigationDiv.classList.add('hidden');
                }

                const emailDomainBtn = form.querySelector('#email-domain-btn');
                if (emailDomainBtn) {
                    const emailInput = form.querySelector('#email');
                    emailDomainBtn.onclick = (e) => {
                        e.preventDefault();
                        if (!emailInput) return;
                        let value = emailInput.value.trim();
                        const domain = SCHOOL_EMAIL_DOMAIN;
                        const normalizedDomain = domain.startsWith('@') ? domain : `@${domain}`;
                        if (!value) {
                            emailInput.value = normalizedDomain;
                            requestAnimationFrame(() => {
                                if (emailInput.setSelectionRange) {
                                    emailInput.setSelectionRange(0, 0);
                                }
                                emailInput.focus();
                            });
                            return;
                        }
                        if (value.toLowerCase().endsWith(normalizedDomain.toLowerCase())) {
                            alert('Email already includes the school domain.');
                            return;
                        }
                        if (value.includes('@')) {
                            if (!confirm('Replace the existing domain with the school domain?')) {
                                return;
                            }
                            value = value.split('@')[0];
                        }
                        emailInput.value = `${value}${normalizedDomain}`;
                    };
                }

                modal.classList.remove('hidden');

                // Initialize avatar upload functionality
                initializeAvatarUpload(form);

                // Update avatar preview based on current data
                updateAvatarPreview(form);

                // Initialize notes history functionality
                initializeNotesHistory(form);

                // Initialize navigation if editing
                if (index !== null) {
                    initializeArcherNavigation(index);
                }

                // Conditional field: introductionOther (show/hide based on introductionSource)
                const introductionSourceSelect = form.querySelector('#introductionSource');
                const introductionOtherWrapper = form.querySelector('#introductionOtherWrapper');
                if (introductionSourceSelect && introductionOtherWrapper) {
                    const toggleIntroductionOther = () => {
                        if (introductionSourceSelect.value === 'Other') {
                            introductionOtherWrapper.classList.remove('hidden');
                        } else {
                            introductionOtherWrapper.classList.add('hidden');
                            const introOtherInput = form.querySelector('#introductionOther');
                            if (introOtherInput) introOtherInput.value = '';
                        }
                    };
                    introductionSourceSelect.addEventListener('change', toggleIntroductionOther);
                    toggleIntroductionOther(); // Initial state
                }
            }

            function initializeAvatarUpload(form) {
                const uploadBtn = form.querySelector('#upload-avatar-btn');
                const fileInput = form.querySelector('#avatar-file');
                const photoUrlInput = form.querySelector('#photoUrl');
                const uploadProgress = form.querySelector('#upload-progress');

                if (!uploadBtn || !fileInput) return;

                // Click upload button to trigger file picker
                uploadBtn.onclick = (e) => {
                    e.preventDefault();
                    fileInput.click();
                };

                // Handle file selection - open crop modal
                fileInput.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    // Validate file type
                    if (!file.type.startsWith('image/')) {
                        alert('Please select an image file');
                        fileInput.value = '';
                        return;
                    }

                    // Validate file size (10MB max)
                    if (file.size > 10 * 1024 * 1024) {
                        alert('File too large. Maximum size is 10MB');
                        fileInput.value = '';
                        return;
                    }

                    // Open crop modal
                    openCropModal(file, uploadBtn, uploadProgress, photoUrlInput, form);
                };

                // Update preview when URL changes
                photoUrlInput.addEventListener('input', () => {
                    updateAvatarPreview(form);
                });

                // Update preview when name changes (for initials)
                form.querySelector('#first')?.addEventListener('input', () => updateAvatarPreview(form));
                form.querySelector('#last')?.addEventListener('input', () => updateAvatarPreview(form));
            }

            function updateAvatarPreview(form) {
                const photoUrlInput = form.querySelector('#photoUrl');
                const avatarImage = form.querySelector('#avatar-image');
                const avatarInitials = form.querySelector('#avatar-initials');
                const firstInput = form.querySelector('#first');
                const lastInput = form.querySelector('#last');

                // Header avatar elements
                const headerAvatarImg = document.getElementById('header-avatar-img');
                const headerInitials = document.getElementById('header-initials');

                if (!avatarImage || !avatarInitials) return;

                const photoUrl = photoUrlInput?.value.trim();
                const first = firstInput?.value.trim() || '';
                const last = lastInput?.value.trim() || '';

                if (photoUrl) {
                    // Debug: log the photo URL being used
                    console.log('Setting avatar image src to:', photoUrl);

                    // Show photo in form
                    avatarImage.src = photoUrl;
                    avatarImage.classList.remove('hidden');
                    avatarInitials.classList.add('hidden');

                    // Show photo in header
                    if (headerAvatarImg && headerInitials) {
                        headerAvatarImg.src = photoUrl;
                        headerAvatarImg.classList.remove('hidden');
                        headerInitials.classList.add('hidden');
                    }

                    // Handle image load error
                    avatarImage.onerror = (e) => {
                        console.error('Failed to load avatar image:', photoUrl, e);
                        avatarImage.classList.add('hidden');
                        avatarInitials.classList.remove('hidden');
                        showInitials(avatarInitials, first, last);
                        if (headerAvatarImg && headerInitials) {
                            headerAvatarImg.classList.add('hidden');
                            headerInitials.classList.remove('hidden');
                            showInitials(headerInitials, first, last);
                        }
                    };
                } else {
                    // Show initials in form
                    avatarImage.classList.add('hidden');
                    avatarInitials.classList.remove('hidden');
                    showInitials(avatarInitials, first, last);

                    // Show initials in header
                    if (headerAvatarImg && headerInitials) {
                        headerAvatarImg.classList.add('hidden');
                        headerInitials.classList.remove('hidden');
                        showInitials(headerInitials, first, last);
                    }
                }
            }

            function showInitials(element, first, last) {
                if (first || last) {
                    const initials = (first.charAt(0) + last.charAt(0)).toUpperCase();
                    element.textContent = initials || '?';
                } else {
                    element.textContent = '?';
                }
            }

            function initializeNotesHistory(form) {
                const moveToHistoryBtn = form.querySelector('#move-to-history-btn');
                const currentNotesInput = form.querySelector('#notesCurrent');
                const archiveNotesInput = form.querySelector('#notesArchive');

                if (!moveToHistoryBtn || !currentNotesInput || !archiveNotesInput) return;

                moveToHistoryBtn.onclick = (e) => {
                    e.preventDefault();

                    const currentNote = currentNotesInput.value.trim();
                    if (!currentNote) {
                        alert('No current note to move to history.');
                        return;
                    }

                    // Create timestamp (short format at end)
                    const now = new Date();
                    const timestamp = now.toLocaleDateString('en-US', {
                        month: 'numeric',
                        day: 'numeric',
                        year: '2-digit'
                    });

                    // Format: "Note text (11/22/25)"
                    const timestampedNote = `${currentNote} (${timestamp})`;

                    // Get existing archive
                    const existingArchive = archiveNotesInput.value.trim();

                    // Prepend new note to archive (most recent first)
                    const newArchive = existingArchive
                        ? `${timestampedNote}\n${existingArchive}`
                        : timestampedNote;

                    // Update fields
                    archiveNotesInput.value = newArchive;
                    currentNotesInput.value = '';

                    // Focus back to current notes for next entry
                    currentNotesInput.focus();
                };
            }

            function initializeArcherNavigation(currentIndex) {
                const navigationDiv = document.getElementById('archer-navigation');
                const prevBtn = document.getElementById('prev-archer-btn');
                const nextBtn = document.getElementById('next-archer-btn');
                const positionSpan = document.getElementById('archer-position');

                if (!navigationDiv || !prevBtn || !nextBtn || !positionSpan) return;

                // Find current position in filtered list
                const currentPosition = filteredArcherIndices.indexOf(currentIndex);
                const totalArchers = filteredArcherIndices.length;

                if (currentPosition === -1 || totalArchers <= 1) {
                    navigationDiv.classList.add('hidden');
                    navigationDiv.classList.remove('flex');
                    return;
                }

                // Show navigation with flex
                navigationDiv.classList.remove('hidden');
                navigationDiv.classList.add('flex');

                // Update position display (compact format)
                positionSpan.textContent = `${currentPosition + 1}/${totalArchers}`;

                // Update button states
                prevBtn.disabled = currentPosition === 0;
                nextBtn.disabled = currentPosition === totalArchers - 1;
                prevBtn.style.opacity = currentPosition === 0 ? '0.3' : '1';
                nextBtn.style.opacity = currentPosition === totalArchers - 1 ? '0.3' : '1';

                // Add click handlers with unsaved changes check
                prevBtn.onclick = () => {
                    if (currentPosition > 0) {
                        // Check for unsaved changes before navigating
                        const form = document.getElementById('archer-form');
                        if (form && originalFormState && checkForChanges(form) && hasUnsavedChanges) {
                            const confirmed = confirm('You have unsaved changes. Are you sure you want to navigate away without saving?');
                            if (!confirmed) {
                                return; // Don't navigate if user cancels
                            }
                        }
                        const prevIndex = filteredArcherIndices[currentPosition - 1];
                        openModal(prevIndex);
                    }
                };

                nextBtn.onclick = () => {
                    if (currentPosition < totalArchers - 1) {
                        // Check for unsaved changes before navigating
                        const form = document.getElementById('archer-form');
                        if (form && originalFormState && checkForChanges(form) && hasUnsavedChanges) {
                            const confirmed = confirm('You have unsaved changes. Are you sure you want to navigate away without saving?');
                            if (!confirmed) {
                                return; // Don't navigate if user cancels
                            }
                        }
                        const nextIndex = filteredArcherIndices[currentPosition + 1];
                        openModal(nextIndex);
                    }
                };
            }

            // Crop modal functionality
            let cropperInstance = null;
            let currentCropFile = null;
            let currentUploadBtn = null;
            let currentUploadProgress = null;
            let currentPhotoUrlInput = null;
            let currentForm = null;

            function openCropModal(file, uploadBtn, uploadProgress, photoUrlInput, form) {
                const cropModal = document.getElementById('crop-modal');
                const cropImage = document.getElementById('crop-image');
                const cancelCropBtn = document.getElementById('cancel-crop-btn');
                const applyCropBtn = document.getElementById('apply-crop-btn');

                // Store references
                currentCropFile = file;
                currentUploadBtn = uploadBtn;
                currentUploadProgress = uploadProgress;
                currentPhotoUrlInput = photoUrlInput;
                currentForm = form;

                // Load image
                const reader = new FileReader();
                reader.onload = (e) => {
                    cropImage.src = e.target.result;
                    cropModal.classList.remove('hidden');

                    // Initialize cropper
                    if (cropperInstance) {
                        cropperInstance.destroy();
                    }

                    cropperInstance = new Cropper(cropImage, {
                        aspectRatio: 1, // Square crop
                        viewMode: 2, // Restrict crop box to canvas
                        dragMode: 'move',
                        autoCropArea: 0.8,
                        restore: false,
                        guides: true,
                        center: true,
                        highlight: false,
                        cropBoxMovable: true,
                        cropBoxResizable: true,
                        toggleDragModeOnDblclick: false,
                        responsive: true,
                        background: false,
                        modal: true,
                        minCropBoxWidth: 100,
                        minCropBoxHeight: 100
                    });
                };
                reader.readAsDataURL(file);

                // Cancel button
                cancelCropBtn.onclick = () => {
                    closeCropModal();
                    // Reset file input
                    document.getElementById('avatar-file').value = '';
                };

                // Apply crop button
                applyCropBtn.onclick = async () => {
                    if (!cropperInstance) return;

                    // Get cropped canvas
                    const canvas = cropperInstance.getCroppedCanvas({
                        width: 1024,
                        height: 1024,
                        imageSmoothingEnabled: true,
                        imageSmoothingQuality: 'high'
                    });

                    // Convert to blob
                    canvas.toBlob(async (blob) => {
                        closeCropModal();
                        await uploadCroppedImage(blob);
                    }, currentCropFile.type, 0.95);
                };
            }

            function closeCropModal() {
                const cropModal = document.getElementById('crop-modal');
                cropModal.classList.add('hidden');

                if (cropperInstance) {
                    cropperInstance.destroy();
                    cropperInstance = null;
                }
            }

            async function uploadCroppedImage(blob) {
                // Show progress
                currentUploadBtn.classList.add('hidden');
                currentUploadProgress.classList.remove('hidden');

                try {
                    // Create form data
                    const formData = new FormData();
                    formData.append('avatar', blob, currentCropFile.name);

                    const response = await fetch('api/upload_avatar.php', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error('Upload failed');
                    }

                    const result = await response.json();

                    if (result.success && result.photoUrl) {
                        // Debug: log the returned URL
                        console.log('Avatar upload successful. photoUrl:', result.photoUrl);
                        console.log('Full response:', result);

                        // Update photoUrl field
                        currentPhotoUrlInput.value = result.photoUrl;

                        // Update preview
                        updateAvatarPreview(currentForm);

                        // Show success feedback
                        currentUploadProgress.innerHTML = '<i class="fas fa-check mr-1"></i>Uploaded!';
                        currentUploadProgress.classList.remove('text-gray-600', 'dark:text-gray-400');
                        currentUploadProgress.classList.add('text-green-600', 'dark:text-green-400');

                        setTimeout(() => {
                            currentUploadProgress.classList.add('hidden');
                            currentUploadProgress.classList.remove('text-green-600', 'dark:text-green-400');
                            currentUploadProgress.classList.add('text-gray-600', 'dark:text-gray-400');
                            currentUploadProgress.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Uploading...';
                            currentUploadBtn.classList.remove('hidden');
                        }, 2000);
                    } else {
                        throw new Error(result.error || 'Upload failed');
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    alert('Failed to upload photo: ' + error.message);
                    currentUploadProgress.classList.add('hidden');
                    currentUploadBtn.classList.remove('hidden');
                }

                // Reset file input
                document.getElementById('avatar-file').value = '';
            }

            function createFormFieldsHTML() {
                return `
                    <input type="hidden" id="extId">
                    <input type="hidden" id="legacyBale">
                    <input type="hidden" id="legacyTarget">
                    <input type="hidden" id="legacySize">
                    <input type="hidden" id="riserHeightIn">

                    <!-- Hero Section: Avatar + Name + Quick Stats -->
                    <div class="px-4 pt-4 pb-3 bg-gray-50 dark:bg-gray-900">
                        <div class="flex gap-3">
                            <!-- Avatar Preview (128x128) -->
                            <div class="relative flex-shrink-0">
                                <div id="avatar-preview" class="w-32 h-32 rounded-xl border-2 border-gray-200 dark:border-gray-600 overflow-hidden bg-white dark:bg-gray-800 flex items-center justify-center shadow-sm" style="width: 128px; height: 128px;">
                                    <span id="avatar-initials" class="text-2xl font-bold text-gray-400 dark:text-gray-500">?</span>
                                    <img id="avatar-image" class="hidden w-full h-full object-cover" alt="Avatar" style="max-width: 128px; max-height: 128px;">
                                </div>
                                <button type="button" id="upload-avatar-btn" class="absolute -bottom-1 -right-1 w-7 h-7 bg-primary hover:bg-primary-dark text-white rounded-full shadow-lg flex items-center justify-center transition-colors">
                                    <i class="fas fa-camera text-xs"></i>
                                </button>
                                <input type="file" id="avatar-file" accept="image/*" class="hidden">
                                <input type="hidden" id="photoUrl">
                                <div id="upload-progress" class="hidden absolute inset-0 bg-black/50 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-spinner fa-spin text-white"></i>
                                </div>
                            </div>
                            <!-- Name + Status -->
                            <div class="flex-1 min-w-0 flex flex-col justify-center gap-1.5">
                                <input class="w-full px-2.5 py-1.5 text-base font-semibold border border-gray-200 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" type="text" id="first" placeholder="First Name*" required>
                                <input class="w-full px-2.5 py-1.5 text-base border border-gray-200 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" type="text" id="last" placeholder="Last Name*" required>
                                <div class="flex gap-2">
                                    <input class="flex-1 px-2.5 py-1.5 text-sm border border-gray-200 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" type="text" id="nickname" placeholder="Nickname">
                                    <select class="w-20 px-2 py-1.5 text-sm border border-gray-200 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" id="status">
                                        <option value="active">Active</option>
                                        <option value="inactive">Inactive</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <!-- Quick Stats Row -->
                        <div class="mt-3 grid grid-cols-4 gap-2">
                            <div class="text-center">
                                <input class="w-full px-1 py-1 text-center text-sm border border-gray-200 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" type="text" id="school" maxlength="3" placeholder="SCH">
                                <div class="text-[10px] text-gray-500 dark:text-gray-400 mt-0.5">School</div>
                            </div>
                            <div class="text-center">
                                <select class="w-full px-1 py-1 text-center text-sm border border-gray-200 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" id="grade">
                                    <option value="">-</option>
                                    <option value="9">9</option>
                                    <option value="10">10</option>
                                    <option value="11">11</option>
                                    <option value="12">12</option>
                                    <option value="GRAD">GRAD</option>
                                </select>
                                <div class="text-[10px] text-gray-500 dark:text-gray-400 mt-0.5">Grade</div>
                            </div>
                            <div class="text-center">
                                <select class="w-full px-1 py-1 text-center text-sm border border-gray-200 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" id="gender">
                                    <option value="M">M</option>
                                    <option value="F">F</option>
                                </select>
                                <div class="text-[10px] text-gray-500 dark:text-gray-400 mt-0.5">Gender</div>
                            </div>
                            <div class="text-center">
                                <select class="w-full px-1 py-1 text-center text-sm border border-gray-200 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" id="level">
                                    <option value="VAR">VAR</option>
                                    <option value="JV">JV</option>
                                    <option value="BEG">BEG</option>
                                </select>
                                <div class="text-[10px] text-gray-500 dark:text-gray-400 mt-0.5">Level</div>
                            </div>
                        </div>
                    </div>

                    <!-- Collapsible Sections -->
                    <div class="px-3 py-2 space-y-2">
                        
                        <!-- Performance Section (Always Open) -->
                        <details class="group bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700" open>
                            <summary class="flex items-center justify-between px-3 py-2.5 cursor-pointer select-none">
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-trophy text-yellow-500 dark:text-yellow-400 text-sm"></i>
                                    <span class="font-semibold text-sm text-gray-800 dark:text-white">Performance</span>
                                </div>
                                <i class="fas fa-chevron-down text-gray-400 text-xs transition-transform group-open:rotate-180"></i>
                            </summary>
                            <div class="px-3 pb-3 pt-1 border-t border-gray-100 dark:border-gray-700">
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="text-xs text-gray-500 dark:text-gray-400">JV PR</label>
                                        <input class="w-full px-2 py-1.5 text-sm border border-gray-200 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" type="number" id="jvPr" min="0" max="360" placeholder="0-360">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-500 dark:text-gray-400">VAR PR</label>
                                        <input class="w-full px-2 py-1.5 text-sm border border-gray-200 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" type="number" id="varPr" min="0" max="360" placeholder="0-360">
                                    </div>
                                </div>
                            </div>
                        </details>

                        <!-- Equipment Section -->
                        <details class="group bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
                            <summary class="flex items-center justify-between px-3 py-2.5 cursor-pointer select-none">
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-bullseye text-red-500 dark:text-red-400 text-sm"></i>
                                    <span class="font-semibold text-sm text-gray-800 dark:text-white">Equipment</span>
                                </div>
                                <i class="fas fa-chevron-down text-gray-400 text-xs transition-transform group-open:rotate-180"></i>
                            </summary>
                            <div class="px-3 pb-3 pt-1 border-t border-gray-100 dark:border-gray-700 space-y-2">
                                <div class="grid grid-cols-4 gap-2">
                                    <div>
                                        <label class="text-xs text-gray-500 dark:text-gray-400">Hand</label>
                                        <select class="w-full px-1 py-1.5 text-sm border border-gray-200 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" id="domHand">
                                            <option value="">-</option>
                                            <option value="RT">R</option>
                                            <option value="LT">L</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-500 dark:text-gray-400">Eye</label>
                                        <select class="w-full px-1 py-1.5 text-sm border border-gray-200 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" id="domEye">
                                            <option value="">-</option>
                                            <option value="RT">R</option>
                                            <option value="LT">L</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-500 dark:text-gray-400">Height</label>
                                        <input class="w-full px-1 py-1.5 text-sm border border-gray-200 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" type="number" id="heightIn" placeholder="in">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-500 dark:text-gray-400">Wing</label>
                                        <input class="w-full px-1 py-1.5 text-sm border border-gray-200 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" type="number" id="wingspanIn" placeholder="in">
                                    </div>
                                </div>
                                <div class="grid grid-cols-3 gap-2">
                                    <div>
                                        <label class="text-xs text-gray-500 dark:text-gray-400">Draw</label>
                                        <input class="w-full px-1 py-1.5 text-sm border border-gray-200 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" type="number" id="drawLengthSugg" placeholder="in">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-500 dark:text-gray-400">Limb</label>
                                        <select class="w-full px-1 py-1.5 text-sm border border-gray-200 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" id="limbLength">
                                            <option value="">-</option>
                                            <option value="S">S</option>
                                            <option value="M">M</option>
                                            <option value="L">L</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-500 dark:text-gray-400">Weight</label>
                                        <input class="w-full px-1 py-1.5 text-sm border border-gray-200 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" type="number" id="limbWeightLbs" placeholder="lbs">
                                    </div>
                                </div>
                                <div>
                                    <label class="text-xs text-gray-500 dark:text-gray-400">Gear Notes</label>
                                    <textarea class="w-full px-2 py-1.5 text-sm border border-gray-200 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary resize-none" id="notesGear" rows="2"></textarea>
                                </div>
                            </div>
                        </details>

                        <!-- Notes Section -->
                        <details class="group bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
                            <summary class="flex items-center justify-between px-3 py-2.5 cursor-pointer select-none">
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-sticky-note text-blue-500 dark:text-blue-400 text-sm"></i>
                                    <span class="font-semibold text-sm text-gray-800 dark:text-white">Notes</span>
                                </div>
                                <i class="fas fa-chevron-down text-gray-400 text-xs transition-transform group-open:rotate-180"></i>
                            </summary>
                            <div class="px-3 pb-3 pt-1 border-t border-gray-100 dark:border-gray-700 space-y-2">
                                <div>
                                    <div class="flex justify-between items-center">
                                        <label class="text-xs text-gray-500 dark:text-gray-400">Current Notes</label>
                                        <button type="button" id="move-to-history-btn" class="text-xs text-primary hover:text-primary-dark" title="Archive">
                                            <i class="fas fa-archive mr-1"></i>Archive
                                        </button>
                                    </div>
                                    <textarea class="w-full px-2 py-1.5 text-sm border border-gray-200 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary resize-none" id="notesCurrent" rows="2"></textarea>
                                </div>
                                <div>
                                    <label class="text-xs text-gray-500 dark:text-gray-400">History</label>
                                    <textarea class="w-full px-2 py-1.5 text-sm border border-gray-200 dark:border-gray-600 rounded bg-gray-100 dark:bg-gray-600 text-gray-700 dark:text-gray-300 cursor-not-allowed resize-none" id="notesArchive" rows="2" readonly placeholder="Archived notes..."></textarea>
                                </div>
                            </div>
                        </details>

                        <!-- Sizes Section -->
                        <details class="group bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
                            <summary class="flex items-center justify-between px-3 py-2.5 cursor-pointer select-none">
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-tshirt text-purple-500 dark:text-purple-400 text-sm"></i>
                                    <span class="font-semibold text-sm text-gray-800 dark:text-white">Sizes</span>
                                </div>
                                <i class="fas fa-chevron-down text-gray-400 text-xs transition-transform group-open:rotate-180"></i>
                            </summary>
                            <div class="px-3 pb-3 pt-1 border-t border-gray-100 dark:border-gray-700">
                                <div class="grid grid-cols-3 gap-2">
                                    <div>
                                        <label class="text-xs text-gray-500 dark:text-gray-400">Shirt</label>
                                        <select class="w-full px-1 py-1.5 text-sm border border-gray-200 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" id="shirtSize">
                                            <option value="">-</option>
                                            <option value="XS">XS</option>
                                            <option value="S">S</option>
                                            <option value="M">M</option>
                                            <option value="L">L</option>
                                            <option value="XL">XL</option>
                                            <option value="XXL">XXL</option>
                                            <option value="XXXL">3XL</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-500 dark:text-gray-400">Pant</label>
                                        <input class="w-full px-1 py-1.5 text-sm border border-gray-200 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" type="text" id="pantSize" placeholder="32x34">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-500 dark:text-gray-400">Hat</label>
                                        <select class="w-full px-1 py-1.5 text-sm border border-gray-200 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" id="hatSize">
                                            <option value="">-</option>
                                            <option value="XS">XS</option>
                                            <option value="S">S</option>
                                            <option value="M">M</option>
                                            <option value="L">L</option>
                                            <option value="XL">XL</option>
                                            <option value="XXL">XXL</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </details>

                        <!-- Contact Section -->
                        <details class="group bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
                            <summary class="flex items-center justify-between px-3 py-2.5 cursor-pointer select-none">
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-address-card text-green-500 dark:text-green-400 text-sm"></i>
                                    <span class="font-semibold text-sm text-gray-800 dark:text-white">Contact</span>
                                </div>
                                <i class="fas fa-chevron-down text-gray-400 text-xs transition-transform group-open:rotate-180"></i>
                            </summary>
                            <div class="px-3 pb-3 pt-1 border-t border-gray-100 dark:border-gray-700 space-y-2">
                                <div>
                                    <label class="text-xs text-gray-500 dark:text-gray-400">Email</label>
                                    <div class="flex gap-1">
                                        <input class="flex-1 px-2 py-1.5 text-sm border border-gray-200 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" type="email" id="email" placeholder="email">
                                        <button type="button" id="email-domain-btn" class="px-2 py-1.5 text-xs border border-gray-200 dark:border-gray-600 rounded bg-gray-100 dark:bg-gray-600 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-500">@stu...</button>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="text-xs text-gray-500 dark:text-gray-400">Phone</label>
                                        <input class="w-full px-2 py-1.5 text-sm border border-gray-200 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" type="tel" id="phone" placeholder="###-###-####">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-500 dark:text-gray-400">USA Archery</label>
                                        <input class="w-full px-2 py-1.5 text-sm border border-gray-200 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" type="text" id="usArcheryId" placeholder="ID">
                                    </div>
                                </div>
                            </div>
                        </details>

                        <!-- Friends (Hidden by default) -->
                        <details class="group bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
                            <summary class="flex items-center justify-between px-3 py-2.5 cursor-pointer select-none">
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-heart text-red-400 dark:text-red-300 text-sm"></i>
                                    <span class="font-semibold text-sm text-gray-800 dark:text-white">Friends</span>
                                </div>
                                <i class="fas fa-chevron-down text-gray-400 text-xs transition-transform group-open:rotate-180"></i>
                            </summary>
                            <div class="px-3 pb-3 pt-1 border-t border-gray-100 dark:border-gray-700">
                                <input class="w-full px-2 py-1.5 text-sm border border-gray-200 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" type="text" id="faves" placeholder="Comma-separated extIds">
                            </div>
                        </details>

                        <!-- Coach-Only Section (Extended Profile for USA Archery) -->
                        ${isCoachMode() ? `
                        <details class="group bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-amber-200 dark:border-amber-700">
                            <summary class="flex items-center justify-between px-3 py-2.5 cursor-pointer select-none bg-amber-50 dark:bg-amber-900/20 rounded-t-lg">
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-user-shield text-amber-600 dark:text-amber-400 text-sm"></i>
                                    <span class="font-semibold text-sm text-gray-800 dark:text-white">Extended Profile</span>
                                    <span class="text-xs text-amber-600 dark:text-amber-400">(Coach Only)</span>
                                </div>
                                <i class="fas fa-chevron-down text-gray-400 text-xs transition-transform group-open:rotate-180"></i>
                            </summary>
                            <div class="px-3 pb-3 pt-2 border-t border-amber-100 dark:border-amber-800 space-y-3">
                                <!-- Personal Info -->
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="text-xs text-gray-500 dark:text-gray-400">Date of Birth</label>
                                        <input class="w-full px-2 py-1.5 text-sm border border-gray-200 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" type="date" id="dob">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-500 dark:text-gray-400">Discipline</label>
                                        <select class="w-full px-2 py-1.5 text-sm border border-gray-200 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" id="discipline">
                                            <option value="">-</option>
                                            <option value="Recurve">Recurve</option>
                                            <option value="Compound">Compound</option>
                                            <option value="Barebow">Barebow</option>
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <label class="text-xs text-gray-500 dark:text-gray-400">Secondary Email</label>
                                    <input class="w-full px-2 py-1.5 text-sm border border-gray-200 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" type="email" id="email2" placeholder="Parent/Guardian email">
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="text-xs text-gray-500 dark:text-gray-400">Nationality</label>
                                        <input class="w-full px-2 py-1.5 text-sm border border-gray-200 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" type="text" id="nationality" placeholder="U.S.A.">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-500 dark:text-gray-400">Ethnicity</label>
                                        <input class="w-full px-2 py-1.5 text-sm border border-gray-200 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" type="text" id="ethnicity">
                                    </div>
                                </div>
                                
                                <!-- USA Archery Membership Information -->
                                <div class="border-t border-gray-100 dark:border-gray-700 pt-2">
                                    <label class="text-xs text-gray-500 dark:text-gray-400 font-medium">USA Archery Membership</label>
                                    <div class="grid grid-cols-2 gap-2 mt-1">
                                        <div>
                                            <label class="text-xs text-gray-500 dark:text-gray-400">Membership Valid From</label>
                                            <input class="w-full px-2 py-1.5 text-sm border border-gray-200 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" type="date" id="validFrom">
                                        </div>
                                        <div>
                                            <label class="text-xs text-gray-500 dark:text-gray-400">Membership Type</label>
                                            <input class="w-full px-2 py-1.5 text-sm border border-gray-200 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" type="text" id="membershipType" placeholder="OAS Membership">
                                        </div>
                                        <div>
                                            <label class="text-xs text-gray-500 dark:text-gray-400">Club State</label>
                                            <input class="w-full px-2 py-1.5 text-sm border border-gray-200 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" type="text" id="clubState" placeholder="CA" maxlength="2">
                                        </div>
                                        <div>
                                            <label class="text-xs text-gray-500 dark:text-gray-400">NFAA Member #</label>
                                            <input class="w-full px-2 py-1.5 text-sm border border-gray-200 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" type="text" id="nfaaMemberNo" placeholder="NFAA number">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Address -->
                                <div class="border-t border-gray-100 dark:border-gray-700 pt-2">
                                    <label class="text-xs text-gray-500 dark:text-gray-400 font-medium">Mailing Address</label>
                                    <div class="space-y-2 mt-1">
                                        <input class="w-full px-2 py-1.5 text-sm border border-gray-200 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" type="text" id="streetAddress" placeholder="Street Address">
                                        <input class="w-full px-2 py-1.5 text-sm border border-gray-200 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" type="text" id="streetAddress2" placeholder="Apt, Suite, Unit (optional)">
                                        <input class="w-full px-2 py-1.5 text-sm border border-gray-200 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" type="text" id="addressLine3" placeholder="Address Line 3 (optional)">
                                        <div class="grid grid-cols-3 gap-2">
                                            <input class="w-full px-2 py-1.5 text-sm border border-gray-200 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" type="text" id="city" placeholder="City">
                                            <input class="w-full px-2 py-1.5 text-sm border border-gray-200 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" type="text" id="state" placeholder="State" maxlength="2">
                                            <input class="w-full px-2 py-1.5 text-sm border border-gray-200 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" type="text" id="postalCode" placeholder="ZIP">
                                        </div>
                                        <div>
                                            <label class="text-xs text-gray-500 dark:text-gray-400">Country</label>
                                            <input class="w-full px-2 py-1.5 text-sm border border-gray-200 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" type="text" id="addressCountry" placeholder="USA" value="USA">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Disability & Camp -->
                                <div class="border-t border-gray-100 dark:border-gray-700 pt-2">
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label class="text-xs text-gray-500 dark:text-gray-400">Disability</label>
                                            <input class="w-full px-2 py-1.5 text-sm border border-gray-200 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" type="text" id="disability" placeholder="If applicable">
                                        </div>
                                        <div>
                                            <label class="text-xs text-gray-500 dark:text-gray-400">Camp Attendance</label>
                                            <select class="w-full px-2 py-1.5 text-sm border border-gray-200 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" id="campAttendance">
                                                <option value="">-</option>
                                                <option value="Y">Yes</option>
                                                <option value="N">No</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="text-xs text-gray-500 dark:text-gray-400">Disability List</label>
                                            <input class="w-full px-2 py-1.5 text-sm border border-gray-200 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" type="text" id="disabilityList" placeholder="Comma-separated options">
                                        </div>
                                        <div>
                                            <label class="text-xs text-gray-500 dark:text-gray-400">Military Service</label>
                                            <select class="w-full px-2 py-1.5 text-sm border border-gray-200 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" id="militaryService">
                                                <option value="No">No</option>
                                                <option value="Yes">Yes</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Additional Information -->
                                <div class="border-t border-gray-100 dark:border-gray-700 pt-2">
                                    <label class="text-xs text-gray-500 dark:text-gray-400 font-medium">Introduction Source</label>
                                    <div class="space-y-2 mt-1">
                                        <div>
                                            <label class="text-xs text-gray-500 dark:text-gray-400">Where were you introduced to archery?</label>
                                            <select class="w-full px-2 py-1.5 text-sm border border-gray-200 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" id="introductionSource">
                                                <option value="">-</option>
                                                <option value="Olympic Archery in the Schools (OAS)">Olympic Archery in the Schools (OAS)</option>
                                                <option value="Other">Other</option>
                                            </select>
                                        </div>
                                        <div id="introductionOtherWrapper" class="hidden">
                                            <label class="text-xs text-gray-500 dark:text-gray-400">Other Introduction Source</label>
                                            <input class="w-full px-2 py-1.5 text-sm border border-gray-200 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" type="text" id="introductionOther" placeholder="Specify other source">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- School Information -->
                                <div class="border-t border-gray-100 dark:border-gray-700 pt-2">
                                    <label class="text-xs text-gray-500 dark:text-gray-400 font-medium">School Information</label>
                                    <div class="grid grid-cols-2 gap-2 mt-1">
                                        <div>
                                            <label class="text-xs text-gray-500 dark:text-gray-400">School Type</label>
                                            <select class="w-full px-2 py-1.5 text-sm border border-gray-200 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" id="schoolType">
                                                <option value="">-</option>
                                                <option value="Elementary">Elementary</option>
                                                <option value="Middle">Middle</option>
                                                <option value="High" selected>High</option>
                                                <option value="College">College</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="text-xs text-gray-500 dark:text-gray-400">Full School Name</label>
                                            <input class="w-full px-2 py-1.5 text-sm border border-gray-200 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" type="text" id="schoolFullName" placeholder="Wiseburn Da Vinci High School">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </details>
                        ` : ''}
                    </div>
                `;
            }

            function setFormValue(form, id, value) {
                const el = form.querySelector(`#${id}`);
                if (!el) return;
                if (el.tagName === 'SELECT' || el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                    el.value = value != null ? value : '';
                }
            }

            /**
             * Store the original form state for change detection
             */
            function storeOriginalFormState(form) {
                const parseList = (value) => value
                    .split(/[,;]+/)
                    .map(s => s.trim())
                    .filter(Boolean);

                originalFormState = {
                    extId: form.querySelector('#extId')?.value.trim() || '',
                    first: form.querySelector('#first')?.value.trim() || '',
                    last: form.querySelector('#last')?.value.trim() || '',
                    nickname: form.querySelector('#nickname')?.value.trim() || '',
                    photoUrl: form.querySelector('#photoUrl')?.value.trim() || '',
                    school: form.querySelector('#school')?.value.trim() || '',
                    grade: form.querySelector('#grade')?.value || '',
                    status: form.querySelector('#status')?.value || '',
                    gender: form.querySelector('#gender')?.value || '',
                    level: form.querySelector('#level')?.value || '',
                    faves: parseList(form.querySelector('#faves')?.value || ''),
                    email: form.querySelector('#email')?.value.trim() || '',
                    phone: form.querySelector('#phone')?.value.trim() || '',
                    usArcheryId: form.querySelector('#usArcheryId')?.value.trim() || '',
                    jvPr: form.querySelector('#jvPr')?.value || '',
                    varPr: form.querySelector('#varPr')?.value || '',
                    shirtSize: form.querySelector('#shirtSize')?.value || '',
                    pantSize: form.querySelector('#pantSize')?.value.trim() || '',
                    hatSize: form.querySelector('#hatSize')?.value || '',
                    domEye: form.querySelector('#domEye')?.value || '',
                    domHand: form.querySelector('#domHand')?.value || '',
                    heightIn: form.querySelector('#heightIn')?.value || '',
                    wingspanIn: form.querySelector('#wingspanIn')?.value || '',
                    drawLengthSugg: form.querySelector('#drawLengthSugg')?.value || '',
                    riserHeightIn: form.querySelector('#riserHeightIn')?.value || '',
                    limbLength: form.querySelector('#limbLength')?.value || '',
                    limbWeightLbs: form.querySelector('#limbWeightLbs')?.value || '',
                    notesGear: form.querySelector('#notesGear')?.value.trim() || '',
                    notesCurrent: form.querySelector('#notesCurrent')?.value.trim() || '',
                    notesArchive: form.querySelector('#notesArchive')?.value.trim() || '',
                    dob: form.querySelector('#dob')?.value || '',
                    email2: form.querySelector('#email2')?.value.trim() || '',
                    nationality: form.querySelector('#nationality')?.value || '',
                    ethnicity: form.querySelector('#ethnicity')?.value || '',
                    discipline: form.querySelector('#discipline')?.value || '',
                    streetAddress: form.querySelector('#streetAddress')?.value.trim() || '',
                    streetAddress2: form.querySelector('#streetAddress2')?.value.trim() || '',
                    city: form.querySelector('#city')?.value.trim() || '',
                    state: form.querySelector('#state')?.value || '',
                    postalCode: form.querySelector('#postalCode')?.value.trim() || '',
                    addressCountry: form.querySelector('#addressCountry')?.value || '',
                    disability: form.querySelector('#disability')?.value || '',
                    campAttendance: form.querySelector('#campAttendance')?.value || '',
                    introductionSource: form.querySelector('#introductionSource')?.value || '',
                    introductionOther: form.querySelector('#introductionOther')?.value.trim() || '',
                    nfaaMemberNo: form.querySelector('#nfaaMemberNo')?.value.trim() || ''
                };
            }

            /**
             * Set up change tracking for form fields
             */
            function setupFormChangeTracking(form) {
                // Use a single delegated event listener for better performance
                const changeHandler = () => checkForChanges(form);

                // Remove any existing listeners by cloning the form (clean slate)
                // But preserve the form's innerHTML and re-attach listeners
                form.removeEventListener('input', changeHandler);
                form.removeEventListener('change', changeHandler);

                // Use event delegation on the form itself
                form.addEventListener('input', changeHandler, true);
                form.addEventListener('change', changeHandler, true);
            }

            /**
             * Check if form has unsaved changes
             * @param {HTMLFormElement} form - The form element to check
             * @returns {boolean} True if there are unsaved changes
             */
            function checkForChanges(form) {
                // If originalFormState hasn't been set yet, there can't be changes
                if (!originalFormState) {
                    hasUnsavedChanges = false;
                    return false;
                }

                const parseList = (value) => {
                    if (!value || typeof value !== 'string') return [];
                    return value
                        .split(/[,;]+/)
                        .map(s => s.trim())
                        .filter(Boolean);
                };

                // Normalize value for comparison (handle null, undefined, empty string consistently)
                const normalizeValue = (value) => {
                    if (value === null || value === undefined) return '';
                    return String(value).trim();
                };

                const currentState = {
                    extId: normalizeValue(form.querySelector('#extId')?.value),
                    first: normalizeValue(form.querySelector('#first')?.value),
                    last: normalizeValue(form.querySelector('#last')?.value),
                    nickname: normalizeValue(form.querySelector('#nickname')?.value),
                    photoUrl: normalizeValue(form.querySelector('#photoUrl')?.value),
                    school: normalizeValue(form.querySelector('#school')?.value),
                    grade: normalizeValue(form.querySelector('#grade')?.value),
                    status: normalizeValue(form.querySelector('#status')?.value),
                    gender: normalizeValue(form.querySelector('#gender')?.value),
                    level: normalizeValue(form.querySelector('#level')?.value),
                    faves: parseList(form.querySelector('#faves')?.value || ''),
                    email: normalizeValue(form.querySelector('#email')?.value),
                    phone: normalizeValue(form.querySelector('#phone')?.value),
                    usArcheryId: normalizeValue(form.querySelector('#usArcheryId')?.value),
                    jvPr: normalizeValue(form.querySelector('#jvPr')?.value),
                    varPr: normalizeValue(form.querySelector('#varPr')?.value),
                    shirtSize: normalizeValue(form.querySelector('#shirtSize')?.value),
                    pantSize: normalizeValue(form.querySelector('#pantSize')?.value),
                    hatSize: normalizeValue(form.querySelector('#hatSize')?.value),
                    domEye: normalizeValue(form.querySelector('#domEye')?.value),
                    domHand: normalizeValue(form.querySelector('#domHand')?.value),
                    heightIn: normalizeValue(form.querySelector('#heightIn')?.value),
                    wingspanIn: normalizeValue(form.querySelector('#wingspanIn')?.value),
                    drawLengthSugg: normalizeValue(form.querySelector('#drawLengthSugg')?.value),
                    riserHeightIn: normalizeValue(form.querySelector('#riserHeightIn')?.value),
                    limbLength: normalizeValue(form.querySelector('#limbLength')?.value),
                    limbWeightLbs: normalizeValue(form.querySelector('#limbWeightLbs')?.value),
                    notesGear: normalizeValue(form.querySelector('#notesGear')?.value),
                    notesCurrent: normalizeValue(form.querySelector('#notesCurrent')?.value),
                    notesArchive: normalizeValue(form.querySelector('#notesArchive')?.value),
                    dob: normalizeValue(form.querySelector('#dob')?.value),
                    email2: normalizeValue(form.querySelector('#email2')?.value),
                    nationality: normalizeValue(form.querySelector('#nationality')?.value),
                    ethnicity: normalizeValue(form.querySelector('#ethnicity')?.value),
                    discipline: normalizeValue(form.querySelector('#discipline')?.value),
                    streetAddress: normalizeValue(form.querySelector('#streetAddress')?.value),
                    streetAddress2: normalizeValue(form.querySelector('#streetAddress2')?.value),
                    city: normalizeValue(form.querySelector('#city')?.value),
                    state: normalizeValue(form.querySelector('#state')?.value),
                    postalCode: normalizeValue(form.querySelector('#postalCode')?.value),
                    addressCountry: normalizeValue(form.querySelector('#addressCountry')?.value),
                    disability: normalizeValue(form.querySelector('#disability')?.value),
                    campAttendance: normalizeValue(form.querySelector('#campAttendance')?.value),
                    introductionSource: normalizeValue(form.querySelector('#introductionSource')?.value),
                    introductionOther: normalizeValue(form.querySelector('#introductionOther')?.value),
                    nfaaMemberNo: normalizeValue(form.querySelector('#nfaaMemberNo')?.value)
                };

                // Normalize originalFormState values for comparison
                const normalizedOriginal = {};
                Object.keys(originalFormState).forEach(key => {
                    if (key === 'faves') {
                        normalizedOriginal[key] = originalFormState[key];
                    } else {
                        normalizedOriginal[key] = normalizeValue(originalFormState[key]);
                    }
                });

                // Compare arrays for faves
                const favesChanged = JSON.stringify(currentState.faves.sort()) !== JSON.stringify(normalizedOriginal.faves.sort());

                // Check all fields for changes (excluding faves which we already checked)
                hasUnsavedChanges = favesChanged || Object.keys(currentState).some(key => {
                    if (key === 'faves') return false; // Already checked
                    return currentState[key] !== normalizedOriginal[key];
                });

                // Set up/remove beforeunload handler
                if (hasUnsavedChanges && !beforeUnloadHandler) {
                    beforeUnloadHandler = (e) => {
                        e.preventDefault();
                        e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
                        return e.returnValue;
                    };
                    window.addEventListener('beforeunload', beforeUnloadHandler);
                } else if (!hasUnsavedChanges && beforeUnloadHandler) {
                    window.removeEventListener('beforeunload', beforeUnloadHandler);
                    beforeUnloadHandler = null;
                }

                return hasUnsavedChanges;
            }

            function closeModal() {
                // Check for unsaved changes (only if originalFormState has been set)
                const form = document.getElementById('archer-form');
                if (form && originalFormState && checkForChanges(form) && hasUnsavedChanges) {
                    const confirmed = confirm('You have unsaved changes. Are you sure you want to close without saving?');
                    if (!confirmed) {
                        return; // Don't close if user cancels
                    }
                }

                // Remove beforeunload handler
                if (beforeUnloadHandler) {
                    window.removeEventListener('beforeunload', beforeUnloadHandler);
                    beforeUnloadHandler = null;
                }

                // Reset change tracking
                originalFormState = null;
                hasUnsavedChanges = false;

                modal.classList.add('hidden');
                // Restore body scroll when modal is closed
                const scrollY = modal.dataset.scrollY || '0';
                document.body.style.position = '';
                document.body.style.top = '';
                document.body.style.width = '';
                document.body.style.overflow = '';
                // Restore scroll position
                window.scrollTo(0, parseInt(scrollY, 10));
            }

            function editArcher(index) {
                openModal(index);
            }

            addArcherBtn.onclick = () => openModal();

            // Handle setting self with success feedback and warning modal
            let pendingSelfChange = null;

            async function handleSetSelf(archer) {
                // Check if there's already a self selected
                const currentState = getRosterState();
                if (currentState.selfArcher && currentState.selfArcher.extId !== archer.extId) {
                    // Show warning modal
                    pendingSelfChange = archer;
                    const modal = document.getElementById('change-self-warning-modal');
                    const currentNameEl = document.getElementById('current-self-name');
                    if (modal && currentNameEl) {
                        currentNameEl.textContent = `${currentState.selfArcher.first} ${currentState.selfArcher.last}`;
                        modal.classList.remove('hidden');
                    }
                    return;
                }

                // No existing self or same archer, proceed directly
                await confirmSetSelf(archer);
            }

            async function confirmSetSelf(archer) {
                await ArcherModule.setSelf(archer.extId);

                // Show success feedback
                showSuccessFeedback(archer);

                // Hide "No Me Record" modal if shown
                const noMeRecordModal = document.getElementById('no-me-record-modal');
                if (noMeRecordModal) noMeRecordModal.classList.add('hidden');

                // Force refresh state and re-render to ensure badges are updated
                const freshState = getRosterState();
                renderList(freshState);

                // Clear pending change
                pendingSelfChange = null;
            }

            // Show delightful save success feedback
            function showSaveSuccess(message) {
                const successMsg = document.createElement('div');
                successMsg.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 z-50 px-6 py-4 bg-success text-white rounded-lg shadow-xl flex items-center gap-3';
                successMsg.style.animation = 'fadeIn 0.3s ease-in';
                successMsg.innerHTML = `
                    <i class="fas fa-check-circle text-2xl animate-bounce"></i>
                    <p class="font-semibold">${message}</p>
                `;
                document.body.appendChild(successMsg);

                setTimeout(() => {
                    successMsg.style.animation = 'fadeOut 0.3s ease-out';
                    successMsg.style.opacity = '0';
                    setTimeout(() => {
                        if (successMsg.parentNode) {
                            successMsg.parentNode.removeChild(successMsg);
                        }
                    }, 300);
                }, 2000);
            }

            // Show success feedback when user sets themselves
            function showSuccessFeedback(archer) {
                // Create temporary success message
                const successMsg = document.createElement('div');
                successMsg.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 z-50 px-6 py-4 bg-success text-white rounded-lg shadow-xl flex items-center gap-3 animate-bounce';
                successMsg.style.animation = 'fadeIn 0.3s ease-in';
                // Show nickname instead of first name if nickname exists
                const displayName = archer.nickname || archer.first || '';
                successMsg.innerHTML = `
                    <i class="fas fa-check-circle text-2xl"></i>
                    <div>
                        <p class="font-semibold">You've selected yourself!</p>
                        <p class="text-sm text-white/90">${displayName} ${archer.last || ''}</p>
                    </div>
                `;
                document.body.appendChild(successMsg);

                // Remove after 3 seconds with fade out
                setTimeout(() => {
                    successMsg.style.animation = 'fadeOut 0.3s ease-out';
                    successMsg.style.opacity = '0';
                    setTimeout(() => {
                        if (successMsg.parentNode) {
                            successMsg.parentNode.removeChild(successMsg);
                        }
                    }, 300);
                }, 3000);
            }


            // Note: "Edit My Profile" and "Clear Self" buttons removed from header
            // Users can edit their profile by clicking on their name in the list
            // Users can clear "Me" by clicking on their avatar/icon in the list

            // Handle modal overlay clicks and prevent background scrolling
            modal.addEventListener('click', (event) => {
                if (event.target === modal) {
                    closeModal();
                }
            });

            // Prevent touch events on background from scrolling the page
            // But allow scrolling within the form content
            modal.addEventListener('touchmove', (event) => {
                // Get the form element
                const form = document.getElementById('archer-form');

                // Check if touch is anywhere within the form or its children
                // This includes deeply nested elements like details, divs, inputs, etc.
                const isInForm = form && (
                    form === event.target ||
                    form.contains(event.target) ||
                    event.target.closest('#archer-form') === form ||
                    event.target.closest('form#archer-form') === form
                );

                // Allow scrolling if touch is on form or any of its children
                if (isInForm) {
                    return; // Allow normal scrolling - form can scroll
                }

                // Only prevent if touching the overlay background directly
                // This prevents background scrolling while allowing form scrolling
                if (event.target === modal || event.target === modal.querySelector('.bg-black\\/60')) {
                    event.preventDefault();
                }
            }, { passive: false });

            // Prevent wheel scrolling on overlay background only
            modal.addEventListener('wheel', (event) => {
                // Only prevent if scrolling on the overlay background itself
                const target = event.target;
                const form = document.getElementById('archer-form');
                const modalContent = modal.querySelector('.bg-white, .dark\\:bg-gray-800');

                // Allow scrolling if wheel is on form or modal content
                if (form && (form.contains(target) || form === target)) {
                    return; // Allow normal scrolling
                }
                if (modalContent && (modalContent.contains(target) || modalContent === target)) {
                    return; // Allow normal scrolling
                }

                // Only prevent if scrolling on overlay background
                if (target === modal) {
                    event.preventDefault();
                }
            }, { passive: false });

            document.getElementById('archer-form').onsubmit = async (e) => {
                e.preventDefault();
                const form = e.target;
                const parseList = (value) => value
                    .split(/[,;]+/)
                    .map(s => s.trim())
                    .filter(Boolean);

                const current = editingIndex !== null ? ArcherModule.loadList()[editingIndex] || {} : {};
                // Helper to safely get form value (handles coach-only fields that may not exist)
                const getVal = (id) => {
                    const el = form.querySelector(`#${id}`);
                    return el ? el.value.trim() : (current[id] || '');
                };

                const archer = {
                    extId: form.querySelector('#extId').value.trim(),
                    first: form.querySelector('#first').value.trim(),
                    last: form.querySelector('#last').value.trim(),
                    nickname: form.querySelector('#nickname').value.trim(),
                    photoUrl: form.querySelector('#photoUrl').value.trim(),
                    school: form.querySelector('#school').value.trim(),
                    grade: form.querySelector('#grade').value,
                    status: form.querySelector('#status').value,
                    gender: form.querySelector('#gender').value,
                    level: form.querySelector('#level').value,
                    faves: parseList(form.querySelector('#faves').value),
                    email: form.querySelector('#email').value.trim(),
                    phone: form.querySelector('#phone').value.trim(),
                    usArcheryId: form.querySelector('#usArcheryId').value.trim(),
                    jvPr: form.querySelector('#jvPr').value,
                    varPr: form.querySelector('#varPr').value,
                    shirtSize: form.querySelector('#shirtSize').value,
                    pantSize: form.querySelector('#pantSize').value.trim(),
                    hatSize: form.querySelector('#hatSize').value,
                    domEye: form.querySelector('#domEye').value,
                    domHand: form.querySelector('#domHand').value,
                    heightIn: form.querySelector('#heightIn').value,
                    wingspanIn: form.querySelector('#wingspanIn').value,
                    drawLengthSugg: form.querySelector('#drawLengthSugg').value,
                    riserHeightIn: form.querySelector('#riserHeightIn').value,
                    limbLength: form.querySelector('#limbLength').value,
                    limbWeightLbs: form.querySelector('#limbWeightLbs').value,
                    notesGear: form.querySelector('#notesGear').value,
                    notesCurrent: form.querySelector('#notesCurrent').value,
                    notesArchive: form.querySelector('#notesArchive').value,
                    // Extended profile fields (coach-only - safely get values)
                    dob: getVal('dob'),
                    email2: getVal('email2'),
                    nationality: getVal('nationality') || current.nationality || 'U.S.A.',
                    ethnicity: getVal('ethnicity'),
                    discipline: getVal('discipline'),
                    streetAddress: getVal('streetAddress'),
                    streetAddress2: getVal('streetAddress2'),
                    city: getVal('city'),
                    state: getVal('state'),
                    postalCode: getVal('postalCode'),
                    disability: getVal('disability'),
                    campAttendance: getVal('campAttendance'),
                    // USA Archery fields
                    validFrom: getVal('validFrom'),
                    clubState: getVal('clubState'),
                    membershipType: getVal('membershipType'),
                    addressCountry: getVal('addressCountry') || 'USA',
                    addressLine3: getVal('addressLine3'),
                    disabilityList: getVal('disabilityList'),
                    militaryService: getVal('militaryService') || 'No',
                    introductionSource: getVal('introductionSource'),
                    introductionOther: getVal('introductionOther'),
                    nfaaMemberNo: getVal('nfaaMemberNo'),
                    schoolType: getVal('schoolType'),
                    schoolFullName: getVal('schoolFullName'),
                    // Preserve legacy fields until dependent modules migrate
                    bale: current.bale || form.querySelector('#legacyBale').value || '',
                    target: current.target || form.querySelector('#legacyTarget').value || '',
                    size: current.size || form.querySelector('#legacySize').value || ''
                };

                if (!archer.first || !archer.last) {
                    alert('First and Last name are required.');
                    return;
                }

                try {
                    let result;
                    const state = getRosterState();
                    const isEditingSelf = editingIndex !== null && state.selfArcher &&
                        ArcherModule.loadList()[editingIndex]?.extId === state.selfArcher.extId;

                    if (editingIndex !== null) {
                        if (isEditingSelf) {
                            // Magical self-update - uses special endpoint that doesn't require auth!
                            const archerToUpdate = ArcherModule.loadList()[editingIndex];
                            const updatedArcher = Object.assign({}, archerToUpdate, archer, {
                                id: archerToUpdate.id || archerToUpdate.archerId,
                                extId: archerToUpdate.extId
                            });

                            // Update local storage first for instant feedback
                            const list = ArcherModule.loadList();
                            list[editingIndex] = Object.assign({}, list[editingIndex], updatedArcher);
                            ArcherModule.saveList(list);

                            // Show instant success feedback
                            showSaveSuccess('Profile updated! ✨');

                            // Sync to database in background (no auth needed!)
                            try {
                                result = await ArcherModule.updateSelfProfile(updatedArcher);
                                if (result && result.updated) {
                                    showSaveSuccess('Saved to database! 💾');
                                }
                            } catch (syncError) {
                                console.warn('Background sync failed (will retry):', syncError);
                                // Still show success - changes are saved locally
                            }
                        } else {
                            // Regular edit (requires auth)
                            result = await ArcherModule.editArcher(editingIndex, archer);

                            // Wait for sync to complete (it's async, so we need to await it)
                            let syncResult = result?.sync;
                            if (syncResult && typeof syncResult.then === 'function') {
                                try {
                                    syncResult = await syncResult;
                                } catch (syncError) {
                                    console.error('Sync error:', syncError);
                                    syncResult = { ok: false, error: syncError.message };
                                }
                            }

                            // Show visual feedback based on actual sync result
                            if (syncResult?.ok && syncResult.processed > 0 && syncResult.pending === 0) {
                                showSaveSuccess('Profile saved to database! 💾');
                            } else if (syncResult?.ok && syncResult.pending > 0) {
                                showSaveSuccess('Profile saved locally (syncing...) ⏳');
                            } else if (syncResult?.ok === false) {
                                console.warn('Sync failed:', syncResult);
                                const errorMsg = syncResult?.error || 'Unknown error';
                                if (errorMsg.includes('API key') || errorMsg.includes('auth') || errorMsg.includes('unauthorized')) {
                                    showSaveSuccess('Profile saved locally (coach API key needed for sync) 🔑');
                                } else {
                                    showSaveSuccess('Profile saved locally (offline - will retry) 📱');
                                }
                            } else {
                                showSaveSuccess('Profile updated! ✨');
                            }

                            recordSyncMessage(syncResult, 'Profile updated');
                        }
                    } else {
                        result = await ArcherModule.addArcher(archer);

                        // Wait for sync to complete (it's async, so we need to await it)
                        let syncResult = result?.sync;
                        if (syncResult && typeof syncResult.then === 'function') {
                            try {
                                syncResult = await syncResult;
                            } catch (syncError) {
                                console.error('Sync error:', syncError);
                                syncResult = { ok: false, error: syncError.message };
                            }
                        }

                        // Show visual feedback based on actual sync result
                        if (syncResult?.ok && syncResult.processed > 0 && syncResult.pending === 0) {
                            showSaveSuccess('Archer added to database! 💾');
                        } else if (syncResult?.ok && syncResult.pending > 0) {
                            showSaveSuccess('Archer saved locally (syncing...) ⏳');
                        } else if (syncResult?.ok === false) {
                            console.warn('Sync failed:', syncResult);
                            const errorMsg = syncResult?.error || 'Unknown error';
                            if (errorMsg.includes('API key') || errorMsg.includes('auth') || errorMsg.includes('unauthorized')) {
                                showSaveSuccess('Archer saved locally (coach API key needed for sync) 🔑');
                            } else {
                                showSaveSuccess('Archer saved locally (offline - will retry) 📱');
                            }
                        } else {
                            showSaveSuccess('Archer added! ✨');
                        }

                        recordSyncMessage(syncResult, 'Profile added');
                    }

                    // Reset change tracking after successful save
                    originalFormState = null;
                    hasUnsavedChanges = false;
                    if (beforeUnloadHandler) {
                        window.removeEventListener('beforeunload', beforeUnloadHandler);
                        beforeUnloadHandler = null;
                    }

                    // Update original state to current state (so further edits are tracked)
                    setTimeout(() => {
                        storeOriginalFormState(form);
                    }, 100);
                } catch (error) {
                    console.error('Failed to save archer:', error);
                    alert('Unable to save archer at this time. Changes are kept locally and will retry when online.');
                }
                renderList();
                // Keep modal open for easier editing
            };

            // Search input handlers
            const clearSearchBtn = document.getElementById('clear-search-btn');

            function updateClearButtonVisibility() {
                if (clearSearchBtn) {
                    const hasValue = searchInput.value.trim().length > 0;
                    if (hasValue) {
                        clearSearchBtn.classList.remove('hidden');
                    } else {
                        clearSearchBtn.classList.add('hidden');
                    }
                }
            }

            searchInput.oninput = () => {
                updateClearButtonVisibility();
                renderList();
            };

            if (clearSearchBtn) {
                clearSearchBtn.onclick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    searchInput.value = '';
                    updateClearButtonVisibility();
                    renderList();
                    searchInput.focus();
                };
            }

            // Initialize clear button visibility on page load
            updateClearButtonVisibility();

            // Warning modal handlers
            const changeSelfModal = document.getElementById('change-self-warning-modal');
            const cancelChangeSelfBtn = document.getElementById('cancel-change-self-btn');
            const confirmChangeSelfBtn = document.getElementById('confirm-change-self-btn');

            if (cancelChangeSelfBtn) {
                cancelChangeSelfBtn.onclick = () => {
                    if (changeSelfModal) changeSelfModal.classList.add('hidden');
                    pendingSelfChange = null;
                };
            }

            if (confirmChangeSelfBtn) {
                confirmChangeSelfBtn.onclick = async () => {
                    if (changeSelfModal) changeSelfModal.classList.add('hidden');
                    if (pendingSelfChange) {
                        await confirmSetSelf(pendingSelfChange);
                    }
                };
            }

            // Close modal on backdrop click
            if (changeSelfModal) {
                changeSelfModal.onclick = (e) => {
                    if (e.target === changeSelfModal) {
                        changeSelfModal.classList.add('hidden');
                        pendingSelfChange = null;
                    }
                };
            }
            statusFilter.onchange = () => renderList();
            schoolFilter.onchange = () => renderList();
            levelFilter.onchange = () => renderList();

            // Load/Refresh from MySQL
            loadFromMySQLBtn.onclick = async () => {
                try {
                    const archers = await ArcherModule.loadFromMySQL();
                    alert(`Refreshed! Loaded ${archers.length} archers from database.`);
                    lastSyncMessage = 'Roster refreshed';
                    populateSchoolFilter();
                    renderList();
                    updateSyncStatus();
                } catch (error) {
                    alert('Failed to refresh from database: ' + error.message + '\n\nEnter your coach API key or event code in Coach Console, then try again.');
                }
            };

            /**
             * Show/hide coach-only UI elements (Tailwind class toggles only).
             * @returns {void}
             */
            function updateCoachButtonsVisibility() {
                const isCoach = isCoachMode();
                const coachActionsBtn = document.getElementById('coach-actions-btn');
                if (coachActionsBtn) {
                    // Debug override: add ?showCoachActions=1 to force the Coach button visible.
                    // Use only for debugging; remove when confirmed.
                    const params = new URLSearchParams(window.location.search || '');
                    const debugShowCoachActions = params.get('showCoachActions') === '1';
                    coachActionsBtn.classList.toggle('hidden', !(isCoach || debugShowCoachActions));
                }

                // If coach logs out, ensure modal is closed.
                if (!isCoach) closeCoachActionsModal();
            }

            /**
             * Open the Coach Actions modal (action sheet).
             * Displays options for Import/Export USA Archery CSV and Export Roster.
             * Only accessible in coach mode.
             * @returns {void}
             */
            function openCoachActionsModal() {
                const modalEl = document.getElementById('coach-actions-modal');
                if (!modalEl) return;

                // Update "Delete Found Set" button text with count
                const deleteTextEl = document.getElementById('coach-action-delete-found-text');
                const deleteBtn = document.getElementById('coach-action-delete-found-btn');

                if (deleteTextEl && deleteBtn) {
                    const count = (typeof filteredArcherIndices !== 'undefined' && Array.isArray(filteredArcherIndices))
                        ? filteredArcherIndices.length
                        : 0;

                    deleteTextEl.textContent = `Delete Found Set (${count})`;

                    // Disable if 0
                    if (count === 0) {
                        deleteBtn.disabled = true;
                        deleteBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    } else {
                        deleteBtn.disabled = false;
                        deleteBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                }

                console.log('[Coach Actions Modal] Opening');
                modalEl.classList.remove('hidden');
            }

            /**
             * Close the Coach Actions modal.
             * Hides the action sheet overlay.
             * @returns {void}
             */
            function closeCoachActionsModal() {
                const modalEl = document.getElementById('coach-actions-modal');
                if (!modalEl) return;
                console.log('[Coach Actions Modal] Closing');
                modalEl.classList.add('hidden');
            }

            // Coach Actions button (opens action sheet)
            const coachActionsBtn = document.getElementById('coach-actions-btn');
            if (coachActionsBtn) {
                coachActionsBtn.onclick = () => {
                    console.log('[Coach Actions] Open requested');
                    openCoachActionsModal();
                };
            }

            // Debug helper: add ?openCoachActions=1 to auto-open the coach actions modal on load.
            try {
                const params = new URLSearchParams(window.location.search || '');
                if (params.get('openCoachActions') === '1') {
                    setTimeout(() => {
                        console.log('[Coach Actions] Auto-open via openCoachActions=1');
                        openCoachActionsModal();
                    }, 50);
                }
            } catch (_) { }

            // Close handlers (X button + backdrop)
            const coachActionsModal = document.getElementById('coach-actions-modal');
            const closeCoachActionsBtn = document.getElementById('close-coach-actions-btn');
            if (closeCoachActionsBtn) closeCoachActionsBtn.onclick = () => closeCoachActionsModal();
            if (coachActionsModal) {
                coachActionsModal.onclick = (e) => {
                    if (e.target === coachActionsModal) closeCoachActionsModal();
                };
            }
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeCoachActionsModal();
            });

            // Coach Actions: Export Roster
            const coachActionExportRosterBtn = document.getElementById('coach-action-export-roster-btn');
            if (coachActionExportRosterBtn) {
                coachActionExportRosterBtn.onclick = () => {
                    closeCoachActionsModal();
                    if (typeof ArcherModule.exportCoachRosterCSV === 'function') {
                        // Get filtered archers based on current view and filters
                        const filteredArchers = getFilteredArchers();
                        if (filteredArchers.length === 0) {
                            alert('No archers match the current filters. Please adjust your search or filters.');
                            return;
                        }
                        ArcherModule.exportCoachRosterCSV(filteredArchers);
                    } else {
                        alert('Export function not available.');
                    }
                };
            }

            // Coach Actions: Export Roster Simple
            const coachActionExportRosterSimpleBtn = document.getElementById('coach-action-export-roster-simple-btn');
            if (coachActionExportRosterSimpleBtn) {
                coachActionExportRosterSimpleBtn.onclick = () => {
                    closeCoachActionsModal();
                    // Check if function exists (with fallback for cache issues)
                    if (typeof ArcherModule !== 'undefined' && typeof ArcherModule.exportCoachRosterSimpleCSV === 'function') {
                        // Get filtered archers based on current view and filters
                        const filteredArchers = getFilteredArchers();
                        if (filteredArchers.length === 0) {
                            alert('No archers match the current filters. Please adjust your search or filters.');
                            return;
                        }
                        try {
                            ArcherModule.exportCoachRosterSimpleCSV(filteredArchers);
                        } catch (error) {
                            console.error('Export Coach Roster Simple failed:', error);
                            alert('Failed to export: ' + error.message + '\n\nPlease refresh the page and try again.');
                        }
                    } else {
                        console.error('Export Coach Roster Simple function not available. ArcherModule:', typeof ArcherModule, 'Function:', typeof ArcherModule?.exportCoachRosterSimpleCSV);
                        alert('Export function not available. Please do a hard refresh (Ctrl+Shift+R or Cmd+Shift+R) to reload the JavaScript files.');
                    }
                };
            }

            // Coach Actions: USA Archery Import
            const coachActionImportUSABtn = document.getElementById('coach-action-import-usa-btn');
            if (coachActionImportUSABtn) {
                coachActionImportUSABtn.onclick = async () => {
                    closeCoachActionsModal();
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.csv';
                    input.onchange = async (e) => {
                        const file = e.target.files && e.target.files[0];
                        if (!file) return;
                        try {
                            const text = await file.text();
                            if (typeof ArcherModule.importUSAArcheryCSV === 'function') {
                                const result = ArcherModule.importUSAArcheryCSV(text);
                                if (result && result.errors && result.errors.length > 0) {
                                    alert('Import completed with errors:\n' + result.errors.join('\n'));
                                } else {
                                    alert(`Successfully imported ${result.list.length} archer(s).`);
                                }
                                renderList();
                            } else {
                                alert('Import function not available.');
                            }
                        } catch (err) {
                            console.error('Import failed:', err);
                            alert('Error importing CSV: ' + err.message);
                        }
                    };
                    input.click();
                };
            }

            // Coach Actions: Export Shirt Order
            const coachActionExportShirtOrderBtn = document.getElementById('coach-action-export-shirt-order-btn');
            if (coachActionExportShirtOrderBtn) {
                coachActionExportShirtOrderBtn.onclick = async () => {
                    closeCoachActionsModal();
                    if (typeof ArcherModule.exportShirtOrderCSV === 'function') {
                        try {
                            // Get filtered archers based on current view and filters
                            const filteredArchers = getFilteredArchers();
                            if (filteredArchers.length === 0) {
                                alert('No archers match the current filters. Please adjust your search or filters.');
                                return;
                            }
                            await ArcherModule.exportShirtOrderCSV(filteredArchers);
                        } catch (error) {
                            console.error('Export failed:', error);
                            alert('Failed to export shirt order: ' + error.message);
                        }
                    } else {
                        alert('Export function not available.');
                    }
                };
            }

            // Coach Actions: USA Archery Export
            const coachActionExportUSABtn = document.getElementById('coach-action-export-usa-btn');
            if (coachActionExportUSABtn) {
                coachActionExportUSABtn.onclick = () => {
                    closeCoachActionsModal();
                    if (typeof ArcherModule.exportUSAArcheryCSV === 'function') {
                        // Get filtered archers based on current view and filters
                        const filteredArchers = getFilteredArchers();
                        if (filteredArchers.length === 0) {
                            alert('No archers match the current filters. Please adjust your search or filters.');
                            return;
                        }
                        ArcherModule.exportUSAArcheryCSV(filteredArchers);
                    } else {
                        alert('Export function not available.');
                    }
                };
            }

            // Coach Actions: Delete Found Set
            const coachActionDeleteFoundBtn = document.getElementById('coach-action-delete-found-btn');
            if (coachActionDeleteFoundBtn) {
                coachActionDeleteFoundBtn.onclick = async () => {
                    const count = (typeof filteredArcherIndices !== 'undefined' && Array.isArray(filteredArcherIndices))
                        ? filteredArcherIndices.length
                        : 0;

                    if (count === 0) return;

                    if (confirm(`DANGER: You are about to DELETE ${count} archers!\n\nThis includes ALL archers currently visible in the list.\n\nAre you ABSOLUTELY SURE?`)) {
                        // Double confirmation for bulk delete
                        if (confirm(`Please confirm one more time.\n\nDelete ${count} archers permanently?`)) {
                            closeCoachActionsModal();

                            try {
                                // Get IDs from indices
                                // We need to map indices back to archer objects
                                // The filteredArcherIndices are indices into the *full list* ? 
                                // Let's verify how renderList populates it.
                                // line 637: filteredArcherIndices = items.map(item => item.index);
                                // item.index is index in the FULL list.

                                const fullList = ArcherModule.loadList();
                                const idsToDelete = filteredArcherIndices.map(idx => fullList[idx]?.id).filter(Boolean);

                                if (idsToDelete.length === 0) {
                                    alert('No valid archer IDs found to delete.');
                                    return;
                                }

                                const deletedCount = await ArcherModule.deleteArchersByIds(idsToDelete);
                                alert(`Successfully deleted ${deletedCount} archers.`);

                                // Clear search to show remaining or empty
                                // searchInput.value = ''; // Optional: maybe we want to keep invalid filter? No, reload list.
                                renderList();
                            } catch (err) {
                                console.error('Bulk delete failed:', err);
                                alert('Bulk delete failed: ' + err.message);
                            }
                        }
                    }
                };
            }

            // Initial visibility check (with delay to ensure DOM is ready)
            setTimeout(() => {
                updateCoachButtonsVisibility();
            }, 100);

            // Also check immediately
            updateCoachButtonsVisibility();

            // Re-check visibility when page gains focus (in case coach logged in another tab)
            window.addEventListener('focus', updateCoachButtonsVisibility);
            window.addEventListener('storage', updateCoachButtonsVisibility); // Listen for localStorage changes

            // Make function available globally for debugging
            window.updateCoachButtonsVisibility = updateCoachButtonsVisibility;

            sortByNameBtn.onclick = () => {
                // A-Z button always sorts by first name ascending (already the default)
                renderList();
            };

            showFavoritesBtn.onclick = () => {
                showFavoritesOnly = !showFavoritesOnly;
                if (showFavoritesOnly) {
                    showFavoritesBtn.className = 'px-4 py-2 bg-gray-400 dark:bg-gray-600 text-white rounded font-semibold hover:bg-gray-500 dark:hover:bg-gray-500 transition-colors min-h-[44px] flex items-center justify-center';
                } else {
                    showFavoritesBtn.className = 'px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors min-h-[44px] flex items-center justify-center';
                }
                renderList();
            };

            /**
             * Update gender filter button styling based on current filter value.
             * @returns {void}
             */
            function updateGenderFilterButton() {
                if (!genderFilterBtn) return;
                if (genderFilterValue === 'all') {
                    genderFilterBtn.className = 'px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors min-h-[44px] min-w-[44px] flex items-center justify-center';
                    genderFilterBtn.title = 'Filter by Gender (All)';
                } else if (genderFilterValue === 'M') {
                    genderFilterBtn.className = 'px-4 py-2 bg-blue-400 dark:bg-blue-600 text-white rounded font-semibold hover:bg-blue-500 dark:hover:bg-blue-500 transition-colors min-h-[44px] min-w-[44px] flex items-center justify-center';
                    genderFilterBtn.title = 'Filter by Gender (Male)';
                } else if (genderFilterValue === 'F') {
                    genderFilterBtn.className = 'px-4 py-2 bg-pink-400 dark:bg-pink-600 text-white rounded font-semibold hover:bg-pink-500 dark:hover:bg-pink-500 transition-colors min-h-[44px] min-w-[44px] flex items-center justify-center';
                    genderFilterBtn.title = 'Filter by Gender (Female)';
                }
            }

            genderFilterBtn.onclick = () => {
                // Cycle through: all -> M -> F -> all
                if (genderFilterValue === 'all') {
                    genderFilterValue = 'M';
                } else if (genderFilterValue === 'M') {
                    genderFilterValue = 'F';
                } else {
                    genderFilterValue = 'all';
                }
                updateGenderFilterButton();
                renderList();
            };

            // Initialize gender filter button styling
            updateGenderFilterButton();

            shirtSizesBtn.onclick = () => {
                if (viewMode === 'shirtSizes') {
                    viewMode = 'list';
                    shirtSizesBtn.className = 'px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors min-h-[44px] min-w-[44px] flex items-center justify-center';
                } else {
                    viewMode = 'shirtSizes';
                    shirtSizesBtn.className = 'px-4 py-2 bg-gray-400 dark:bg-gray-600 text-white rounded font-semibold hover:bg-gray-500 dark:hover:bg-gray-500 transition-colors min-h-[44px] min-w-[44px] flex items-center justify-center';
                }
                renderList();
            };

            // No "Me" Record Modal Handler
            const noMeRecordModal = document.getElementById('no-me-record-modal');
            const closeNoMeModalBtn = document.getElementById('close-no-me-modal-btn');

            if (closeNoMeModalBtn) {
                closeNoMeModalBtn.onclick = () => {
                    if (noMeRecordModal) noMeRecordModal.classList.add('hidden');
                };
            }

            // Close modal on backdrop click
            if (noMeRecordModal) {
                noMeRecordModal.onclick = (e) => {
                    if (e.target === noMeRecordModal) {
                        noMeRecordModal.classList.add('hidden');
                    }
                };
            }

            function checkAndShowNoMeModal() {
                const state = getRosterState();
                if (!state.selfArcher && noMeRecordModal) {
                    // Check if modal was already dismissed in this session
                    const dismissed = sessionStorage.getItem('no-me-record-modal-dismissed') === 'true';
                    if (!dismissed) {
                        noMeRecordModal.classList.remove('hidden');
                    }
                } else if (noMeRecordModal) {
                    noMeRecordModal.classList.add('hidden');
                }
            }

            // Update close button to also set session storage
            if (closeNoMeModalBtn) {
                const originalHandler = closeNoMeModalBtn.onclick;
                closeNoMeModalBtn.onclick = () => {
                    sessionStorage.setItem('no-me-record-modal-dismissed', 'true');
                    if (noMeRecordModal) noMeRecordModal.classList.add('hidden');
                };
            }

            (async function init() {
                // Try to load from MySQL first to ensure we have UUIDs
                try {
                    console.log('Auto-loading archer list from MySQL...');
                    const archers = await ArcherModule.loadFromMySQL();
                    console.log(`Loaded ${archers.length} archers from MySQL with UUIDs`);
                    lastSyncMessage = 'Auto-loaded from server';
                } catch (err) {
                    console.warn('Failed to auto-load from MySQL, falling back to local/CSV:', err);
                    await ArcherModule.loadDefaultCSVIfNeeded();
                }

                populateSchoolFilter();
                renderList();

                // Check and show modal if no "Me" record
                checkAndShowNoMeModal();

                try {
                    await ArcherModule.flushPending();
                } catch (err) {
                    console.warn('Initial sync flush failed:', err);
                }
                updateSyncStatus();
            })();
        });
    </script>
</body>

</html>