<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Archer List</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
    <link rel="stylesheet" href="css/tailwind-compiled.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    <style>
        /* Legacy archer row styling - kept for backward compatibility */
        /* TODO: Convert to pure Tailwind classes in renderList() function */
        .archer-select-row {
            display: flex;
            align-items: center;
            padding: 0.8rem 0.4rem;
            border-bottom: 1px solid #f0f2f5;
            cursor: pointer;
            background-color: white;
            transition: background-color 0.2s;
        }
        .dark .archer-select-row {
            border-bottom: 1px solid #374151;
            background-color: #1f2937;
        }
        .archer-select-row:hover {
            background-color: #f8f9fa;
        }
        .dark .archer-select-row:hover {
            background-color: #374151;
        }
        .archer-name-label {
            font-size: 1.1em;
            font-weight: 500;
            color: #1f2937;
        }
        .dark .archer-name-label {
            color: #f9fafb;
        }
        .archer-details-label {
            font-size: 0.9em;
            color: #6c757d;
        }
        .dark .archer-details-label {
            color: #9ca3af;
        }
        .favorite-star {
            font-size: 1.4em;
            margin-right: 0.8rem;
            min-width: 1.2em;
            text-align: center;
            cursor: pointer;
        }
        /* Success feedback animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translate(-50%, -10px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: translate(-50%, 0); }
            to { opacity: 0; transform: translate(-50%, -10px); }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen transition-colors duration-200">
    <div id="app-container" class="flex flex-col min-h-screen">

        <header class="px-4 py-3 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 transition-colors duration-200 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800 dark:text-white">Archer List</h1>
        </header>

        <!-- Prominent Banner when "You: Not set" -->
        <div id="select-yourself-banner" class="hidden px-4 py-4 bg-gradient-to-r from-primary to-primary-dark dark:from-primary dark:to-primary-dark text-white shadow-lg">
            <div class="flex items-center gap-3">
                <div class="flex-shrink-0">
                    <i class="fas fa-user-circle text-3xl"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <h3 class="font-bold text-lg mb-1">Select Yourself to Get Started</h3>
                    <p class="text-sm text-white/90">Tap your avatar or name in the list below to set yourself as the archer using this device.</p>
                </div>
                <button id="dismiss-banner-btn" class="flex-shrink-0 px-3 py-2 bg-white/20 hover:bg-white/30 rounded-lg transition-colors min-h-[44px] min-w-[44px] flex items-center justify-center" title="Dismiss">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <div class="px-4 py-3 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 flex gap-2 transition-colors duration-200">
            <div class="flex-1 relative">
                <input class="w-full px-3 py-2 pr-10 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary transition-colors" type="text" id="search-input" placeholder="Find an Archer">
                <button id="clear-search-btn" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors w-6 h-6 flex items-center justify-center hidden z-10" title="Clear search">
                    <i class="fas fa-times text-sm"></i>
                </button>
            </div>
            <button id="add-archer-btn" class="px-4 py-2 bg-primary hover:bg-primary-dark text-white rounded font-semibold transition-colors min-h-[44px]"><i class="fas fa-plus"></i> Add</button>
        </div>
        
        <!-- Enhanced Summary Bar -->
        <div id="self-summary-container" class="px-4 py-3 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 transition-colors duration-200">
            <div id="self-summary-not-set" class="hidden">
                <div class="flex items-center gap-3">
                    <div class="flex-shrink-0">
                        <div class="w-12 h-12 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center">
                            <i class="fas fa-user text-gray-400 dark:text-gray-500 text-xl"></i>
                        </div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-semibold text-gray-700 dark:text-gray-300">You: Not set</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Select yourself from the list below</p>
                    </div>
                    <button id="select-yourself-btn" class="px-4 py-2 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold text-sm transition-colors min-h-[44px] flex items-center gap-2">
                        <i class="fas fa-user-check"></i>
                        <span class="hidden sm:inline">Select Yourself</span>
                        <span class="sm:hidden">Select</span>
                    </button>
                </div>
            </div>
            <div id="self-summary-set" class="hidden">
                <div class="flex items-center gap-3">
                    <div id="self-avatar-container" class="flex-shrink-0">
                        <!-- Avatar will be injected here -->
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 flex-wrap">
                            <p id="self-name-text" class="text-base font-semibold text-gray-900 dark:text-white"></p>
                            <span class="px-2 py-0.5 bg-primary/10 dark:bg-primary/20 text-primary dark:text-primary-light text-xs font-semibold rounded-full uppercase tracking-wide">You</span>
                        </div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">Tap your avatar in the list to change</p>
                    </div>
                    <button id="clear-self-btn" class="px-3 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg text-sm font-medium hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors min-h-[44px]">
                        <i class="fas fa-times mr-1"></i>
                        <span class="hidden sm:inline">Clear</span>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="px-4 py-2 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 flex gap-2 flex-wrap transition-colors duration-200">
            <button id="sort-by-name-btn" class="px-4 py-2 bg-gray-400 dark:bg-gray-600 text-white rounded font-semibold hover:bg-gray-500 dark:hover:bg-gray-500 transition-colors min-h-[44px]">Sort A-Z</button>
            <button id="sort-by-level-btn" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors min-h-[44px]">Sort by Level</button>
            <select id="status-filter" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors min-w-[140px] min-h-[44px] cursor-pointer">
                <option value="active">Active Only</option>
                <option value="all">All Statuses</option>
                <option value="inactive">Inactive Only</option>
            </select>
        </div>

        <div id="archer-list-container" class="flex-1 px-2 pb-[calc(36px+env(safe-area-inset-bottom)+24px)] overflow-y-auto bg-white dark:bg-gray-800 transition-colors duration-200">
            <!-- Archer list will be rendered here -->
        </div>

        <!-- Sync Status Bar (above footer) -->
        <div class="fixed bottom-[36px] left-0 right-0 px-4 py-1 text-xs text-gray-600 dark:text-gray-400 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 z-10">
            <div id="sync-status"></div>
        </div>

        <footer class="fixed bottom-0 left-0 right-0 h-[36px] bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 shadow-lg transition-colors duration-200 z-10 safe-bottom">
            <div class="flex items-center h-full px-4">
                <a href="index.html" class="pl-3 text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white transition-colors flex items-center justify-center" aria-label="Home">
                    <i class="fas fa-home text-lg"></i>
                </a>
                <div class="flex-1"></div>
                <button id="load-from-mysql-btn" class="px-2 py-[2px] h-[44px] bg-primary hover:bg-primary-dark text-white rounded font-semibold transition-colors flex items-center justify-center">
                    <i class="fas fa-sync-alt mr-1"></i>Refresh
                </button>
            </div>
        </footer>

    </div>

    <!-- Add/Edit Archer Modal -->
    <div id="archer-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto transition-colors duration-200">
            <div class="sticky top-0 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-6 py-4 z-10">
                <div class="flex justify-between items-center">
                    <h2 id="modal-title" class="text-2xl font-bold text-gray-800 dark:text-white">Add Archer</h2>
                    <div id="archer-navigation" class="hidden flex gap-2">
                        <button type="button" id="prev-archer-btn" class="px-3 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors" title="Previous archer">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span id="archer-position" class="px-3 py-2 text-sm text-gray-600 dark:text-gray-400">1 of 25</span>
                        <button type="button" id="next-archer-btn" class="px-3 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors" title="Next archer">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
            <form id="archer-form" class="p-6">
                <!-- Form content will be injected by JS -->
            </form>
        </div>
    </div>

    <!-- Warning Modal for Changing "You" Setting -->
    <div id="change-self-warning-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[70] hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full transition-colors duration-200">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-white flex items-center gap-2">
                    <i class="fas fa-exclamation-triangle text-yellow-500"></i>
                    Change "Who am I"?
                </h3>
            </div>
            <div class="px-6 py-4">
                <p class="text-gray-700 dark:text-gray-300 mb-4">
                    You already have yourself set as <strong id="current-self-name" class="text-gray-900 dark:text-white"></strong>.
                </p>
                <p class="text-gray-700 dark:text-gray-300 mb-4">
                    Are you sure you want to change this to a different archer?
                </p>
            </div>
            <div class="flex gap-3 px-6 py-4 border-t border-gray-200 dark:border-gray-700">
                <button id="cancel-change-self-btn" class="flex-1 px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors min-h-[44px]">Cancel</button>
                <button id="confirm-change-self-btn" class="flex-1 px-4 py-2 bg-primary hover:bg-primary-dark text-white rounded font-semibold transition-colors min-h-[44px]">Yes, Change It</button>
            </div>
        </div>
    </div>

    <!-- Image Crop Modal -->
    <div id="crop-modal" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center p-4 z-[60] hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full transition-colors duration-200">
            <div class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-6 py-4">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-white">Crop Photo</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Adjust the crop area to focus on the face</p>
            </div>
            <div class="p-6">
                <div class="max-h-[60vh] overflow-hidden bg-gray-100 dark:bg-gray-900 rounded">
                    <img id="crop-image" src="" alt="Crop preview" class="max-w-full">
                </div>
            </div>
            <div class="flex gap-3 px-6 py-4 border-t border-gray-200 dark:border-gray-700">
                <button type="button" id="cancel-crop-btn" class="flex-1 px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors min-h-[44px]">Cancel</button>
                <button type="button" id="apply-crop-btn" class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white rounded font-semibold transition-colors min-h-[44px]">
                    <i class="fas fa-crop mr-2"></i>Crop & Upload
                </button>
            </div>
        </div>
    </div>

    <script src="js/common.js"></script>
    <script src="js/live_updates.js"></script>
    <script src="js/archer_module.js"></script>
    <script>
        // Initialize dark mode immediately (before DOMContentLoaded) to prevent flash
        // Dark mode preference is set from the home screen (index.html)
        initDarkMode();
        
        document.addEventListener('DOMContentLoaded', () => {
            const SCHOOL_EMAIL_DOMAIN = '@student.davincischools.org';
            const modal = document.getElementById('archer-modal');
            const addArcherBtn = document.getElementById('add-archer-btn');
            const searchInput = document.getElementById('search-input');
            const statusFilter = document.getElementById('status-filter');
            const loadFromMySQLBtn = document.getElementById('load-from-mysql-btn');
            const sortByNameBtn = document.getElementById('sort-by-name-btn');
            const sortByLevelBtn = document.getElementById('sort-by-level-btn');
            const clearSelfBtn = document.getElementById('clear-self-btn');

            let editingIndex = null;
            let sortMode = 'name'; // 'name' or 'level'
            let lastSyncMessage = '';
            let filteredArcherIndices = []; // For navigation

            function formatTimestamp(ts) {
                if (!ts) return 'Never';
                try {
                    const date = new Date(ts);
                    if (Number.isNaN(date.getTime())) return 'Never';
                    return `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
                } catch {
                    return 'Never';
                }
            }

            function updateSyncStatus(extraMessage) {
                const statusEl = document.getElementById('sync-status');
                if (!statusEl) return;
                const meta = (typeof ArcherModule.getMeta === 'function') ? ArcherModule.getMeta() : {};
                const pending = (typeof ArcherModule.getPendingCount === 'function') ? ArcherModule.getPendingCount() : 0;
                const parts = [];
                if (meta.lastSyncedAt) parts.push(`Last sync: ${formatTimestamp(meta.lastSyncedAt)}`);
                if (meta.lastFetchedAt) parts.push(`Last download: ${formatTimestamp(meta.lastFetchedAt)}`);
                parts.push(pending ? `${pending} change${pending === 1 ? '' : 's'} pending` : 'All changes synced');
                if (lastSyncMessage) parts.push(lastSyncMessage);
                if (extraMessage) parts.push(extraMessage);
                statusEl.textContent = parts.join(' • ');
            }

            function recordSyncMessage(summary, actionLabel) {
                if (!summary) {
                    lastSyncMessage = '';
                    updateSyncStatus();
                    return;
                }
                if (summary.ok) {
                    if (summary.processed > 0 && summary.pending === 0) {
                        lastSyncMessage = `${actionLabel} synced`;
                    } else if (summary.pending > 0) {
                        lastSyncMessage = 'Changes queued (offline)';
                    } else {
                        lastSyncMessage = '';
                    }
                } else {
                    lastSyncMessage = 'Offline – will retry automatically';
                }
                updateSyncStatus();
            }

            function getRosterState() {
                const list = ArcherModule.loadList();
                const extId = (typeof ArcherModule.getSelfExtId === 'function') ? ArcherModule.getSelfExtId() : '';
                let selfArcher = null;
                let selfExtId = extId;
                if (extId) {
                    selfArcher = list.find(a => a.extId === extId) || null;
                    if (!selfArcher) {
                        selfExtId = '';
                        if (typeof ArcherModule.clearSelf === 'function') ArcherModule.clearSelf();
                    }
                }
                const friendSet = new Set((selfArcher?.faves || []).filter(Boolean));
                return { list, selfExtId, selfArcher, friendSet };
            }

            function refreshSelfSummary(stateOverride) {
                const state = stateOverride || getRosterState();
                const banner = document.getElementById('select-yourself-banner');
                const summaryNotSet = document.getElementById('self-summary-not-set');
                const summarySet = document.getElementById('self-summary-set');
                const selfNameText = document.getElementById('self-name-text');
                const selfAvatarContainer = document.getElementById('self-avatar-container');
                
                if (state.selfArcher) {
                    // Hide banner, show "set" summary
                    if (banner) banner.classList.add('hidden');
                    if (summaryNotSet) summaryNotSet.classList.add('hidden');
                    if (summarySet) summarySet.classList.remove('hidden');
                    
                    // Update name
                    const nickname = state.selfArcher.nickname ? ` "${state.selfArcher.nickname}"` : '';
                    if (selfNameText) {
                        selfNameText.textContent = `${state.selfArcher.first} ${state.selfArcher.last}${nickname}`;
                    }
                    
                    // Update avatar
                    if (selfAvatarContainer) {
                        selfAvatarContainer.innerHTML = '';
                        const avatarDiv = document.createElement('div');
                        avatarDiv.className = 'w-12 h-12 rounded-full overflow-hidden bg-gray-200 dark:bg-gray-700 flex items-center justify-center';
                        
                        if (state.selfArcher.photoUrl) {
                            const img = document.createElement('img');
                            img.src = state.selfArcher.photoUrl;
                            img.alt = `${state.selfArcher.first} ${state.selfArcher.last}`;
                            img.className = 'w-full h-full object-cover';
                            avatarDiv.appendChild(img);
                        } else {
                            const initials = `${(state.selfArcher.first || '?').charAt(0)}${(state.selfArcher.last || '').charAt(0)}`.toUpperCase();
                            avatarDiv.innerHTML = `<span class="text-gray-600 dark:text-gray-300 font-bold text-sm">${initials}</span>`;
                        }
                        selfAvatarContainer.appendChild(avatarDiv);
                    }
                } else {
                    // Show banner, show "not set" summary
                    const bannerDismissed = localStorage.getItem('select-yourself-banner-dismissed') === 'true';
                    if (banner && !bannerDismissed) {
                        banner.classList.remove('hidden');
                    } else if (banner) {
                        banner.classList.add('hidden');
                    }
                    if (summaryNotSet) summaryNotSet.classList.remove('hidden');
                    if (summarySet) summarySet.classList.add('hidden');
                }
            }

            function renderList(stateOverride) {
                if (stateOverride && stateOverride.target) {
                    stateOverride = null;
                }
                const container = document.getElementById('archer-list-container');
                const filter = searchInput.value.toLowerCase();
                container.innerHTML = '';

                const state = stateOverride || getRosterState();
                const { list, selfExtId, friendSet } = state;

                let items = list.map((archer, index) => ({ archer, index }));

                const statusValue = statusFilter.value;
                if (statusValue !== 'all') {
                    items = items.filter(item => (item.archer.status || 'active').toLowerCase() === statusValue);
                }

                if (filter) {
                    items = items.filter(({ archer }) =>
                        `${archer.first} ${archer.last}`.toLowerCase().includes(filter) ||
                        (archer.nickname || '').toLowerCase().includes(filter) ||
                        (archer.school || '').toLowerCase().includes(filter)
                    );
                }

                items.sort((a, b) => {
                    const priority = (item) => {
                        if (selfExtId && item.archer.extId === selfExtId) return 0;
                        if (friendSet.has(item.archer.extId)) return 1;
                        return 2;
                    };
                    const aP = priority(a);
                    const bP = priority(b);
                    if (aP !== bP) return aP - bP;

                    if (sortMode === 'level') {
                        const levelOrder = ['VAR', 'JV', 'BEG'];
                        const levelA = (a.archer.level || '').toUpperCase();
                        const levelB = (b.archer.level || '').toUpperCase();
                        const levelCompare = levelOrder.indexOf(levelA) - levelOrder.indexOf(levelB);
                        if (levelCompare !== 0) return levelCompare;
                    }

                    const nameA = `${a.archer.first} ${a.archer.last}`.toLowerCase();
                    const nameB = `${b.archer.first} ${b.archer.last}`.toLowerCase();
                    return nameA.localeCompare(nameB);
                });

                if (items.length === 0) {
                    container.innerHTML = '<p style="text-align:center; padding: 20px; color: #6c757d;">No archers found.</p>';
                    return;
                }

                // Store filtered indices for navigation
                filteredArcherIndices = items.map(item => item.index);

                items.forEach(({ archer, index }) => {
                    const row = document.createElement('div');
                    row.className = 'archer-select-row';

                    const isSelf = !!selfExtId && archer.extId === selfExtId;
                    const isFriend = friendSet.has(archer.extId);
                    
                    // Only show plus badges if NO self is selected at all
                    const showPlusBadge = !selfExtId && !isSelf;

                    // Avatar OR Icon (show avatar if photo exists, otherwise show icon)
                    const avatarOrIcon = document.createElement('div');
                    avatarOrIcon.className = 'relative w-10 h-10 rounded-full overflow-hidden flex items-center justify-center mr-3 flex-shrink-0';
                    
                    if (archer.photoUrl) {
                        // Show photo avatar
                        avatarOrIcon.className += ' bg-gray-200 dark:bg-gray-700';
                        const avatarImg = document.createElement('img');
                        avatarImg.src = archer.photoUrl;
                        avatarImg.alt = `${archer.first} ${archer.last}`;
                        avatarImg.className = 'w-full h-full object-cover';
                        avatarOrIcon.appendChild(avatarImg);
                        
                        // Add visual cue badge ONLY when no self is selected at all
                        if (showPlusBadge) {
                            const badge = document.createElement('div');
                            badge.className = 'absolute -top-1 -right-1 w-5 h-5 bg-primary rounded-full flex items-center justify-center shadow-lg border-2 border-white dark:border-gray-800 z-10';
                            badge.innerHTML = '<i class="fas fa-plus text-white text-xs"></i>';
                            badge.title = 'Tap to set as me';
                            avatarOrIcon.appendChild(badge);
                        }
                        
                        // Make it clickable to set as "me"
                        avatarOrIcon.style.cursor = 'pointer';
                        avatarOrIcon.title = isSelf ? 'This is you (tap to clear)' : 'Tap to set as me';
                        avatarOrIcon.classList.add('hover:ring-2', 'hover:ring-primary', 'hover:ring-offset-2', 'transition-all');
                        avatarOrIcon.onclick = async (e) => {
                            e.stopPropagation();
                            if (isSelf) {
                                if (confirm('Clear "Who am I"?')) {
                                    if (typeof ArcherModule.clearSelf === 'function') ArcherModule.clearSelf();
                                    renderList();
                                }
                            } else {
                                await handleSetSelf(archer);
                            }
                        };
                    } else {
                        // Show person icon
                        if (isSelf) {
                            avatarOrIcon.innerHTML = '<i class="fas fa-user-check text-primary dark:text-primary-light" style="font-size: 1.5rem;"></i>';
                            avatarOrIcon.title = 'This is you (tap to clear)';
                            avatarOrIcon.style.cursor = 'pointer';
                            avatarOrIcon.classList.add('hover:ring-2', 'hover:ring-primary', 'hover:ring-offset-2', 'transition-all');
                            avatarOrIcon.onclick = (e) => {
                                e.stopPropagation();
                                if (confirm('Clear "Who am I"?')) {
                                    if (typeof ArcherModule.clearSelf === 'function') ArcherModule.clearSelf();
                                    renderList();
                                }
                            };
                        } else {
                            avatarOrIcon.innerHTML = '<i class="far fa-user text-gray-400 dark:text-gray-500" style="font-size: 1.5rem;"></i>';
                            avatarOrIcon.title = 'Tap to set as me';
                            avatarOrIcon.style.cursor = 'pointer';
                            avatarOrIcon.classList.add('hover:ring-2', 'hover:ring-primary', 'hover:ring-offset-2', 'transition-all');
                            
                            // Add visual cue badge ONLY when no self is selected at all
                            if (showPlusBadge) {
                                const badge = document.createElement('div');
                                badge.className = 'absolute -top-1 -right-1 w-5 h-5 bg-primary rounded-full flex items-center justify-center shadow-lg border-2 border-white dark:border-gray-800 z-10';
                                badge.innerHTML = '<i class="fas fa-plus text-white text-xs"></i>';
                                badge.title = 'Tap to set as me';
                                avatarOrIcon.appendChild(badge);
                            }
                            
                            avatarOrIcon.onclick = async (e) => {
                                e.stopPropagation();
                                await handleSetSelf(archer);
                            };
                        }
                    }

                    const nameDiv = document.createElement('div');
                    nameDiv.style.flexGrow = '1';

                    // Name with inline badges
                    const nameLabel = document.createElement('div');
                    nameLabel.className = 'archer-name-label';
                    nameLabel.style.display = 'flex';
                    nameLabel.style.alignItems = 'center';
                    nameLabel.style.gap = '0.5rem';
                    nameLabel.style.flexWrap = 'wrap';
                    
                    const nameText = document.createElement('span');
                    const nickname = archer.nickname ? ` (${archer.nickname})` : '';
                    nameText.textContent = `${archer.first} ${archer.last}${nickname}`;
                    nameLabel.appendChild(nameText);
                    
                    // Add "You" badge inline
                    if (isSelf) {
                        const youBadge = document.createElement('span');
                        youBadge.textContent = 'You';
                        youBadge.style.fontSize = '0.75rem';
                        youBadge.style.color = '#0d6efd';
                        youBadge.style.fontWeight = '600';
                        youBadge.style.padding = '0.1rem 0.4rem';
                        youBadge.style.backgroundColor = 'rgba(13, 110, 253, 0.1)';
                        youBadge.style.borderRadius = '0.25rem';
                        nameLabel.appendChild(youBadge);
                    }
                    
                    // Add Friend heart inline
                    if (isFriend && !isSelf) {
                        const friendHeart = document.createElement('span');
                        friendHeart.innerHTML = '<i class="fas fa-heart" style="color: #e63946; font-size: 0.85rem;"></i>';
                        friendHeart.title = 'Friend';
                        nameLabel.appendChild(friendHeart);
                    }

                    const detailsLabel = document.createElement('div');
                    const statusBadge = (archer.status || 'active').toUpperCase() === 'ACTIVE' ? 'Active' : 'Inactive';
                    
                    // Build details with PR info
                    let detailsText = `${(archer.school || 'N/A').toUpperCase()} • Grade ${archer.grade || '-'} • ${archer.level || 'VAR'} / ${archer.gender || 'M'} • ${statusBadge}`;
                    
                    // Add PR info if available
                    const jvPr = archer.jvPr ? parseInt(archer.jvPr) : null;
                    const varPr = archer.varPr ? parseInt(archer.varPr) : null;
                    if (jvPr || varPr) {
                        const prParts = [];
                        if (jvPr) prParts.push(`JV PR: ${jvPr}`);
                        if (varPr) prParts.push(`VAR PR: ${varPr}`);
                        detailsText += ` • ${prParts.join(' • ')}`;
                    }
                    
                    detailsLabel.textContent = detailsText;
                    detailsLabel.className = 'archer-details-label';
                    
                    nameDiv.appendChild(nameLabel);
                    nameDiv.appendChild(detailsLabel);

                    // Friend toggle button (for non-self archers)
                    const friendToggle = document.createElement('span');
                    if (!isSelf) {
                    friendToggle.className = 'favorite-star';
                    friendToggle.style.marginRight = '0.5rem';
                        friendToggle.innerHTML = isFriend ? '<i class="fas fa-heart" style="color: #e63946;"></i>' : '<i class="far fa-heart" style="color: #ccc;"></i>';
                        friendToggle.title = isFriend ? 'Remove from friends' : 'Add as friend';
                        friendToggle.onclick = async (e) => {
                            e.stopPropagation();
                            if (!selfExtId) {
                                alert('Set "Who am I" first by tapping your avatar or name.');
                                return;
                            }
                            try {
                                const result = await ArcherModule.toggleFriend(archer.extId);
                                recordSyncMessage(result?.sync, 'Friends updated');
                                renderList();
                            } catch (err) {
                                alert('Unable to update friends: ' + err.message);
                            }
                        };
                    }

                    const historyBtn = document.createElement('a');
                    // Use UUID (id) only for history link
                    const archerHistoryId = archer.id;
                    historyBtn.href = `archer_history.html?archer=${encodeURIComponent(archerHistoryId)}`;
                    historyBtn.className = 'favorite-star';
                    historyBtn.style.marginLeft = '0.5rem';
                    historyBtn.innerHTML = '<i class="fas fa-file-alt" style="color: #3498db;"></i>';
                    historyBtn.title = 'View archer history';
                    historyBtn.onclick = (e) => {
                        e.stopPropagation();
                    };

                    row.appendChild(avatarOrIcon);
                    row.appendChild(nameDiv);
                    if (!isSelf) row.appendChild(friendToggle);
                    row.appendChild(historyBtn);

                    row.onclick = () => editArcher(index);

                    container.appendChild(row);
                });
                refreshSelfSummary(state);
                updateSyncStatus();
            }
            updateSyncStatus();

            function openModal(index = null) {
                editingIndex = index;
                const form = document.getElementById('archer-form');
                form.innerHTML = createFormFieldsHTML();
                
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'flex gap-2 mt-6 sticky bottom-0 bg-white dark:bg-gray-800 pt-4 border-t border-gray-200 dark:border-gray-700';
                buttonContainer.innerHTML = `
                    <button type="button" id="cancel-archer-btn-modal" class="flex-1 px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors min-h-[44px]">Cancel</button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-success hover:bg-success-dark text-white rounded font-semibold transition-colors min-h-[44px]">Save</button>
                `;
                form.appendChild(buttonContainer);
                
                form.querySelector('#cancel-archer-btn-modal').onclick = closeModal;

                const modalTitle = document.getElementById('modal-title');
                const favesInput = form.querySelector('#faves');

                if (index !== null) {
                    modalTitle.textContent = 'Edit Archer';
                    const archer = ArcherModule.loadList()[index];
                    setFormValue(form, 'extId', archer.extId || '');
                    setFormValue(form, 'first', archer.first || '');
                    setFormValue(form, 'last', archer.last || '');
                    setFormValue(form, 'nickname', archer.nickname || '');
                    setFormValue(form, 'photoUrl', archer.photoUrl || '');
                    setFormValue(form, 'school', archer.school || '');
                    setFormValue(form, 'grade', archer.grade || '');
                    setFormValue(form, 'gender', archer.gender || 'M');
                    setFormValue(form, 'level', archer.level || 'VAR');
                    setFormValue(form, 'status', archer.status || 'active');
                    if (favesInput) favesInput.value = (archer.faves || []).join(', ');
                    setFormValue(form, 'email', archer.email || '');
                    setFormValue(form, 'phone', archer.phone || '');
                    setFormValue(form, 'usArcheryId', archer.usArcheryId || '');
                    setFormValue(form, 'jvPr', archer.jvPr || '');
                    setFormValue(form, 'varPr', archer.varPr || '');
                    setFormValue(form, 'shirtSize', archer.shirtSize || '');
                    setFormValue(form, 'pantSize', archer.pantSize || '');
                    setFormValue(form, 'hatSize', archer.hatSize || '');
                    setFormValue(form, 'domEye', archer.domEye || '');
                    setFormValue(form, 'domHand', archer.domHand || '');
                    setFormValue(form, 'heightIn', archer.heightIn || '');
                    setFormValue(form, 'wingspanIn', archer.wingspanIn || '');
                    setFormValue(form, 'drawLengthSugg', archer.drawLengthSugg || '');
                    setFormValue(form, 'riserHeightIn', archer.riserHeightIn || '');
                    setFormValue(form, 'limbLength', archer.limbLength || '');
                    setFormValue(form, 'limbWeightLbs', archer.limbWeightLbs || '');
                    setFormValue(form, 'notesGear', archer.notesGear || '');
                    setFormValue(form, 'notesCurrent', archer.notesCurrent || '');
                    setFormValue(form, 'notesArchive', archer.notesArchive || '');
                    setFormValue(form, 'legacyBale', archer.bale || '');
                    setFormValue(form, 'legacyTarget', archer.target || '');
                    setFormValue(form, 'legacySize', archer.size || '');
                } else {
                    modalTitle.textContent = 'Add Archer';
                    setFormValue(form, 'status', 'active');
                    // Hide navigation for new archers
                    const navigationDiv = document.getElementById('archer-navigation');
                    if (navigationDiv) navigationDiv.classList.add('hidden');
                }

                const emailDomainBtn = form.querySelector('#email-domain-btn');
                if (emailDomainBtn) {
                    const emailInput = form.querySelector('#email');
                    emailDomainBtn.onclick = (e) => {
                        e.preventDefault();
                        if (!emailInput) return;
                        let value = emailInput.value.trim();
                        const domain = SCHOOL_EMAIL_DOMAIN;
                        const normalizedDomain = domain.startsWith('@') ? domain : `@${domain}`;
                        if (!value) {
                            emailInput.value = normalizedDomain;
                            requestAnimationFrame(() => {
                                if (emailInput.setSelectionRange) {
                                    emailInput.setSelectionRange(0, 0);
                                }
                                emailInput.focus();
                            });
                            return;
                        }
                        if (value.toLowerCase().endsWith(normalizedDomain.toLowerCase())) {
                            alert('Email already includes the school domain.');
                            return;
                        }
                        if (value.includes('@')) {
                            if (!confirm('Replace the existing domain with the school domain?')) {
                                return;
                            }
                            value = value.split('@')[0];
                        }
                        emailInput.value = `${value}${normalizedDomain}`;
                    };
                }

                modal.classList.remove('hidden');
                
                // Initialize avatar upload functionality
                initializeAvatarUpload(form);
                
                // Update avatar preview based on current data
                updateAvatarPreview(form);
                
                // Initialize notes history functionality
                initializeNotesHistory(form);
                
                // Initialize navigation if editing
                if (index !== null) {
                    initializeArcherNavigation(index);
                }
            }
            
            function initializeAvatarUpload(form) {
                const uploadBtn = form.querySelector('#upload-avatar-btn');
                const fileInput = form.querySelector('#avatar-file');
                const photoUrlInput = form.querySelector('#photoUrl');
                const uploadProgress = form.querySelector('#upload-progress');
                
                if (!uploadBtn || !fileInput) return;
                
                // Click upload button to trigger file picker
                uploadBtn.onclick = (e) => {
                    e.preventDefault();
                    fileInput.click();
                };
                
                // Handle file selection - open crop modal
                fileInput.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    // Validate file type
                    if (!file.type.startsWith('image/')) {
                        alert('Please select an image file');
                        fileInput.value = '';
                        return;
                    }
                    
                    // Validate file size (10MB max)
                    if (file.size > 10 * 1024 * 1024) {
                        alert('File too large. Maximum size is 10MB');
                        fileInput.value = '';
                        return;
                    }
                    
                    // Open crop modal
                    openCropModal(file, uploadBtn, uploadProgress, photoUrlInput, form);
                };
                
                // Update preview when URL changes
                photoUrlInput.addEventListener('input', () => {
                    updateAvatarPreview(form);
                });
                
                // Update preview when name changes (for initials)
                form.querySelector('#first')?.addEventListener('input', () => updateAvatarPreview(form));
                form.querySelector('#last')?.addEventListener('input', () => updateAvatarPreview(form));
            }
            
            function updateAvatarPreview(form) {
                const photoUrlInput = form.querySelector('#photoUrl');
                const avatarImage = form.querySelector('#avatar-image');
                const avatarInitials = form.querySelector('#avatar-initials');
                const firstInput = form.querySelector('#first');
                const lastInput = form.querySelector('#last');
                
                if (!avatarImage || !avatarInitials) return;
                
                const photoUrl = photoUrlInput?.value.trim();
                const first = firstInput?.value.trim() || '';
                const last = lastInput?.value.trim() || '';
                
                if (photoUrl) {
                    // Show photo
                    avatarImage.src = photoUrl;
                    avatarImage.classList.remove('hidden');
                    avatarInitials.classList.add('hidden');
                    
                    // Handle image load error
                    avatarImage.onerror = () => {
                        avatarImage.classList.add('hidden');
                        avatarInitials.classList.remove('hidden');
                        showInitials(avatarInitials, first, last);
                    };
                } else {
                    // Show initials
                    avatarImage.classList.add('hidden');
                    avatarInitials.classList.remove('hidden');
                    showInitials(avatarInitials, first, last);
                }
            }
            
            function showInitials(element, first, last) {
                if (first || last) {
                    const initials = (first.charAt(0) + last.charAt(0)).toUpperCase();
                    element.textContent = initials || '?';
                } else {
                    element.textContent = '?';
                }
            }
            
            function initializeNotesHistory(form) {
                const moveToHistoryBtn = form.querySelector('#move-to-history-btn');
                const currentNotesInput = form.querySelector('#notesCurrent');
                const archiveNotesInput = form.querySelector('#notesArchive');
                
                if (!moveToHistoryBtn || !currentNotesInput || !archiveNotesInput) return;
                
                moveToHistoryBtn.onclick = (e) => {
                    e.preventDefault();
                    
                    const currentNote = currentNotesInput.value.trim();
                    if (!currentNote) {
                        alert('No current note to move to history.');
                        return;
                    }
                    
                    // Create timestamp (short format at end)
                    const now = new Date();
                    const timestamp = now.toLocaleDateString('en-US', { 
                        month: 'numeric', 
                        day: 'numeric', 
                        year: '2-digit' 
                    });
                    
                    // Format: "Note text (11/22/25)"
                    const timestampedNote = `${currentNote} (${timestamp})`;
                    
                    // Get existing archive
                    const existingArchive = archiveNotesInput.value.trim();
                    
                    // Prepend new note to archive (most recent first)
                    const newArchive = existingArchive 
                        ? `${timestampedNote}\n${existingArchive}`
                        : timestampedNote;
                    
                    // Update fields
                    archiveNotesInput.value = newArchive;
                    currentNotesInput.value = '';
                    
                    // Focus back to current notes for next entry
                    currentNotesInput.focus();
                };
            }
            
            function initializeArcherNavigation(currentIndex) {
                const navigationDiv = document.getElementById('archer-navigation');
                const prevBtn = document.getElementById('prev-archer-btn');
                const nextBtn = document.getElementById('next-archer-btn');
                const positionSpan = document.getElementById('archer-position');
                
                if (!navigationDiv || !prevBtn || !nextBtn || !positionSpan) return;
                
                // Show navigation
                navigationDiv.classList.remove('hidden');
                
                // Find current position in filtered list
                const currentPosition = filteredArcherIndices.indexOf(currentIndex);
                const totalArchers = filteredArcherIndices.length;
                
                if (currentPosition === -1 || totalArchers <= 1) {
                    navigationDiv.classList.add('hidden');
                    return;
                }
                
                // Update position display
                positionSpan.textContent = `${currentPosition + 1} of ${totalArchers}`;
                
                // Update button states
                prevBtn.disabled = currentPosition === 0;
                nextBtn.disabled = currentPosition === totalArchers - 1;
                
                // Add click handlers
                prevBtn.onclick = () => {
                    if (currentPosition > 0) {
                        const prevIndex = filteredArcherIndices[currentPosition - 1];
                        openModal(prevIndex);
                    }
                };
                
                nextBtn.onclick = () => {
                    if (currentPosition < totalArchers - 1) {
                        const nextIndex = filteredArcherIndices[currentPosition + 1];
                        openModal(nextIndex);
                    }
                };
            }
            
            // Crop modal functionality
            let cropperInstance = null;
            let currentCropFile = null;
            let currentUploadBtn = null;
            let currentUploadProgress = null;
            let currentPhotoUrlInput = null;
            let currentForm = null;
            
            function openCropModal(file, uploadBtn, uploadProgress, photoUrlInput, form) {
                const cropModal = document.getElementById('crop-modal');
                const cropImage = document.getElementById('crop-image');
                const cancelCropBtn = document.getElementById('cancel-crop-btn');
                const applyCropBtn = document.getElementById('apply-crop-btn');
                
                // Store references
                currentCropFile = file;
                currentUploadBtn = uploadBtn;
                currentUploadProgress = uploadProgress;
                currentPhotoUrlInput = photoUrlInput;
                currentForm = form;
                
                // Load image
                const reader = new FileReader();
                reader.onload = (e) => {
                    cropImage.src = e.target.result;
                    cropModal.classList.remove('hidden');
                    
                    // Initialize cropper
                    if (cropperInstance) {
                        cropperInstance.destroy();
                    }
                    
                    cropperInstance = new Cropper(cropImage, {
                        aspectRatio: 1, // Square crop
                        viewMode: 2, // Restrict crop box to canvas
                        dragMode: 'move',
                        autoCropArea: 0.8,
                        restore: false,
                        guides: true,
                        center: true,
                        highlight: false,
                        cropBoxMovable: true,
                        cropBoxResizable: true,
                        toggleDragModeOnDblclick: false,
                        responsive: true,
                        background: false,
                        modal: true,
                        minCropBoxWidth: 100,
                        minCropBoxHeight: 100
                    });
                };
                reader.readAsDataURL(file);
                
                // Cancel button
                cancelCropBtn.onclick = () => {
                    closeCropModal();
                    // Reset file input
                    document.getElementById('avatar-file').value = '';
                };
                
                // Apply crop button
                applyCropBtn.onclick = async () => {
                    if (!cropperInstance) return;
                    
                    // Get cropped canvas
                    const canvas = cropperInstance.getCroppedCanvas({
                        width: 1024,
                        height: 1024,
                        imageSmoothingEnabled: true,
                        imageSmoothingQuality: 'high'
                    });
                    
                    // Convert to blob
                    canvas.toBlob(async (blob) => {
                        closeCropModal();
                        await uploadCroppedImage(blob);
                    }, currentCropFile.type, 0.95);
                };
            }
            
            function closeCropModal() {
                const cropModal = document.getElementById('crop-modal');
                cropModal.classList.add('hidden');
                
                if (cropperInstance) {
                    cropperInstance.destroy();
                    cropperInstance = null;
                }
            }
            
            async function uploadCroppedImage(blob) {
                // Show progress
                currentUploadBtn.classList.add('hidden');
                currentUploadProgress.classList.remove('hidden');
                
                try {
                    // Create form data
                    const formData = new FormData();
                    formData.append('avatar', blob, currentCropFile.name);
                    
                    const response = await fetch('api/upload_avatar.php', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error('Upload failed');
                    }
                    
                    const result = await response.json();
                    
                    if (result.success && result.photoUrl) {
                        // Update photoUrl field
                        currentPhotoUrlInput.value = result.photoUrl;
                        
                        // Update preview
                        updateAvatarPreview(currentForm);
                        
                        // Show success feedback
                        currentUploadProgress.innerHTML = '<i class="fas fa-check mr-1"></i>Uploaded!';
                        currentUploadProgress.classList.remove('text-gray-600', 'dark:text-gray-400');
                        currentUploadProgress.classList.add('text-green-600', 'dark:text-green-400');
                        
                        setTimeout(() => {
                            currentUploadProgress.classList.add('hidden');
                            currentUploadProgress.classList.remove('text-green-600', 'dark:text-green-400');
                            currentUploadProgress.classList.add('text-gray-600', 'dark:text-gray-400');
                            currentUploadProgress.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Uploading...';
                            currentUploadBtn.classList.remove('hidden');
                        }, 2000);
                    } else {
                        throw new Error(result.error || 'Upload failed');
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    alert('Failed to upload photo: ' + error.message);
                    currentUploadProgress.classList.add('hidden');
                    currentUploadBtn.classList.remove('hidden');
                }
                
                // Reset file input
                document.getElementById('avatar-file').value = '';
            }
            
            function createFormFieldsHTML() {
                return `
                    <input type="hidden" id="extId">
                    <input type="hidden" id="legacyBale">
                    <input type="hidden" id="legacyTarget">
                    <input type="hidden" id="legacySize">

                    <!-- Identity Section -->
                    <section class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 mb-4">
                        <!-- Header with Status -->
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wide">Identity</h3>
                            <div class="w-32">
                                <label class="block mb-1 text-xs font-medium text-gray-700 dark:text-gray-300" for="status">Status</label>
                                <select class="w-full px-2 py-1 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary text-sm" id="status">
                                    <option value="active" selected>Active</option>
                                    <option value="inactive">Inactive</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Photo and Name Fields Row -->
                        <div class="flex gap-4 mb-4">
                            <!-- Avatar Preview and Upload -->
                            <div class="w-32 flex-shrink-0">
                                <div class="relative">
                                    <div id="avatar-preview" class="w-32 h-32 rounded-lg border-2 border-gray-300 dark:border-gray-600 overflow-hidden bg-gray-100 dark:bg-gray-800 flex items-center justify-center">
                                        <span id="avatar-initials" class="text-3xl font-bold text-gray-400 dark:text-gray-500">?</span>
                                        <img id="avatar-image" class="hidden w-full h-full object-cover" alt="Avatar">
                                    </div>
                                    <input type="file" id="avatar-file" accept="image/*" class="hidden">
                                    <input type="hidden" id="photoUrl">
                                    <button type="button" id="upload-avatar-btn" class="mt-2 w-full px-2 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded transition-colors">
                                        <i class="fas fa-camera mr-1"></i>Upload
                                    </button>
                                    <div id="upload-progress" class="hidden mt-1 text-xs text-center text-gray-600 dark:text-gray-400">
                                        <i class="fas fa-spinner fa-spin mr-1"></i>Uploading...
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Name Fields Aligned with Photo -->
                            <div class="flex-1 flex flex-col justify-between">
                                <div>
                                    <input class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" type="text" id="first" placeholder="First Name*" required>
                                </div>
                                <div>
                                    <input class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" type="text" id="last" placeholder="Last Name*" required>
                                </div>
                                <div>
                                    <input class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" type="text" id="nickname" placeholder="Nickname">
                                </div>
                            </div>
                        </div>
                        
                        <!-- School, Grade, Gender Row -->
                        <div class="grid grid-cols-3 gap-3 mb-3">
                            <div>
                                <label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300" for="school">School</label>
                                <input class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" type="text" id="school" maxlength="3" placeholder="WDV">
                            </div>
                            <div>
                                <label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300" for="grade">Grade</label>
                                <select class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" id="grade">
                                    <option value="">-</option>
                                    <option value="9">9</option>
                                    <option value="10">10</option>
                                    <option value="11">11</option>
                                    <option value="12">12</option>
                                    <option value="GRAD">GRAD</option>
                                </select>
                            </div>
                            <div>
                                <label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300" for="gender">Gender</label>
                                <select class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" id="gender">
                                    <option value="M">M</option>
                                    <option value="F">F</option>
                                </select>
                            </div>
                            </div>
                        
                        <!-- Friends -->
                        <div>
                            <label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300" for="faves">Friends</label>
                            <input class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" type="text" id="faves" placeholder="archer-ext-id-1, archer-ext-id-2">
                            <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">Comma-separated extIds</div>
                        </div>
                    </section>

                    <!-- Performance Section -->
                    <section class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 mb-4">
                        <h3 class="mb-4 text-sm font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wide">Performance</h3>
                        
                        <div class="grid grid-cols-3 gap-3">
                            <div>
                                <label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300" for="level">Level</label>
                                <select class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" id="level">
                                    <option value="VAR">VAR</option>
                                    <option value="JV">JV</option>
                                    <option value="BEG">BEG</option>
                                </select>
                            </div>
                            <div>
                                <label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300" for="jvPr">JV PR</label>
                                <input class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" type="number" id="jvPr" min="0" max="360" placeholder="0-360">
                            </div>
                            <div>
                                <label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300" for="varPr">VAR PR</label>
                                <input class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" type="number" id="varPr" min="0" max="360" placeholder="0-360">
                            </div>
                        </div>
                    </section>

                    <!-- Equipment Section -->
                    <section class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 mb-4">
                        <h3 class="mb-4 text-sm font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wide">Equipment</h3>
                        
                        <!-- Row 1: Hand, Eye, Height, Wingspan -->
                        <div class="grid grid-cols-4 gap-3 mb-3">
                            <div>
                                <label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300" for="domHand">Hand</label>
                                <select class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" id="domHand">
                                    <option value="">-</option>
                                    <option value="RT">Right</option>
                                    <option value="LT">Left</option>
                                </select>
                            </div>
                            <div>
                                <label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300" for="domEye">Eye</label>
                                <select class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" id="domEye">
                                    <option value="">-</option>
                                    <option value="RT">Right</option>
                                    <option value="LT">Left</option>
                                </select>
                            </div>
                            <div>
                                <label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300" for="heightIn">Ht (in)</label>
                                <input class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" type="number" id="heightIn" min="0" step="1" placeholder="60">
                            </div>
                            <div>
                                <label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300" for="wingspanIn">Wing (in)</label>
                                <input class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" type="number" id="wingspanIn" min="0" step="0.1" placeholder="60.5">
                            </div>
                        </div>
                        
                        <!-- Row 2: Draw, Limb, Weight -->
                        <div class="grid grid-cols-3 gap-3">
                            <div>
                                <label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300" for="drawLengthSugg">Draw (in)</label>
                                <input class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" type="number" id="drawLengthSugg" min="0" step="0.1" placeholder="28.5">
                            </div>
                            <div>
                                <label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300" for="limbLength">Limb</label>
                                <select class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" id="limbLength">
                                    <option value="">-</option>
                                    <option value="S">S</option>
                                    <option value="M">M</option>
                                    <option value="L">L</option>
                                </select>
                            </div>
                            <div>
                                <label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300" for="limbWeightLbs">Wt (lbs)</label>
                                <input class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" type="number" id="limbWeightLbs" min="0" step="0.5" placeholder="20">
                        </div>
                        </div>
                        
                        <!-- Hidden Riser Height (kept for data preservation) -->
                        <input type="hidden" id="riserHeightIn">
                    </section>

                    <!-- Notes Section -->
                    <section class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 mb-4">
                        <h3 class="mb-4 text-sm font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wide">Notes</h3>
                        
                        <div class="space-y-3">
                            <div>
                                <label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300" for="notesGear">Gear Notes</label>
                                <textarea class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" id="notesGear" rows="2"></textarea>
                            </div>
                            <div>
                                <div class="flex justify-between items-center mb-1">
                                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300" for="notesCurrent">Current Notes</label>
                                    <button type="button" id="move-to-history-btn" class="px-2 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded transition-colors" title="Move current note to history">
                                        <i class="fas fa-arrow-down mr-1"></i>Move to History
                                    </button>
                                </div>
                                <textarea class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" id="notesCurrent" rows="2"></textarea>
                            </div>
                            <div>
                                <label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300" for="notesArchive">Notes History (Read Only)</label>
                                <textarea class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-gray-100 dark:bg-gray-600 text-gray-900 dark:text-white focus:outline-none cursor-not-allowed" id="notesArchive" rows="3" readonly placeholder="Previous notes will appear here with timestamps..."></textarea>
                            </div>
                        </div>
                    </section>

                    <!-- Sizes Section -->
                    <section class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 mb-4">
                        <h3 class="mb-4 text-sm font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wide">Sizes</h3>
                        
                        <div class="grid grid-cols-3 gap-3">
                            <div>
                                <label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300" for="shirtSize">Shirt</label>
                                <select class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" id="shirtSize">
                                    <option value="">-</option>
                                    <option value="XS">XS</option>
                                    <option value="S">S</option>
                                    <option value="M">M</option>
                                    <option value="L">L</option>
                                    <option value="XL">XL</option>
                                    <option value="XXL">XXL</option>
                                    <option value="XXXL">XXXL</option>
                                </select>
                            </div>
                            <div>
                                <label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300" for="pantSize">Pant</label>
                                <input class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" type="text" id="pantSize" placeholder="32x34">
                            </div>
                            <div>
                                <label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300" for="hatSize">Hat</label>
                                <select class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" id="hatSize">
                                    <option value="">-</option>
                                    <option value="XS">XS</option>
                                    <option value="S">S</option>
                                    <option value="M">M</option>
                                    <option value="L">L</option>
                                    <option value="XL">XL</option>
                                    <option value="XXL">XXL</option>
                                </select>
                            </div>
                        </div>
                    </section>

                    <!-- Contact Section -->
                    <section class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 mb-4">
                        <h3 class="mb-4 text-sm font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wide">Contact</h3>
                        
                        <div class="space-y-3">
                            <div>
                                <label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300" for="email">Email</label>
                                <div class="flex gap-2">
                                    <input class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" type="email" id="email" placeholder="firstname_lastname">
                                    <button type="button" id="email-domain-btn" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors whitespace-nowrap">@student...</button>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300" for="phone">Phone</label>
                                    <input class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" type="tel" id="phone" placeholder="###-###-####">
                                </div>
                                <div>
                                    <label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300" for="usArcheryId">USA Archery ID</label>
                                    <input class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" type="text" id="usArcheryId">
                                </div>
                            </div>
                        </div>
                    </section>
                `;
            }

            function setFormValue(form, id, value) {
                const el = form.querySelector(`#${id}`);
                if (!el) return;
                if (el.tagName === 'SELECT' || el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                    el.value = value != null ? value : '';
                }
            }

            function closeModal() {
                modal.classList.add('hidden');
            }

            function editArcher(index) {
                openModal(index);
            }

            addArcherBtn.onclick = () => openModal();

            // Handle setting self with success feedback and warning modal
            let pendingSelfChange = null;
            
            async function handleSetSelf(archer) {
                // Check if there's already a self selected
                const currentState = getRosterState();
                if (currentState.selfArcher && currentState.selfArcher.extId !== archer.extId) {
                    // Show warning modal
                    pendingSelfChange = archer;
                    const modal = document.getElementById('change-self-warning-modal');
                    const currentNameEl = document.getElementById('current-self-name');
                    if (modal && currentNameEl) {
                        currentNameEl.textContent = `${currentState.selfArcher.first} ${currentState.selfArcher.last}`;
                        modal.classList.remove('hidden');
                    }
                    return;
                }
                
                // No existing self or same archer, proceed directly
                await confirmSetSelf(archer);
            }
            
            async function confirmSetSelf(archer) {
                await ArcherModule.setSelf(archer.extId);
                
                // Show success feedback
                showSuccessFeedback(archer);
                
                // Hide banner if shown
                const banner = document.getElementById('select-yourself-banner');
                if (banner) banner.classList.add('hidden');
                
                // Force refresh state and re-render to ensure badges are updated
                const freshState = getRosterState();
                refreshSelfSummary(freshState);
                renderList(freshState);
                
                // Clear pending change
                pendingSelfChange = null;
            }
            
            // Show success feedback when user sets themselves
            function showSuccessFeedback(archer) {
                // Create temporary success message
                const successMsg = document.createElement('div');
                successMsg.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 z-50 px-6 py-4 bg-success text-white rounded-lg shadow-xl flex items-center gap-3 animate-bounce';
                successMsg.style.animation = 'fadeIn 0.3s ease-in';
                successMsg.innerHTML = `
                    <i class="fas fa-check-circle text-2xl"></i>
                    <div>
                        <p class="font-semibold">You've selected yourself!</p>
                        <p class="text-sm text-white/90">${archer.first} ${archer.last}</p>
                    </div>
                `;
                document.body.appendChild(successMsg);
                
                // Remove after 3 seconds with fade out
                setTimeout(() => {
                    successMsg.style.animation = 'fadeOut 0.3s ease-out';
                    successMsg.style.opacity = '0';
                    setTimeout(() => {
                        if (successMsg.parentNode) {
                            successMsg.parentNode.removeChild(successMsg);
                        }
                    }, 300);
                }, 3000);
            }
            
            // Banner dismiss handler
            const dismissBannerBtn = document.getElementById('dismiss-banner-btn');
            if (dismissBannerBtn) {
                dismissBannerBtn.onclick = () => {
                    const banner = document.getElementById('select-yourself-banner');
                    if (banner) {
                        banner.classList.add('hidden');
                        localStorage.setItem('select-yourself-banner-dismissed', 'true');
                    }
                };
            }
            
            // Select yourself button handler
            const selectYourselfBtn = document.getElementById('select-yourself-btn');
            if (selectYourselfBtn) {
                selectYourselfBtn.onclick = () => {
                    // Scroll to first archer in list and highlight
                    const container = document.getElementById('archer-list-container');
                    if (container && container.firstChild) {
                        container.firstChild.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        // Add temporary highlight
                        container.firstChild.classList.add('ring-4', 'ring-primary', 'ring-offset-2');
                        setTimeout(() => {
                            container.firstChild.classList.remove('ring-4', 'ring-primary', 'ring-offset-2');
                        }, 2000);
                    }
                };
            }
            
            clearSelfBtn.onclick = () => {
                const current = (typeof ArcherModule.getSelfExtId === 'function') ? ArcherModule.getSelfExtId() : '';
                if (!current) {
                    alert('Set "Who am I" by tapping the person icon next to your name.');
                    return;
                }
                if (confirm('Clear "Who am I" for this device?')) {
                    if (typeof ArcherModule.clearSelf === 'function') ArcherModule.clearSelf();
                    // Reset banner dismissal when clearing
                    localStorage.removeItem('select-yourself-banner-dismissed');
                    renderList();
                }
            };
            
            window.onclick = (event) => {
                if (event.target === modal) closeModal();
            };

            document.getElementById('archer-form').onsubmit = async (e) => {
                e.preventDefault();
                const form = e.target;
                const parseList = (value) => value
                    .split(/[,;]+/)
                    .map(s => s.trim())
                    .filter(Boolean);

                const current = editingIndex !== null ? ArcherModule.loadList()[editingIndex] || {} : {};
                const archer = {
                    extId: form.querySelector('#extId').value.trim(),
                    first: form.querySelector('#first').value.trim(),
                    last: form.querySelector('#last').value.trim(),
                    nickname: form.querySelector('#nickname').value.trim(),
                    photoUrl: form.querySelector('#photoUrl').value.trim(),
                    school: form.querySelector('#school').value.trim(),
                    grade: form.querySelector('#grade').value,
                    status: form.querySelector('#status').value,
                    gender: form.querySelector('#gender').value,
                    level: form.querySelector('#level').value,
                    faves: parseList(form.querySelector('#faves').value),
                    email: form.querySelector('#email').value.trim(),
                    phone: form.querySelector('#phone').value.trim(),
                    usArcheryId: form.querySelector('#usArcheryId').value.trim(),
                    jvPr: form.querySelector('#jvPr').value,
                    varPr: form.querySelector('#varPr').value,
                    shirtSize: form.querySelector('#shirtSize').value,
                    pantSize: form.querySelector('#pantSize').value.trim(),
                    hatSize: form.querySelector('#hatSize').value,
                    domEye: form.querySelector('#domEye').value,
                    domHand: form.querySelector('#domHand').value,
                    heightIn: form.querySelector('#heightIn').value,
                    wingspanIn: form.querySelector('#wingspanIn').value,
                    drawLengthSugg: form.querySelector('#drawLengthSugg').value,
                    riserHeightIn: form.querySelector('#riserHeightIn').value,
                    limbLength: form.querySelector('#limbLength').value,
                    limbWeightLbs: form.querySelector('#limbWeightLbs').value,
                    notesGear: form.querySelector('#notesGear').value,
                    notesCurrent: form.querySelector('#notesCurrent').value,
                    notesArchive: form.querySelector('#notesArchive').value,
                    // Preserve legacy fields until dependent modules migrate
                    bale: current.bale || form.querySelector('#legacyBale').value || '',
                    target: current.target || form.querySelector('#legacyTarget').value || '',
                    size: current.size || form.querySelector('#legacySize').value || ''
                };

                if (!archer.first || !archer.last) {
                    alert('First and Last name are required.');
                    return;
                }

                try {
                    let result;
                    if (editingIndex !== null) {
                        result = await ArcherModule.editArcher(editingIndex, archer);
                        recordSyncMessage(result?.sync, 'Profile updated');
                    } else {
                        result = await ArcherModule.addArcher(archer);
                        recordSyncMessage(result?.sync, 'Profile added');
                    }
                } catch (error) {
                    console.error('Failed to save archer:', error);
                    alert('Unable to save archer at this time. Changes are kept locally and will retry when online.');
                }
                renderList();
                closeModal();
            };

            // Search input handlers
            const clearSearchBtn = document.getElementById('clear-search-btn');
            
            searchInput.oninput = () => {
                renderList();
                // Show/hide clear button based on input
                if (clearSearchBtn) {
                    if (searchInput.value.trim()) {
                        clearSearchBtn.classList.remove('hidden');
                    } else {
                        clearSearchBtn.classList.add('hidden');
                    }
                }
            };
            
            if (clearSearchBtn) {
                clearSearchBtn.onclick = () => {
                    searchInput.value = '';
                    clearSearchBtn.classList.add('hidden');
                    renderList();
                    searchInput.focus();
                };
            }
            
            // Warning modal handlers
            const changeSelfModal = document.getElementById('change-self-warning-modal');
            const cancelChangeSelfBtn = document.getElementById('cancel-change-self-btn');
            const confirmChangeSelfBtn = document.getElementById('confirm-change-self-btn');
            
            if (cancelChangeSelfBtn) {
                cancelChangeSelfBtn.onclick = () => {
                    if (changeSelfModal) changeSelfModal.classList.add('hidden');
                    pendingSelfChange = null;
                };
            }
            
            if (confirmChangeSelfBtn) {
                confirmChangeSelfBtn.onclick = async () => {
                    if (changeSelfModal) changeSelfModal.classList.add('hidden');
                    if (pendingSelfChange) {
                        await confirmSetSelf(pendingSelfChange);
                    }
                };
            }
            
            // Close modal on backdrop click
            if (changeSelfModal) {
                changeSelfModal.onclick = (e) => {
                    if (e.target === changeSelfModal) {
                        changeSelfModal.classList.add('hidden');
                        pendingSelfChange = null;
                    }
                };
            }
            statusFilter.onchange = () => renderList();

            // Load/Refresh from MySQL
            loadFromMySQLBtn.onclick = async () => {
                try {
                    const archers = await ArcherModule.loadFromMySQL();
                    alert(`Refreshed! Loaded ${archers.length} archers from database.`);
                    lastSyncMessage = 'Roster refreshed';
                    renderList();
                    updateSyncStatus();
                } catch (error) {
                    alert('Failed to refresh from database: ' + error.message + '\n\nEnter your coach API key or event code in Coach Console, then try again.');
                }
            };
            
            sortByNameBtn.onclick = () => {
                sortMode = 'name';
                sortByNameBtn.className = 'px-4 py-2 bg-gray-400 dark:bg-gray-600 text-white rounded font-semibold hover:bg-gray-500 dark:hover:bg-gray-500 transition-colors min-h-[44px]';
                sortByLevelBtn.className = 'px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors min-h-[44px]';
                renderList();
            };

            sortByLevelBtn.onclick = () => {
                sortMode = 'level';
                sortByLevelBtn.className = 'px-4 py-2 bg-gray-400 dark:bg-gray-600 text-white rounded font-semibold hover:bg-gray-500 dark:hover:bg-gray-500 transition-colors min-h-[44px]';
                sortByNameBtn.className = 'px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors min-h-[44px]';
                renderList();
            };

            (async function init() {
                // Try to load from MySQL first to ensure we have UUIDs
                try {
                    console.log('Auto-loading archer list from MySQL...');
                    const archers = await ArcherModule.loadFromMySQL();
                    console.log(`Loaded ${archers.length} archers from MySQL with UUIDs`);
                    lastSyncMessage = 'Auto-loaded from server';
                } catch (err) {
                    console.warn('Failed to auto-load from MySQL, falling back to local/CSV:', err);
                    await ArcherModule.loadDefaultCSVIfNeeded();
                }
                
                renderList();
                
                try {
                    await ArcherModule.flushPending();
                } catch (err) {
                    console.warn('Initial sync flush failed:', err);
                }
                updateSyncStatus();
            })();
        });
    </script>
</body>
</html>
