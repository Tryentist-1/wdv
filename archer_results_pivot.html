<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Archer Results - Pivot View</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="css/tailwind-compiled.css">
  <script src="js/common.js"></script>
  <script>
    // Initialize dark mode immediately (before DOMContentLoaded) to prevent flash
    // Dark mode preference is set from the home screen (index.html)
    if (typeof initDarkMode === 'function') {
      initDarkMode();
    } else {
      // Fallback if common.js not loaded yet
      (function() {
        const savedTheme = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
      })();
    }
  </script>
  <script src="js/scorecard_view.js"></script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen transition-colors duration-200">
  <div class="max-w-full mx-auto px-2 sm:px-4 py-3 sm:py-4 pb-[calc(48px+env(safe-area-inset-bottom))]">
    <!-- Header -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-3 sm:p-4 mb-3 transition-colors duration-200">
      <div class="flex justify-between items-start">
        <div>
          <h1 class="text-xl sm:text-2xl font-bold text-gray-800 dark:text-white mb-1">Archer Results - Pivot View</h1>
          <p class="text-gray-600 dark:text-gray-400 text-xs sm:text-sm">View all archer scores across multiple rounds</p>
        </div>
      </div>
    </div>

    <!-- Round Selector -->
    <div id="round-selector" class="hidden bg-white dark:bg-gray-800 rounded-lg shadow-md mb-3 transition-colors duration-200">
      <button id="toggle-round-selector" class="w-full flex justify-between items-center p-3 sm:p-4 text-left hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
        <h2 class="text-lg sm:text-xl font-bold text-gray-800 dark:text-white">üìÖ Select Rounds to Include</h2>
        <span id="round-selector-chevron" class="text-2xl transition-transform">‚ñº</span>
      </button>
      <div id="round-selector-content" class="p-3 sm:p-4 pt-0">
        <div id="round-checkboxes" class="grid grid-cols-1 gap-2 mb-3">
          <!-- Dynamic checkboxes will be inserted here -->
        </div>
        <div class="flex gap-2 flex-wrap">
          <button id="select-all-rounds-btn" class="px-3 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded text-sm font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors min-h-[44px]">Select All</button>
          <button id="deselect-all-rounds-btn" class="px-3 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded text-sm font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors min-h-[44px]">Deselect All</button>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md mb-3 transition-colors duration-200">
      <button id="toggle-filters" class="w-full flex justify-between items-center p-3 sm:p-4 text-left hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
        <h2 class="text-lg sm:text-xl font-bold text-gray-800 dark:text-white">Filters & Sort</h2>
        <span id="filters-chevron" class="text-2xl transition-transform">‚ñº</span>
      </button>
      <div id="filters-content" class="p-3 sm:p-4 pt-0">
      
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
        <!-- Division Filter -->
        <div>
          <label class="block text-xs sm:text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Division</label>
          <select id="filter-division" class="w-full px-2 py-2 text-sm border-2 border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-800 dark:text-white focus:border-primary focus:outline-none transition-colors min-h-[44px]">
            <option value="">All Divisions</option>
            <option value="OPEN">Open</option>
            <option value="VAR">Varsity</option>
            <option value="JV">JV</option>
          </select>
        </div>

        <!-- Gender Filter -->
        <div>
          <label class="block text-xs sm:text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Gender</label>
          <select id="filter-gender" class="w-full px-2 py-2 text-sm border-2 border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-800 dark:text-white focus:border-primary focus:outline-none transition-colors min-h-[44px]">
            <option value="">All Genders</option>
            <option value="M">Male</option>
            <option value="F">Female</option>
          </select>
        </div>

        <!-- Target Size Filter -->
        <div>
          <label class="block text-xs sm:text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Target Size</label>
          <select id="filter-target-size" class="w-full px-2 py-2 text-sm border-2 border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-800 dark:text-white focus:border-primary focus:outline-none transition-colors min-h-[44px]">
            <option value="">All Sizes</option>
            <option value="80">80cm</option>
            <option value="122">122cm</option>
          </select>
        </div>

        <!-- Sort By -->
        <div>
          <label class="block text-xs sm:text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Sort By</label>
          <select id="sort-by" class="w-full px-2 py-2 text-sm border-2 border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-800 dark:text-white focus:border-primary focus:outline-none transition-colors min-h-[44px]">
            <option value="name">Name (A-Z)</option>
            <option value="total-desc">Total Score (High to Low)</option>
            <option value="total-asc">Total Score (Low to High)</option>
            <option value="max-desc">MAX Score (High to Low)</option>
            <option value="max-asc">MAX Score (Low to High)</option>
            <option value="avg-desc">Average (High to Low)</option>
            <option value="avg-asc">Average (Low to High)</option>
          </select>
        </div>

        <!-- Search -->
        <div class="sm:col-span-2">
          <label class="block text-xs sm:text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Search Name</label>
          <input type="text" id="search-name" placeholder="Type to search..." class="w-full px-2 py-2 text-sm border-2 border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-800 dark:text-white focus:border-primary focus:outline-none transition-colors min-h-[44px]">
        </div>
      </div>

      <div class="flex gap-2 flex-wrap mb-3">
        <button id="reset-filters-btn" class="px-3 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded text-sm font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors min-h-[44px]">Reset</button>
        
        <!-- View Mode Toggle -->
        <div class="ml-auto flex gap-2">
          <button id="simple-view-btn" class="px-3 py-2 bg-primary text-white rounded text-sm font-semibold transition-colors min-h-[44px]">Simple</button>
          <button id="advanced-view-btn" class="px-3 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded text-sm font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors min-h-[44px]">Advanced</button>
        </div>
      </div>
      </div>
    </div>

    <!-- Loading State -->
    <div id="loading-state" class="text-center py-12">
      <div class="text-4xl mb-4">‚è≥</div>
      <p class="text-gray-600 dark:text-gray-400">Loading archer data...</p>
    </div>

    <!-- Error State -->
    <div id="error-state" class="hidden bg-danger-light dark:bg-red-900 rounded-lg p-6 text-center">
      <div class="text-4xl mb-4">‚ö†Ô∏è</div>
      <p class="text-danger dark:text-red-400 font-semibold" id="error-message"></p>
    </div>

    <!-- Pivot Table Container -->
    <div id="pivot-container" class="hidden bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden transition-colors duration-200">
      <div class="overflow-x-auto">
        <table id="pivot-table" class="w-full border-collapse">
          <thead id="pivot-thead" class="bg-gray-700 dark:bg-gray-600 text-white">
            <!-- Dynamic headers will be inserted here -->
          </thead>
          <tbody id="pivot-tbody" class="text-gray-700 dark:text-gray-300">
            <!-- Dynamic rows will be inserted here -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Stats Summary -->
    <div id="stats-summary" class="hidden mt-3 bg-white dark:bg-gray-800 rounded-lg shadow-md p-3 sm:p-4 transition-colors duration-200">
      <h3 class="text-sm sm:text-base font-bold text-gray-800 dark:text-white mb-2">Summary Statistics</h3>
      <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 sm:gap-3">
        <div class="text-center">
          <div class="text-xl sm:text-2xl font-bold text-primary dark:text-blue-400" id="stat-total-archers">0</div>
          <div class="text-xs text-gray-600 dark:text-gray-400">Total Archers</div>
        </div>
        <div class="text-center">
          <div class="text-xl sm:text-2xl font-bold text-success dark:text-green-400" id="stat-total-rounds">0</div>
          <div class="text-xs text-gray-600 dark:text-gray-400">Total Rounds</div>
        </div>
        <div class="text-center">
          <div class="text-xl sm:text-2xl font-bold text-rank-gold" id="stat-highest-score">0</div>
          <div class="text-xs text-gray-600 dark:text-gray-400">Highest Score</div>
        </div>
        <div class="text-center">
          <div class="text-xl sm:text-2xl font-bold text-gray-700 dark:text-gray-300" id="stat-avg-score">0</div>
          <div class="text-xs text-gray-600 dark:text-gray-400">Average Score</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="fixed bottom-0 left-0 right-0 h-[48px] bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 flex items-center px-4 shadow-lg transition-colors duration-200 z-10 safe-area-bottom">
    <a href="index.html" class="min-w-[48px] h-[48px] text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white active:bg-gray-100 dark:active:bg-gray-700 rounded-lg transition-colors flex items-center justify-center" aria-label="Home">
      <i class="fas fa-home text-2xl"></i>
    </a>
    <div class="flex-1"></div>
    <div class="flex gap-1 sm:gap-2">
      <a href="coach.html" class="px-3 h-[44px] bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded text-sm font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors flex items-center justify-center"><i class="fas fa-arrow-left mr-1"></i> Coach</a>
      <button id="refresh-btn" class="px-3 h-[44px] bg-primary text-white rounded text-sm font-semibold hover:bg-primary-dark transition-colors flex items-center justify-center"><i class="fas fa-sync-alt mr-1"></i> Refresh</button>
      <button id="export-csv-btn" class="px-3 h-[44px] bg-success text-white rounded text-sm font-semibold hover:bg-green-700 transition-colors flex items-center justify-center"><i class="fas fa-download mr-1"></i> Export</button>
    </div>
  </footer>

  <script src="js/archer_module.js"></script>
  <script src="js/common.js"></script>
  <script>
    // API Configuration
    const getApiBase = () => {
      if (typeof window !== 'undefined' && (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')) {
        const port = window.location.port || '8001';
        return `${window.location.protocol}//${window.location.hostname}:${port}/api/index.php/v1`;
      }
      return 'https://tryentist.com/wdv/api/v1';
    };
    const API_BASE = getApiBase();

    // State
    let allArcherData = [];
    let allEvents = [];
    let allRounds = []; // All unique rounds across events
    let selectedRounds = new Set(); // Selected round names
    let filteredData = [];
    let viewMode = 'simple'; // 'simple' or 'advanced'

    // Load all events and their results
    async function loadAllData() {
      try {
        showLoading();
        
        // Fetch all events
        const eventsRes = await fetch(`${API_BASE}/events/recent`);
        if (!eventsRes.ok) throw new Error(`HTTP ${eventsRes.status}`);
        const eventsData = await eventsRes.json();
        allEvents = eventsData.events || [];
        
        console.log('Loaded events:', allEvents);
        
        // Fetch snapshots for each event
        const archerMap = new Map(); // Map archer by unique key (name + school)
        
        for (const event of allEvents) {
          try {
            const snapshotRes = await fetch(`${API_BASE}/events/${event.id}/snapshot`);
            if (!snapshotRes.ok) continue;
            
            const snapshot = await snapshotRes.json();
            const divisions = snapshot.divisions || {};
            
            // Process each division
            for (const [divKey, divData] of Object.entries(divisions)) {
              const archers = divData.archers || [];
              
              for (const archer of archers) {
                const key = `${archer.firstName || ''}_${archer.lastName || ''}_${archer.school || ''}`.toLowerCase();
                
                if (!archerMap.has(key)) {
                  archerMap.set(key, {
                    firstName: archer.firstName || '',
                    lastName: archer.lastName || '',
                    school: archer.school || '',
                    level: archer.level || '',
                    gender: archer.gender || '',
                    rounds: {}
                  });
                }
                
                const archerData = archerMap.get(key);
                const total = archer.runningTotal || archer.total || 0;
                const arrowsShot = (archer.scorecard && archer.scorecard.ends) ? archer.scorecard.ends.length * 3 : 0;
                const avg = arrowsShot > 0 ? (total / arrowsShot) : 0;
                
                const roundKey = `${event.name}`;
                archerData.rounds[roundKey] = {
                  eventId: event.id,
                  eventName: event.name,
                  eventDate: event.date,
                  division: divKey,
                  total: total,
                  avg: avg,
                  avgPerArrow: avg,
                  xs: archer.xs || (archer.scorecard && archer.scorecard.xs) || 0,
                  tens: archer.tens || (archer.scorecard && archer.scorecard.tens) || 0,
                  status: archer.cardStatus || archer.status || 'PENDING',
                  faceSize: archer.targetSize || archer.target_size || null,
                  scorecard: archer.scorecard
                };
                
                // Track unique rounds
                if (!allRounds.find(r => r.key === roundKey)) {
                  allRounds.push({
                    key: roundKey,
                    name: event.name,
                    date: event.date,
                    eventId: event.id
                  });
                }
              }
            }
          } catch (err) {
            console.warn(`Failed to load snapshot for event ${event.id}:`, err);
          }
        }
        
        // Convert map to array
        allArcherData = Array.from(archerMap.values());
        
        console.log('Processed archer data:', allArcherData);
        
        if (allArcherData.length === 0) {
          showError('No archer data found. Make sure events have been scored.');
          return;
        }
        
        // Sort rounds by date
        allRounds.sort((a, b) => new Date(a.date) - new Date(b.date));
        
        // Select all rounds by default
        selectedRounds = new Set(allRounds.map(r => r.key));
        
        // Render round selector
        renderRoundSelector();
        
        // Apply initial filters and render
        applyFilters();
        
      } catch (err) {
        console.error('Error loading data:', err);
        showError('Failed to load data: ' + err.message);
      }
    }

    function renderRoundSelector() {
      const container = document.getElementById('round-checkboxes');
      container.innerHTML = '';
      
      allRounds.forEach(round => {
        const checkbox = document.createElement('label');
        checkbox.className = 'flex items-center gap-2 cursor-pointer p-2 sm:p-3 bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 rounded transition-colors';
        checkbox.innerHTML = `
          <input type="checkbox" value="${round.key}" ${selectedRounds.has(round.key) ? 'checked' : ''} class="w-5 h-5 text-primary rounded focus:ring-2 focus:ring-primary min-h-[24px] min-w-[24px]">
          <span class="text-sm sm:text-base text-gray-800 dark:text-white font-semibold">${round.name}</span>
          <span class="text-xs sm:text-sm text-gray-600 dark:text-gray-400">(${round.date})</span>
        `;
        
        checkbox.querySelector('input').addEventListener('change', function() {
          if (this.checked) {
            selectedRounds.add(round.key);
          } else {
            selectedRounds.delete(round.key);
          }
          applyFilters();
        });
        
        container.appendChild(checkbox);
      });
      
      document.getElementById('round-selector').classList.remove('hidden');
    }

    function applyFilters() {
      const divisionFilter = document.getElementById('filter-division').value;
      const genderFilter = document.getElementById('filter-gender').value;
      const targetSizeFilter = document.getElementById('filter-target-size').value;
      const searchTerm = document.getElementById('search-name').value.toLowerCase();
      const sortBy = document.getElementById('sort-by').value;
      
      // Filter
      filteredData = allArcherData.filter(archer => {
        // Division filter
        if (divisionFilter) {
          const hasMatchingDivision = Object.values(archer.rounds).some(round => {
            const level = archer.level || '';
            const divKey = round.division || '';
            if (divisionFilter === 'OPEN') return level.includes('OPEN') || divKey === 'OPEN';
            if (divisionFilter === 'VAR') return level.includes('VAR') || level.includes('Varsity');
            if (divisionFilter === 'JV') return level.includes('JV');
            return false;
          });
          if (!hasMatchingDivision) return false;
        }
        
        // Gender filter
        if (genderFilter && archer.gender !== genderFilter) return false;
        
        // Target size filter
        if (targetSizeFilter) {
          const hasMatchingTargetSize = Object.values(archer.rounds).some(round => {
            return round.faceSize && round.faceSize.toString() === targetSizeFilter;
          });
          if (!hasMatchingTargetSize) return false;
        }
        
        // Search filter
        if (searchTerm) {
          const fullName = `${archer.firstName} ${archer.lastName}`.toLowerCase();
          if (!fullName.includes(searchTerm)) return false;
        }
        
        return true;
      });
      
      // Calculate totals for sorting (only for selected rounds)
      filteredData.forEach(archer => {
        const selectedRoundScores = Object.entries(archer.rounds)
          .filter(([key, _]) => selectedRounds.has(key))
          .map(([_, round]) => round.total);
        
        // Only include scores > 0 for average calculation
        const nonZeroScores = selectedRoundScores.filter(score => score > 0);
        
        archer._maxScore = selectedRoundScores.length > 0 ? Math.max(...selectedRoundScores) : 0;
        archer._avgScore = nonZeroScores.length > 0 ? 
          nonZeroScores.reduce((sum, score) => sum + score, 0) / nonZeroScores.length : 0;
        archer._totalScore = selectedRoundScores.length > 0 ? selectedRoundScores.reduce((sum, score) => sum + score, 0) : 0;
        
        // Calculate X and 10 totals
        archer._xTotal = 0;
        archer._tenTotal = 0;
        Object.entries(archer.rounds)
          .filter(([key, _]) => selectedRounds.has(key))
          .forEach(([_, round]) => {
            archer._xTotal += round.xs || 0;
            archer._tenTotal += round.tens || 0;
          });
      });
      
      // Sort
      filteredData.sort((a, b) => {
        switch (sortBy) {
          case 'name':
            return `${a.firstName} ${a.lastName}`.localeCompare(`${b.firstName} ${b.lastName}`);
          case 'total-desc':
            return b._totalScore - a._totalScore;
          case 'total-asc':
            return a._totalScore - b._totalScore;
          case 'max-desc':
            return b._maxScore - a._maxScore;
          case 'max-asc':
            return a._maxScore - b._maxScore;
          case 'avg-desc':
            return b._avgScore - a._avgScore;
          case 'avg-asc':
            return a._avgScore - b._avgScore;
          default:
            return 0;
        }
      });
      
      renderPivotTable();
      updateStats();
    }

    function renderPivotTable() {
      if (filteredData.length === 0) {
        showError('No archers match the current filters.');
        return;
      }
      
      hideLoading();
      hideError();
      document.getElementById('pivot-container').classList.remove('hidden');
      document.getElementById('stats-summary').classList.remove('hidden');
      
      if (viewMode === 'simple') {
        renderSimpleView();
      } else {
        renderAdvancedView();
      }
    }

    function renderSimpleView() {
      // Get selected rounds only
      const sortedRounds = allRounds.filter(r => selectedRounds.has(r.key));
      
      if (sortedRounds.length === 0) {
        showError('Please select at least one round to display.');
        return;
      }
      
      // Build header
      const thead = document.getElementById('pivot-thead');
      thead.innerHTML = `
        <tr>
          <th class="px-1 sm:px-2 py-2 text-left font-semibold text-xs sm:text-sm">Rank</th>
          <th class="px-2 py-2 text-left font-semibold text-xs sm:text-sm">Archer</th>
          <th class="px-1 sm:px-2 py-2 text-left font-semibold text-xs sm:text-sm">Gender</th>
          <th class="px-1 sm:px-2 py-2 text-left font-semibold text-xs sm:text-sm">Face</th>
          ${sortedRounds.map(round => `<th class="px-1 sm:px-2 py-2 text-left font-semibold text-xs sm:text-sm">${round.name}</th>`).join('')}
          <th class="px-1 sm:px-2 py-2 text-left font-semibold text-xs sm:text-sm">MAX</th>
          <th class="px-1 sm:px-2 py-2 text-left font-semibold text-xs sm:text-sm">AVG</th>
          <th class="px-1 sm:px-2 py-2 text-left font-semibold text-xs sm:text-sm">Xs</th>
          <th class="px-1 sm:px-2 py-2 text-left font-semibold text-xs sm:text-sm">10s</th>
        </tr>
      `;
      
      // Build rows
      const tbody = document.getElementById('pivot-tbody');
      tbody.innerHTML = '';
      
      filteredData.forEach((archer, index) => {
        const row = document.createElement('tr');
        row.className = 'border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors';
        
        const rank = index + 1;
        const rankColor = rank === 1 ? 'text-rank-gold' : rank === 2 ? 'text-rank-silver' : rank === 3 ? 'text-rank-bronze' : 'text-gray-800 dark:text-white';
        
        // Get face size from first available round
        const faceSize = Object.values(archer.rounds).find(r => r.faceSize)?.faceSize || '-';
        
        // Gender display
        const genderText = archer.gender === 'M' ? 'M' : archer.gender === 'F' ? 'F' : '-';
        
        // Full name
        const fullName = `${archer.firstName} ${archer.lastName}`;
        
        let rowHTML = `
          <td class="px-1 sm:px-2 py-2 font-bold text-base sm:text-lg text-center ${rankColor}">${rank}</td>
          <td class="px-2 py-2 font-semibold text-xs sm:text-sm">${fullName}</td>
          <td class="px-1 sm:px-2 py-2 text-xs sm:text-sm">${genderText}</td>
          <td class="px-1 sm:px-2 py-2 text-xs sm:text-sm">${faceSize}</td>
        `;
        
        // Add score cells for each selected round
        sortedRounds.forEach(round => {
          const roundData = archer.rounds[round.key];
          if (roundData) {
            rowHTML += `<td class="px-1 sm:px-2 py-2 font-bold text-sm sm:text-base text-success cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-900" data-archer-index="${index}" data-round="${round.key}">${roundData.total}</td>`;
          } else {
            rowHTML += `<td class="px-1 sm:px-2 py-2 text-xs sm:text-sm text-gray-400 dark:text-gray-600">-</td>`;
          }
        });
        
        // Add max, average, X, and 10
        rowHTML += `
          <td class="px-1 sm:px-2 py-2 font-bold text-sm sm:text-base text-success">${archer._maxScore}</td>
          <td class="px-1 sm:px-2 py-2 text-xs sm:text-sm">${archer._avgScore.toFixed(1)}</td>
          <td class="px-1 sm:px-2 py-2 text-xs sm:text-sm">${archer._xTotal}</td>
          <td class="px-1 sm:px-2 py-2 text-xs sm:text-sm">${archer._tenTotal}</td>
        `;
        
        row.innerHTML = rowHTML;
        tbody.appendChild(row);
      });
      
      // Add click handlers for score cells
      tbody.querySelectorAll('td[data-archer-index]').forEach(cell => {
        cell.addEventListener('click', function() {
          const archerIndex = parseInt(this.dataset.archerIndex);
          const roundName = this.dataset.round;
          showScorecardForRound(archerIndex, roundName);
        });
      });
    }

    function renderAdvancedView() {
      // Get selected rounds only
      const sortedRounds = allRounds.filter(r => selectedRounds.has(r.key));
      
      if (sortedRounds.length === 0) {
        showError('Please select at least one round to display.');
        return;
      }
      
      // Build header with Score and Avg columns for each round
      const thead = document.getElementById('pivot-thead');
      let headerHTML = `
        <tr>
          <th class="px-1 sm:px-2 py-2 text-left font-semibold text-xs sm:text-sm" rowspan="2">Rank</th>
          <th class="px-2 py-2 text-left font-semibold text-xs sm:text-sm" rowspan="2">Archer</th>
          <th class="px-1 sm:px-2 py-2 text-left font-semibold text-xs sm:text-sm" rowspan="2">Gender</th>
          <th class="px-1 sm:px-2 py-2 text-left font-semibold text-xs sm:text-sm" rowspan="2">Face</th>
      `;
      
      sortedRounds.forEach(round => {
        headerHTML += `<th class="px-1 sm:px-2 py-2 text-center font-semibold text-xs sm:text-sm border-l-2 border-gray-300 dark:border-gray-600" colspan="2">${round.name}</th>`;
      });
      
      headerHTML += `
          <th class="px-1 sm:px-2 py-2 text-left font-semibold text-xs sm:text-sm border-l-2 border-gray-300 dark:border-gray-600" rowspan="2">MAX</th>
          <th class="px-1 sm:px-2 py-2 text-left font-semibold text-xs sm:text-sm" rowspan="2">AVG</th>
          <th class="px-1 sm:px-2 py-2 text-left font-semibold text-xs sm:text-sm" rowspan="2">Xs</th>
          <th class="px-1 sm:px-2 py-2 text-left font-semibold text-xs sm:text-sm" rowspan="2">10s</th>
        </tr>
        <tr>
      `;
      
      sortedRounds.forEach(round => {
        headerHTML += `
          <th class="px-1 py-2 text-center text-xs font-semibold border-l-2 border-gray-300 dark:border-gray-600">Score</th>
          <th class="px-1 py-2 text-center text-xs font-semibold">Avg/Arrow</th>
        `;
      });
      
      headerHTML += `</tr>`;
      thead.innerHTML = headerHTML;
      
      // Build rows
      const tbody = document.getElementById('pivot-tbody');
      tbody.innerHTML = '';
      
      filteredData.forEach((archer, index) => {
        const row = document.createElement('tr');
        row.className = 'border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors';
        
        const rank = index + 1;
        const rankColor = rank === 1 ? 'text-rank-gold' : rank === 2 ? 'text-rank-silver' : rank === 3 ? 'text-rank-bronze' : 'text-gray-800 dark:text-white';
        const fullName = `${archer.firstName} ${archer.lastName}`;
        const faceSize = Object.values(archer.rounds).find(r => r.faceSize)?.faceSize || '-';
        const genderText = archer.gender === 'M' ? 'M' : archer.gender === 'F' ? 'F' : '-';
        
        let rowHTML = `
          <td class="px-1 sm:px-2 py-2 font-bold text-base sm:text-lg text-center ${rankColor}">${rank}</td>
          <td class="px-2 py-2 font-semibold text-xs sm:text-sm">${fullName}</td>
          <td class="px-1 sm:px-2 py-2 text-xs sm:text-sm">${genderText}</td>
          <td class="px-1 sm:px-2 py-2 text-xs sm:text-sm">${faceSize}</td>
        `;
        
        // Add score and avg cells for each selected round
        sortedRounds.forEach(round => {
          const roundData = archer.rounds[round.key];
          if (roundData) {
            // Color code Avg/Arrow based on score (9.0+ = gold, 8.0+ = red, 7.0+ = blue, etc.)
            const avgPerArrow = roundData.avgPerArrow;
            let avgClass = 'text-gray-800 dark:text-gray-200';
            if (avgPerArrow >= 9.0) avgClass = 'text-rank-gold font-bold'; // Gold (X, 10, 9)
            else if (avgPerArrow >= 7.0) avgClass = 'text-red-600 dark:text-red-400 font-semibold'; // Red (8, 7)
            else if (avgPerArrow >= 5.0) avgClass = 'text-blue-600 dark:text-blue-400'; // Blue (6, 5)
            else if (avgPerArrow >= 3.0) avgClass = 'text-gray-700 dark:text-gray-400'; // Black (4, 3)
            
            rowHTML += `
              <td class="px-1 py-2 text-center font-bold text-sm sm:text-base text-success cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-900 border-l-2 border-gray-300 dark:border-gray-600" data-archer-index="${index}" data-round="${round.key}">${roundData.total}</td>
              <td class="px-1 py-2 text-center text-xs ${avgClass}">${roundData.avgPerArrow.toFixed(2)}</td>
            `;
          } else {
            rowHTML += `
              <td class="px-1 py-2 text-center text-xs sm:text-sm text-gray-400 dark:text-gray-600 border-l-2 border-gray-300 dark:border-gray-600">-</td>
              <td class="px-1 py-2 text-center text-xs sm:text-sm text-gray-400 dark:text-gray-600">-</td>
            `;
          }
        });
        
        // Add max, average, X, and 10
        rowHTML += `
          <td class="px-1 sm:px-2 py-2 font-bold text-sm sm:text-base text-success border-l-2 border-gray-300 dark:border-gray-600">${archer._maxScore}</td>
          <td class="px-1 sm:px-2 py-2 text-xs sm:text-sm">${archer._avgScore.toFixed(1)}</td>
          <td class="px-1 sm:px-2 py-2 text-xs sm:text-sm">${archer._xTotal}</td>
          <td class="px-1 sm:px-2 py-2 text-xs sm:text-sm">${archer._tenTotal}</td>
        `;
        
        row.innerHTML = rowHTML;
        tbody.appendChild(row);
      });
      
      // Add click handlers for score cells
      tbody.querySelectorAll('td[data-archer-index]').forEach(cell => {
        cell.addEventListener('click', function() {
          const archerIndex = parseInt(this.dataset.archerIndex);
          const roundName = this.dataset.round;
          showScorecardForRound(archerIndex, roundName);
        });
      });
    }

    function showScorecardForRound(archerIndex, roundName) {
      const archer = filteredData[archerIndex];
      const round = archer.rounds[roundName];
      
      if (!round || !round.scorecard || !round.scorecard.ends) {
        alert('No scorecard data available for this round.');
        return;
      }
      
      // Extract scores
      const scores = round.scorecard.ends.map(end => [
        end.a1 || '', 
        end.a2 || '', 
        end.a3 || ''
      ]);
      
      const archerData = {
        id: archer.id,
        firstName: archer.firstName,
        lastName: archer.lastName,
        school: archer.school,
        level: archer.level,
        gender: archer.gender,
        scores: scores,
        cardStatus: round.status,
        verified: round.status === 'VER',
        completed: round.status !== 'VOID'
      };
      
      const roundData = {
        totalEnds: 10,
        eventName: roundName,
        division: round.division,
        roundType: 'R300'
      };
      
      // Build editUrl for Scorecard Editor (coach-only)
      // roundArcherId might be in round object or scorecard
      let editUrl = null;
      const roundArcherId = round.roundArcherId || round.round_archer_id || round.scorecard?.roundArcherId || round.scorecard?.id;
      if (roundArcherId) {
        editUrl = `scorecard_editor.html?id=${roundArcherId}&mode=coach`;
      }
      
      if (typeof ScorecardView !== 'undefined') {
        ScorecardView.showScorecardModal(archerData, roundData, { editUrl });
      }
    }

    function updateStats() {
      const totalArchers = filteredData.length;
      const roundsSet = new Set();
      let highestScore = 0;
      let totalScoreSum = 0;
      let scoreCount = 0;
      
      filteredData.forEach(archer => {
        Object.keys(archer.rounds).forEach(roundName => {
          roundsSet.add(roundName);
          const score = archer.rounds[roundName].total;
          if (score > highestScore) highestScore = score;
          totalScoreSum += score;
          scoreCount++;
        });
      });
      
      const avgScore = scoreCount > 0 ? (totalScoreSum / scoreCount).toFixed(1) : 0;
      
      document.getElementById('stat-total-archers').textContent = totalArchers;
      document.getElementById('stat-total-rounds').textContent = roundsSet.size;
      document.getElementById('stat-highest-score').textContent = highestScore;
      document.getElementById('stat-avg-score').textContent = avgScore;
    }

    function exportToCSV() {
      if (filteredData.length === 0) {
        alert('No data to export');
        return;
      }
      
      // Get selected rounds only
      const sortedRounds = allRounds.filter(r => selectedRounds.has(r.key));
      
      // Build CSV
      let csv = 'Rank,Archer,Gender,Face,' + sortedRounds.map(r => r.name).join(',') + ',MAX,AVG,Xs,10s\n';
      
      filteredData.forEach((archer, index) => {
        const rank = index + 1;
        const fullName = `"${archer.firstName} ${archer.lastName}"`;
        const gender = archer.gender || '';
        const faceSize = Object.values(archer.rounds).find(r => r.faceSize)?.faceSize || '';
        
        const scores = sortedRounds.map(round => {
          const roundData = archer.rounds[round.key];
          return roundData ? roundData.total : '';
        }).join(',');
        
        csv += `${rank},${fullName},${gender},${faceSize},${scores},${archer._maxScore},${archer._avgScore.toFixed(1)},${archer._xTotal},${archer._tenTotal}\n`;
      });
      
      // Download
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `archer_results_pivot_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      window.URL.revokeObjectURL(url);
    }

    function showLoading() {
      document.getElementById('loading-state').classList.remove('hidden');
      document.getElementById('error-state').classList.add('hidden');
      document.getElementById('pivot-container').classList.add('hidden');
      document.getElementById('stats-summary').classList.add('hidden');
    }

    function hideLoading() {
      document.getElementById('loading-state').classList.add('hidden');
    }

    function showError(message) {
      document.getElementById('error-state').classList.remove('hidden');
      document.getElementById('error-message').textContent = message;
      document.getElementById('loading-state').classList.add('hidden');
      document.getElementById('pivot-container').classList.add('hidden');
      document.getElementById('stats-summary').classList.add('hidden');
    }

    function hideError() {
      document.getElementById('error-state').classList.add('hidden');
    }

    // Collapsible panel toggle
    document.getElementById('toggle-round-selector').addEventListener('click', function() {
      const content = document.getElementById('round-selector-content');
      const chevron = document.getElementById('round-selector-chevron');
      if (content.style.display === 'none') {
        content.style.display = 'block';
        chevron.style.transform = 'rotate(0deg)';
      } else {
        content.style.display = 'none';
        chevron.style.transform = 'rotate(-90deg)';
      }
    });
    
    document.getElementById('toggle-filters').addEventListener('click', function() {
      const content = document.getElementById('filters-content');
      const chevron = document.getElementById('filters-chevron');
      if (content.style.display === 'none') {
        content.style.display = 'block';
        chevron.style.transform = 'rotate(0deg)';
      } else {
        content.style.display = 'none';
        chevron.style.transform = 'rotate(-90deg)';
      }
    });

    // Event listeners
    document.getElementById('reset-filters-btn').addEventListener('click', () => {
      document.getElementById('filter-division').value = '';
      document.getElementById('filter-gender').value = '';
      document.getElementById('filter-target-size').value = '';
      document.getElementById('search-name').value = '';
      document.getElementById('sort-by').value = 'name';
      applyFilters();
    });
    document.getElementById('refresh-btn').addEventListener('click', loadAllData);
    document.getElementById('export-csv-btn').addEventListener('click', exportToCSV);
    
    // Real-time filtering and sorting
    document.getElementById('filter-division').addEventListener('change', applyFilters);
    document.getElementById('filter-gender').addEventListener('change', applyFilters);
    document.getElementById('filter-target-size').addEventListener('change', applyFilters);
    document.getElementById('search-name').addEventListener('input', applyFilters);
    document.getElementById('sort-by').addEventListener('change', applyFilters);
    
    // View mode toggle
    document.getElementById('simple-view-btn').addEventListener('click', function() {
      viewMode = 'simple';
      this.classList.add('bg-primary', 'text-white');
      this.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-800', 'dark:text-white');
      document.getElementById('advanced-view-btn').classList.remove('bg-primary', 'text-white');
      document.getElementById('advanced-view-btn').classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-800', 'dark:text-white');
      renderPivotTable();
    });
    
    document.getElementById('advanced-view-btn').addEventListener('click', function() {
      viewMode = 'advanced';
      this.classList.add('bg-primary', 'text-white');
      this.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-800', 'dark:text-white');
      document.getElementById('simple-view-btn').classList.remove('bg-primary', 'text-white');
      document.getElementById('simple-view-btn').classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-800', 'dark:text-white');
      renderPivotTable();
    });
    
    // Round selector buttons
    document.getElementById('select-all-rounds-btn').addEventListener('click', () => {
      selectedRounds = new Set(allRounds.map(r => r.key));
      renderRoundSelector();
      applyFilters();
    });
    
    document.getElementById('deselect-all-rounds-btn').addEventListener('click', () => {
      selectedRounds.clear();
      renderRoundSelector();
      applyFilters();
    });

    // Load data on page load
    document.addEventListener('DOMContentLoaded', loadAllData);
  </script>
</body>
</html>

