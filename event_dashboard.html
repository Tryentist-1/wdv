<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Event Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="css/tailwind-compiled.css">
  <script src="js/common.js"></script>
  <script>
    // Initialize dark mode immediately (before DOMContentLoaded) to prevent flash
    // Dark mode preference is set from the home screen (index.html)
    if (typeof initDarkMode === 'function') {
      initDarkMode();
    } else {
      // Fallback if common.js not loaded yet
      (function () {
        const savedTheme = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
      })();
    }
  </script>
  <style>
    /* Custom color utilities */
    .bg-primary {
      background-color: #0d6efd !important;
    }

    .bg-primary-dark {
      background-color: #0a58ca !important;
    }

    .bg-success {
      background-color: #198754 !important;
    }

    .bg-success-dark {
      background-color: #157347 !important;
    }

    .bg-danger {
      background-color: #dc3545 !important;
    }

    .text-primary {
      color: #0d6efd !important;
    }

    .text-success {
      color: #198754 !important;
    }

    .text-danger {
      color: #dc3545 !important;
    }

    .hover\:bg-primary-dark:hover {
      background-color: #0a58ca !important;
    }

    .hover\:bg-success-dark:hover {
      background-color: #157347 !important;
    }
  </style>
</head>

<body class="bg-gray-50 dark:bg-gray-900 min-h-screen transition-colors duration-200">
  <!-- Main Content -->
  <div class="max-w-7xl mx-auto px-4 py-6 pb-[calc(48px+env(safe-area-inset-bottom))]">
    <!-- Event Header -->
    <div id="event-header"
      class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6 transition-colors duration-200">
      <div class="flex justify-between items-start mb-4">
        <div>
          <h1 id="event-name" class="text-3xl font-bold text-gray-800 dark:text-white mb-2">Loading...</h1>
          <div class="flex gap-4 text-gray-600 dark:text-gray-400 text-sm">
            <span>üìÖ <span id="event-date">-</span></span>
            <span>üìä Status: <span id="event-status" class="font-semibold">-</span></span>
            <span id="last-updated" class="text-xs">Last updated: -</span>
          </div>
        </div>
        <div class="flex gap-2">
          <button id="refresh-btn"
            class="px-4 py-2 bg-primary hover:bg-primary-dark text-white rounded font-semibold transition-colors">üîÑ
            Refresh</button>
        </div>
      </div>

      <!-- Overall Progress Bar -->
      <div class="mb-4">
        <div class="flex justify-between items-center mb-2">
          <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Overall Progress</span>
          <span id="overall-progress-text" class="text-sm font-semibold text-gray-800 dark:text-white">0%</span>
        </div>
        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-4">
          <div id="overall-progress-bar" class="bg-primary h-4 rounded-full transition-all duration-300"
            style="width: 0%"></div>
        </div>
      </div>

      <!-- Quick Stats -->
      <div id="quick-stats" class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
        <!-- Populated dynamically -->
      </div>
    </div>

    <!-- Rounds Section -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6 transition-colors duration-200">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Ranking Rounds</h2>
        <button id="toggle-rounds"
          class="px-3 py-1 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded text-sm hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
          <span id="rounds-toggle-text">Collapse All</span>
        </button>
      </div>
      <div id="rounds-list" class="space-y-3">
        <div class="text-center text-gray-500 dark:text-gray-400 py-8">Loading rounds...</div>
      </div>
    </div>

    <!-- Brackets Section -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6 transition-colors duration-200">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Brackets</h2>
        <button id="toggle-brackets"
          class="px-3 py-1 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded text-sm hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
          <span id="brackets-toggle-text">Collapse All</span>
        </button>
      </div>
      <div id="brackets-list" class="space-y-3">
        <div class="text-center text-gray-500 dark:text-gray-400 py-8">Loading brackets...</div>
      </div>
    </div>

    <!-- Bale Assignments Section -->
    <div id="bale-assignments-section" class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6 transition-colors duration-200 hidden">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Bale Assignments</h2>
        <div class="flex gap-2">
          <select id="bale-round-filter" class="px-3 py-2 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-white rounded border border-gray-300 dark:border-gray-600 text-sm min-h-[44px]">
            <option value="latest">Latest Round</option>
            <option value="all">All Rounds</option>
          </select>
          <button id="print-bale-btn" class="px-3 py-2 bg-primary hover:bg-primary-dark text-white rounded font-semibold text-sm transition-colors min-h-[44px] flex items-center gap-1">
            <i class="fas fa-print"></i> Print
          </button>
        </div>
      </div>
      <div id="bale-assignments-content" class="space-y-6">
        <div class="text-center text-gray-500 dark:text-gray-400 py-8">Loading bale assignments...</div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer
    class="fixed bottom-0 left-0 right-0 h-[48px] bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 shadow-lg transition-colors duration-200 z-10 safe-area-bottom">
    <div class="max-w-7xl mx-auto flex items-center h-full px-4 gap-2">
      <a href="index.html"
        class="min-w-[48px] h-[48px] text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white active:bg-gray-100 dark:active:bg-gray-700 rounded-lg transition-colors flex items-center justify-center"
        aria-label="Home">
        <i class="fas fa-home text-2xl"></i>
      </a>
      <div class="flex-1"></div>
      <a href="coach.html"
        class="px-3 h-[44px] bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors flex items-center justify-center"><i
          class="fas fa-arrow-left mr-1"></i> Back to Coach Console</a>
      <button id="footer-refresh-btn"
        class="px-3 h-[44px] bg-primary hover:bg-primary-dark text-white rounded font-semibold transition-colors flex items-center justify-center"><i
          class="fas fa-sync-alt mr-1"></i> Refresh</button>
    </div>
  </footer>

  <script>
    // API Base URL detection
    function getApiBase() {
      const { protocol, hostname, port } = window.location;
      if (hostname === 'localhost' || hostname === '127.0.0.1') {
        const resolvedPort = port || '8001';
        return `${protocol}//${hostname}:${resolvedPort}/api/index.php/v1`;
      }
      return 'https://archery.tryentist.com/api/v1';
    }

    const API_BASE = getApiBase();
    const COACH_PASSCODE = 'wdva26'; // Coach passcode for API authentication

    // Get event ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const eventId = urlParams.get('event');

    // State
    let overviewData = null;
    let autoRefreshInterval = null;
    let roundsExpanded = true;
    let bracketsExpanded = true;

    // Division names mapping
    const DIVISION_NAMES = {
      'OPEN': 'Open (Mixed)',
      'BVAR': 'Boys Varsity',
      'GVAR': 'Girls Varsity',
      'BJV': 'Boys JV',
      'GJV': 'Girls JV'
    };

    // API request helper
    /**
     * Makes an authenticated API request.
     * @param {string} path - API path (e.g. /events/123/overview)
     * @param {string} method - HTTP method (GET, POST, PATCH, etc.)
     * @param {Object|null} body - Optional JSON body for POST/PATCH requests
     * @returns {Promise<Object>} Parsed JSON response
     */
    async function apiRequest(path, method = 'GET', body = null) {
      const headers = {
        'Content-Type': 'application/json',
        'X-Passcode': COACH_PASSCODE,
        'X-API-Key': COACH_PASSCODE
      };

      const options = { method, headers };
      if (body && method !== 'GET') {
        options.body = JSON.stringify(body);
      }

      const res = await fetch(`${API_BASE}${path}`, options);

      if (!res.ok) {
        const text = await res.text();
        throw new Error(`HTTP ${res.status}: ${text}`);
      }

      return res.json();
    }

    // Load event overview
    async function loadOverview() {
      if (!eventId) {
        alert('No event ID provided');
        window.location.href = 'coach.html';
        return;
      }

      try {
        const data = await apiRequest(`/events/${eventId}/overview`);
        console.log('[Dashboard] API Response:', data);
        console.log('[Dashboard] Event Status:', data.event?.status);
        console.log('[Dashboard] Total Scorecards:', data.summary?.total_scorecards);
        overviewData = data;
        renderDashboard(data);
        updateLastUpdated();
      } catch (err) {
        console.error('Error loading overview:', err);
        document.getElementById('event-name').textContent = 'Error Loading Event';
        document.getElementById('rounds-list').innerHTML = `<div class="text-center text-red-500 py-8">Error: ${err.message}</div>`;
        document.getElementById('brackets-list').innerHTML = `<div class="text-center text-red-500 py-8">Error: ${err.message}</div>`;
      }
    }

    // Render dashboard
    function renderDashboard(data) {
      const { event, summary, rounds, brackets } = data;

      // Update event header
      document.getElementById('event-name').textContent = event.name;
      document.getElementById('event-date').textContent = new Date(event.date + 'T00:00:00').toLocaleDateString('en-US', {
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
      });

      // Status badge
      const statusColors = {
        'Planned': 'bg-gray-400 dark:bg-gray-500',
        'Active': 'bg-success',
        'Completed': 'bg-gray-600 dark:bg-gray-700'
      };
      const statusEl = document.getElementById('event-status');
      statusEl.textContent = event.status;
      statusEl.className = `font-semibold px-2 py-1 rounded text-xs text-white ${statusColors[event.status] || 'bg-gray-400'}`;

      // Overall progress
      const progress = summary.overall_progress || 0;
      document.getElementById('overall-progress-text').textContent = `${progress}%`;
      document.getElementById('overall-progress-bar').style.width = `${progress}%`;

      // Quick stats
      renderQuickStats(summary);

      // Rounds
      renderRounds(rounds);

      // Brackets
      renderBrackets(brackets);

      // Load Swiss round progress for each Swiss bracket
      if (brackets && brackets.length > 0) {
        brackets.filter(b => b.format === 'SWISS').forEach(b => loadSwissProgress(b.id));
      }

      // Load bale assignments for events with Swiss brackets
      const hasSwissBrackets = brackets && brackets.some(b => b.format === 'SWISS');
      if (hasSwissBrackets) {
        loadBaleAssignments(eventId);
      }

      // Setup auto-refresh if event is Active
      if (event.status === 'Active') {
        startAutoRefresh();
      } else {
        stopAutoRefresh();
      }
    }

    // Render quick stats
    function renderQuickStats(summary) {
      const container = document.getElementById('quick-stats');
      container.innerHTML = `
        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
          <div class="text-sm text-gray-600 dark:text-gray-400 mb-1">Rounds</div>
          <div class="text-2xl font-bold text-gray-800 dark:text-white">
            ${summary.completed_rounds}/${summary.total_rounds}
          </div>
          <div class="text-xs text-gray-500 dark:text-gray-400">completed</div>
        </div>
        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
          <div class="text-sm text-gray-600 dark:text-gray-400 mb-1">Brackets</div>
          <div class="text-2xl font-bold text-gray-800 dark:text-white">
            ${summary.completed_brackets}/${summary.total_brackets}
          </div>
          <div class="text-xs text-gray-500 dark:text-gray-400">completed</div>
        </div>
        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
          <div class="text-sm text-gray-600 dark:text-gray-400 mb-1">Archers</div>
          <div class="text-2xl font-bold text-gray-800 dark:text-white">
            ${summary.total_archers}
          </div>
          <div class="text-xs text-gray-500 dark:text-gray-400">participating</div>
        </div>
        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
          <div class="text-sm text-gray-600 dark:text-gray-400 mb-1">Matches</div>
          <div class="text-2xl font-bold text-gray-800 dark:text-white">
            ${summary.completed_matches}/${summary.total_matches}
          </div>
          <div class="text-xs text-gray-500 dark:text-gray-400">completed</div>
        </div>
      `;
    }

    // Render rounds
    function renderRounds(rounds) {
      const container = document.getElementById('rounds-list');

      if (!rounds || rounds.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-8">No rounds configured for this event yet.</div>';
        return;
      }

      container.innerHTML = rounds.map(round => {
        const divisionName = DIVISION_NAMES[round.division] || round.division;
        const progress = round.progress_percentage || 0;
        const progressColor = progress >= 90 ? 'bg-success' : progress >= 50 ? 'bg-yellow-500' : 'bg-orange-500';
        const isExpanded = roundsExpanded;

        return `
          <div class="border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">
            <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors" onclick="toggleRound('${round.id}')">
              <div class="flex justify-between items-center">
                <div class="flex-1">
                  <div class="font-semibold text-gray-800 dark:text-white">
                    ${divisionName} - ${round.round_type}
                  </div>
                  <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                    ${round.completed_scorecards}/${round.total_scorecards} scorecards completed
                    ${round.started_scorecards !== undefined ? ` ‚Ä¢ ${round.started_scorecards} of ${round.total_scorecards} started` : ''}
                    ${round.not_started_scorecards !== undefined && round.not_started_scorecards > 0 ? ` ‚Ä¢ ${round.not_started_scorecards} not started` : ''}
                    ${round.bale_count > 0 ? ` ‚Ä¢ ${round.bale_count} bales` : ''}
                    ${round.average_score ? ` ‚Ä¢ Avg: ${round.average_score}` : ''}
                  </div>
                </div>
                <div class="flex items-center gap-3">
                  <div class="text-right">
                    <div class="text-sm font-semibold text-gray-800 dark:text-white">${progress}%</div>
                    <div class="w-24 bg-gray-200 dark:bg-gray-600 rounded-full h-2 mt-1">
                      <div class="${progressColor} h-2 rounded-full transition-all duration-300" style="width: ${progress}%"></div>
                    </div>
                  </div>
                  <span class="text-gray-400">${isExpanded ? '‚ñº' : '‚ñ∂'}</span>
                </div>
              </div>
            </div>
            <div id="round-${round.id}" class="${isExpanded ? '' : 'hidden'} px-4 py-3 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700">
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                <div>
                  <span class="text-gray-600 dark:text-gray-400">Status:</span>
                  <span class="ml-2 font-semibold text-gray-800 dark:text-white">${round.status}</span>
                </div>
                <div>
                  <span class="text-gray-600 dark:text-gray-400">Archers:</span>
                  <span class="ml-2 font-semibold text-gray-800 dark:text-white">${round.archer_count}</span>
                </div>
                <div>
                  <span class="text-gray-600 dark:text-gray-400">Started:</span>
                  <span class="ml-2 font-semibold text-gray-800 dark:text-white">${round.started_scorecards !== undefined ? `${round.started_scorecards} of ${round.total_scorecards}` : '0'}</span>
                </div>
                <div>
                  <span class="text-gray-600 dark:text-gray-400">Not Started:</span>
                  <span class="ml-2 font-semibold text-gray-800 dark:text-white">${round.not_started_scorecards !== undefined ? round.not_started_scorecards : round.total_scorecards}</span>
                </div>
                <div>
                  <span class="text-gray-600 dark:text-gray-400">Bales:</span>
                  <span class="ml-2 font-semibold text-gray-800 dark:text-white">${round.bale_count}</span>
                </div>
                <div>
                  <span class="text-gray-600 dark:text-gray-400">Completed:</span>
                  <span class="ml-2 font-semibold text-gray-800 dark:text-white">${round.completed_scorecards}/${round.total_scorecards}</span>
                </div>
              </div>
              <div class="flex gap-2 mt-4">
                <a href="results.html?event=${eventId}&division=${round.division}" class="px-4 py-2 bg-primary hover:bg-primary-dark text-white rounded font-semibold text-sm transition-colors">
                  üìä View Results
                </a>
                <a href="coach.html?manageRoster=${round.id}&roundName=${encodeURIComponent(divisionName + ' - ' + round.round_type)}" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded font-semibold text-sm transition-colors">
                  üë• Manage Roster
                </a>
                <a href="coach.html" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded font-semibold text-sm hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                  üõ°Ô∏è Verify
                </a>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Render brackets
    function renderBrackets(brackets) {
      const container = document.getElementById('brackets-list');

      if (!brackets || brackets.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-8">No brackets created for this event yet.</div>';
        return;
      }

      container.innerHTML = brackets.map(bracket => {
        const progress = bracket.progress_percentage || 0;
        const progressColor = progress >= 90 ? 'bg-success' : progress >= 50 ? 'bg-yellow-500' : 'bg-orange-500';
        const isExpanded = bracketsExpanded;
        const bracketTypeName = bracket.bracket_type === 'SOLO' ? 'Solo' : 'Team';
        const formatName = bracket.format === 'ELIMINATION' ? 'Elimination' : 'Swiss';
        const divisionName = DIVISION_NAMES[bracket.division] || bracket.division;

        return `
          <div class="border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">
            <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors" onclick="toggleBracket('${bracket.id}')">
              <div class="flex justify-between items-center">
                <div class="flex-1">
                  <div class="font-semibold text-gray-800 dark:text-white">
                    ${bracketTypeName} ${formatName} - ${divisionName}
                  </div>
                  <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                    ${bracket.completed_matches}/${bracket.total_matches} matches completed
                    ${bracket.entry_count > 0 ? ` ‚Ä¢ ${bracket.entry_count} entries` : ''}
                  </div>
                </div>
                <div class="flex items-center gap-3">
                  <div class="text-right">
                    <div class="text-sm font-semibold text-gray-800 dark:text-white">${progress}%</div>
                    <div class="w-24 bg-gray-200 dark:bg-gray-600 rounded-full h-2 mt-1">
                      <div class="${progressColor} h-2 rounded-full transition-all duration-300" style="width: ${progress}%"></div>
                    </div>
                  </div>
                  <span class="text-gray-400">${isExpanded ? '‚ñº' : '‚ñ∂'}</span>
                </div>
              </div>
            </div>
            <div id="bracket-${bracket.id}" class="${isExpanded ? '' : 'hidden'} px-4 py-3 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700">
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                <div>
                  <span class="text-gray-600 dark:text-gray-400">Status:</span>
                  <span class="ml-2 font-semibold text-gray-800 dark:text-white">${bracket.status}</span>
                </div>
                <div>
                  <span class="text-gray-600 dark:text-gray-400">Format:</span>
                  <span class="ml-2 font-semibold text-gray-800 dark:text-white">${formatName}</span>
                </div>
                <div>
                  <span class="text-gray-600 dark:text-gray-400">Entries:</span>
                  <span class="ml-2 font-semibold text-gray-800 dark:text-white">${bracket.entry_count}</span>
                </div>
                <div>
                  <span class="text-gray-600 dark:text-gray-400">Matches:</span>
                  <span class="ml-2 font-semibold text-gray-800 dark:text-white">${bracket.completed_matches}/${bracket.total_matches}</span>
                </div>
              </div>
              ${bracket.format === 'SWISS' ? `
              <div id="swiss-progress-${bracket.id}" class="mt-3 text-sm text-gray-600 dark:text-gray-400"></div>
              ` : ''}
              <div class="flex gap-2 mt-4 flex-wrap">
                <a href="bracket_results.html?bracket=${bracket.id}" class="px-4 py-2 bg-primary hover:bg-primary-dark text-white rounded font-semibold text-sm transition-colors">
                  üìä View Bracket
                </a>
                ${bracket.format === 'ELIMINATION' && (bracket.status === 'OPEN' || bracket.entry_count === 0) ? `
                <button onclick="generateBracket('${bracket.id}')" id="generate-btn-${bracket.id}" class="px-4 py-2 bg-success hover:bg-success-dark text-white rounded font-semibold text-sm transition-colors">
                  üéØ Generate from Top 8
                </button>
                ` : ''}
                ${bracket.format === 'SWISS' && bracket.status !== 'COMPLETED' ? `
                <button onclick="generateSwissRound('${bracket.id}')" id="swiss-gen-btn-${bracket.id}" class="px-4 py-2 bg-primary hover:bg-primary-dark text-white rounded font-semibold text-sm transition-colors min-h-[44px]">
                  <i class="fas fa-plus-circle"></i> Next Round
                </button>
                ` : ''}
                <a href="coach.html?event=${bracket.event_id}&editBracket=${bracket.id}" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded font-semibold text-sm hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors inline-block text-center">
                  ‚úèÔ∏è Edit
                </a>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Toggle round expansion
    function toggleRound(roundId) {
      const element = document.getElementById(`round-${roundId}`);
      if (element) {
        element.classList.toggle('hidden');
      }
    }

    // Toggle bracket expansion
    function toggleBracket(bracketId) {
      const element = document.getElementById(`bracket-${bracketId}`);
      if (element) {
        element.classList.toggle('hidden');
      }
    }

    // Toggle all rounds
    function toggleAllRounds() {
      roundsExpanded = !roundsExpanded;
      document.getElementById('rounds-toggle-text').textContent = roundsExpanded ? 'Collapse All' : 'Expand All';
      overviewData?.rounds?.forEach(round => {
        const element = document.getElementById(`round-${round.id}`);
        if (element) {
          if (roundsExpanded) {
            element.classList.remove('hidden');
          } else {
            element.classList.add('hidden');
          }
        }
      });
    }

    // Toggle all brackets
    function toggleAllBrackets() {
      bracketsExpanded = !bracketsExpanded;
      document.getElementById('brackets-toggle-text').textContent = bracketsExpanded ? 'Collapse All' : 'Expand All';
      overviewData?.brackets?.forEach(bracket => {
        const element = document.getElementById(`bracket-${bracket.id}`);
        if (element) {
          if (bracketsExpanded) {
            element.classList.remove('hidden');
          } else {
            element.classList.add('hidden');
          }
        }
      });
    }

    // Update last updated timestamp
    function updateLastUpdated() {
      const now = new Date();
      const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
      document.getElementById('last-updated').textContent = `Last updated: ${timeStr}`;
    }

    // Start auto-refresh
    function startAutoRefresh() {
      stopAutoRefresh(); // Clear any existing interval
      autoRefreshInterval = setInterval(() => {
        loadOverview();
      }, 30000); // 30 seconds
    }

    // Stop auto-refresh
    function stopAutoRefresh() {
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
      }
    }

    // ==================== Bale Assignments View ====================

    /** Division code to display name mapping */
    const BALE_DIVISION_LABELS = {
      BVAR: 'Boys Varsity', GVAR: 'Girls Varsity',
      BJV: 'Boys JV', GJV: 'Girls JV', OPEN: 'Open (Mixed)'
    };

    /** Current bale data cache for print */
    let cachedBaleData = null;

    /**
     * Loads all solo and team matches for an event, groups them by bale,
     * and renders the bale assignments view.
     * @param {string} evtId - Event UUID
     */
    async function loadBaleAssignments(evtId) {
      const section = document.getElementById('bale-assignments-section');
      const container = document.getElementById('bale-assignments-content');

      try {
        const [soloData, teamData] = await Promise.all([
          apiRequest(`/events/${evtId}/solo-matches`),
          apiRequest(`/events/${evtId}/team-matches`)
        ]);

        const soloMatches = soloData.matches || [];
        const teamMatches = teamData.matches || [];

        if (soloMatches.length === 0 && teamMatches.length === 0) {
          section.classList.add('hidden');
          return;
        }

        section.classList.remove('hidden');
        cachedBaleData = { soloMatches, teamMatches };

        // Populate round filter options
        populateRoundFilter(soloMatches, teamMatches);

        // Render with current filter
        renderBaleAssignmentsView(soloMatches, teamMatches);
      } catch (err) {
        console.error('Error loading bale assignments:', err);
        container.innerHTML = `<div class="text-center text-red-500 py-4">Error: ${err.message}</div>`;
        section.classList.remove('hidden');
      }
    }

    /**
     * Populates the round filter dropdown with available rounds.
     * @param {Array} soloMatches - Solo match objects
     * @param {Array} teamMatches - Team match objects
     */
    function populateRoundFilter(soloMatches, teamMatches) {
      const select = document.getElementById('bale-round-filter');
      const rounds = new Set();

      soloMatches.forEach(m => {
        if (m.bracket_match_id) rounds.add(m.bracket_match_id);
      });
      teamMatches.forEach(m => {
        if (m.bracket_match_id) rounds.add(m.bracket_match_id);
      });

      const sortedRounds = [...rounds].sort((a, b) => {
        const numA = parseInt((a.match(/\d+/) || [0])[0]);
        const numB = parseInt((b.match(/\d+/) || [0])[0]);
        return numA - numB;
      });

      // Keep existing options, add round-specific ones
      const existingValues = ['latest', 'all'];
      // Remove old round options
      [...select.options].forEach(opt => {
        if (!existingValues.includes(opt.value)) opt.remove();
      });

      sortedRounds.forEach(r => {
        const opt = document.createElement('option');
        opt.value = r;
        opt.textContent = r;
        select.appendChild(opt);
      });
    }

    /**
     * Renders the bale assignments grid from match data.
     * Groups matches by bale number and shows who is on each target.
     * @param {Array} soloMatches - Solo match objects
     * @param {Array} teamMatches - Team match objects
     */
    function renderBaleAssignmentsView(soloMatches, teamMatches) {
      const container = document.getElementById('bale-assignments-content');
      const filterValue = document.getElementById('bale-round-filter').value;

      // Filter matches by round if needed
      let filteredSolo = soloMatches;
      let filteredTeam = teamMatches;

      if (filterValue === 'latest') {
        // Find the highest round number
        let maxRound = 0;
        let maxRoundLabel = '';
        soloMatches.forEach(m => {
          const match = (m.bracket_match_id || '').match(/Round\s+(\d+)/i);
          if (match) {
            const rn = parseInt(match[1]);
            if (rn > maxRound) { maxRound = rn; maxRoundLabel = m.bracket_match_id; }
          }
        });
        teamMatches.forEach(m => {
          const match = (m.bracket_match_id || '').match(/Round\s+(\d+)/i);
          if (match) {
            const rn = parseInt(match[1]);
            if (rn > maxRound) { maxRound = rn; maxRoundLabel = m.bracket_match_id; }
          }
        });

        if (maxRoundLabel) {
          filteredSolo = soloMatches.filter(m => m.bracket_match_id === maxRoundLabel);
          filteredTeam = teamMatches.filter(m => m.bracket_match_id === maxRoundLabel);
        }
      } else if (filterValue !== 'all') {
        filteredSolo = soloMatches.filter(m => m.bracket_match_id === filterValue);
        filteredTeam = teamMatches.filter(m => m.bracket_match_id === filterValue);
      }

      // Build bale map: baleNumber -> { line1: {...}, line2: {...} }
      const bales = {};

      filteredSolo.forEach(m => {
        const baleNum = m.bale_number;
        if (!baleNum) return;
        if (!bales[baleNum]) bales[baleNum] = {};

        const lineKey = `line${m.line_number || 1}`;
        const a1 = m.archer1 || {};
        const a2 = m.archer2 || {};
        const targets = m.line_number === 2 ? ['C', 'D'] : ['A', 'B'];

        bales[baleNum][lineKey] = {
          type: 'solo',
          round: m.bracket_match_id,
          bracketName: m.bracket_name || '',
          status: m.card_status || 'PENDING',
          wave: m.wave,
          matchId: m.id,
          slots: [
            { target: a1.target_assignment || targets[0], name: a1.archer_name || '‚Äî', school: a1.school || '' },
            { target: a2.target_assignment || targets[1], name: a2.archer_name || '‚Äî', school: a2.school || '' }
          ]
        };
      });

      filteredTeam.forEach(m => {
        const baleNum = m.bale_number;
        if (!baleNum) return;
        if (!bales[baleNum]) bales[baleNum] = {};

        const lineKey = `line${m.line_number || 1}`;
        const t1 = m.team1 || {};
        const t2 = m.team2 || {};
        const targets = m.line_number === 2 ? ['C', 'D'] : ['A', 'B'];

        const t1Archers = (t1.archers || []).map(a => a.archer_name).join(', ');
        const t2Archers = (t2.archers || []).map(a => a.archer_name).join(', ');

        bales[baleNum][lineKey] = {
          type: 'team',
          round: m.bracket_match_id,
          bracketName: m.bracket_name || '',
          status: m.card_status || 'PENDING',
          wave: m.wave,
          matchId: m.id,
          slots: [
            { target: targets[0], name: t1.team_name || t1.school || '‚Äî', school: t1.school || '', archers: t1Archers },
            { target: targets[1], name: t2.team_name || t2.school || '‚Äî', school: t2.school || '', archers: t2Archers }
          ]
        };
      });

      const baleNumbers = Object.keys(bales).map(Number).sort((a, b) => a - b);

      if (baleNumbers.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-4">No bale assignments found for this round.</div>';
        return;
      }

      // Determine filter label for heading
      let headingLabel = filterValue === 'latest' ? (filteredSolo[0]?.bracket_match_id || filteredTeam[0]?.bracket_match_id || 'Latest Round') : (filterValue === 'all' ? 'All Rounds' : filterValue);

      let html = `<div class="text-sm font-semibold text-gray-600 dark:text-gray-400 mb-4">Showing: ${headingLabel} &mdash; ${baleNumbers.length} bale${baleNumbers.length !== 1 ? 's' : ''} in use</div>`;
      html += '<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">';

      for (const baleNum of baleNumbers) {
        const baleData = bales[baleNum];
        html += `<div class="border-2 border-gray-300 dark:border-gray-600 rounded-lg overflow-hidden bg-gray-50 dark:bg-gray-700">`;
        html += `<div class="bg-primary text-white text-center py-2 font-bold text-sm">BALE ${baleNum}</div>`;

        // Line 1 (targets A, B)
        html += renderBaleLineHtml(baleData.line1, 1);

        // Divider
        html += `<div class="border-t border-gray-300 dark:border-gray-600"></div>`;

        // Line 2 (targets C, D)
        html += renderBaleLineHtml(baleData.line2, 2);

        html += `</div>`;
      }

      html += '</div>';
      container.innerHTML = html;
    }

    /**
     * Renders the HTML for one line (half) of a bale card.
     * @param {Object|undefined} lineData - Line match data
     * @param {number} lineNum - 1 or 2
     * @returns {string} HTML string
     */
    function renderBaleLineHtml(lineData, lineNum) {
      const lineLabel = lineNum === 1 ? 'Line 1 (A/B)' : 'Line 2 (C/D)';

      if (!lineData) {
        return `
          <div class="p-3">
            <div class="text-xs text-gray-400 dark:text-gray-500 mb-1">${lineLabel}</div>
            <div class="text-center text-gray-400 dark:text-gray-500 text-xs py-2">‚Äî empty ‚Äî</div>
          </div>
        `;
      }

      const statusColors = {
        'VRFD': 'bg-green-500', 'VER': 'bg-green-500',
        'COMP': 'bg-blue-500', 'COMPLETED': 'bg-blue-500',
        'PENDING': 'bg-gray-400', 'PEND': 'bg-gray-400'
      };
      const statusLabel = {
        'VRFD': 'Verified', 'VER': 'Verified',
        'COMP': 'Complete', 'COMPLETED': 'Complete',
        'PENDING': 'Pending', 'PEND': 'Pending'
      };
      const cs = (lineData.status || 'PENDING').toUpperCase();
      const badgeColor = statusColors[cs] || 'bg-gray-400';
      const badgeLabel = statusLabel[cs] || cs;
      const waveLabel = lineData.wave ? ` <span class="text-gray-400">(Wave ${lineData.wave})</span>` : '';

      let slotsHtml = '';
      for (const slot of lineData.slots) {
        const isTeam = lineData.type === 'team';
        const archersLine = isTeam && slot.archers ? `<div class="text-[10px] text-gray-500 dark:text-gray-400 truncate">${slot.archers}</div>` : '';
        slotsHtml += `
          <div class="flex-1 bg-white dark:bg-gray-800 rounded p-2 text-center min-w-0">
            <div class="text-xs font-bold text-gray-500 dark:text-gray-400">${slot.target}</div>
            <div class="text-sm font-semibold text-gray-800 dark:text-white truncate" title="${slot.name}">${slot.name}</div>
            <div class="text-[10px] text-gray-500 dark:text-gray-400">${slot.school}</div>
            ${archersLine}
          </div>
        `;
      }

      return `
        <div class="p-3">
          <div class="flex justify-between items-center mb-2">
            <div class="text-xs text-gray-500 dark:text-gray-400">${lineLabel}${waveLabel}</div>
            <span class="px-1.5 py-0.5 ${badgeColor} text-white rounded text-[10px] font-semibold">${badgeLabel}</span>
          </div>
          <div class="flex gap-2">
            ${slotsHtml}
          </div>
          <div class="text-[10px] text-gray-400 dark:text-gray-500 mt-1 truncate">${lineData.bracketName}</div>
        </div>
      `;
    }

    /**
     * Opens a print-friendly version of the current bale assignments view in a new window.
     */
    function printBaleAssignments() {
      if (!cachedBaleData) {
        alert('No bale assignment data loaded yet.');
        return;
      }

      const eventName = document.getElementById('event-name').textContent || 'Event';
      const eventDate = document.getElementById('event-date').textContent || '';
      const filterValue = document.getElementById('bale-round-filter').value;
      const filterLabel = filterValue === 'latest' ? 'Latest Round' : (filterValue === 'all' ? 'All Rounds' : filterValue);

      // Reuse the same rendering logic but build standalone HTML
      const tempContainer = document.createElement('div');
      tempContainer.id = 'bale-assignments-content';
      document.body.appendChild(tempContainer);

      // Temporarily swap container
      const realContainer = document.getElementById('bale-assignments-content');
      tempContainer.id = 'bale-assignments-content-temp';
      renderBaleAssignmentsView(cachedBaleData.soloMatches, cachedBaleData.teamMatches);
      const renderedHtml = realContainer.innerHTML;

      const fullHtml = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bale Assignments - ${eventName}</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, -apple-system, sans-serif; margin: 1rem; color: #1f2937; }
    .header { margin-bottom: 1.5rem; border-bottom: 2px solid #374151; padding-bottom: 0.75rem; }
    .header h1 { font-size: 1.5rem; font-weight: 700; }
    .header .meta { font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem; }
    .bale-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1rem; }
    .bale-card { border: 2px solid #9ca3af; border-radius: 0.5rem; overflow: hidden; break-inside: avoid; }
    .bale-title { background: #0d6efd; color: white; text-align: center; padding: 0.375rem; font-weight: 700; font-size: 0.875rem; }
    .bale-line { padding: 0.5rem; }
    .bale-line + .bale-line { border-top: 1px solid #d1d5db; }
    .line-label { font-size: 0.7rem; color: #6b7280; margin-bottom: 0.25rem; }
    .slots { display: flex; gap: 0.5rem; }
    .slot { flex: 1; text-align: center; border: 1px solid #e5e7eb; border-radius: 0.25rem; padding: 0.375rem; background: #f9fafb; }
    .slot-target { font-size: 0.7rem; font-weight: 700; color: #6b7280; }
    .slot-name { font-size: 0.8rem; font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .slot-school { font-size: 0.65rem; color: #9ca3af; }
    .slot-archers { font-size: 0.6rem; color: #9ca3af; }
    .status-badge { font-size: 0.6rem; padding: 0.125rem 0.375rem; border-radius: 0.25rem; color: white; font-weight: 600; }
    .status-verified { background: #198754; }
    .status-complete { background: #2563eb; }
    .status-pending { background: #9ca3af; }
    .bracket-label { font-size: 0.6rem; color: #9ca3af; margin-top: 0.25rem; }
    .empty-line { text-align: center; color: #d1d5db; font-size: 0.75rem; padding: 0.5rem; }
    .print-actions { margin-top: 1.5rem; display: flex; gap: 0.5rem; }
    .btn { padding: 0.5rem 1rem; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer; font-size: 0.875rem; }
    .btn-print { background: #2563eb; color: white; }
    .btn-close { background: #e5e7eb; color: #374151; }
    @media print { .print-actions { display: none !important; } body { margin: 0.5rem; } }
  </style>
</head>
<body>
  <div class="header">
    <h1>${eventName}</h1>
    <div class="meta">${eventDate} &mdash; ${filterLabel}</div>
  </div>
  ${buildPrintBaleHtml(cachedBaleData.soloMatches, cachedBaleData.teamMatches, filterValue)}
  <div class="print-actions">
    <button class="btn btn-print" onclick="window.print()">Print</button>
    <button class="btn btn-close" onclick="window.close()">Close</button>
  </div>
</body>
</html>`;

      tempContainer.remove();

      const win = window.open('', '_blank', 'width=900,height=700,scrollbars=yes');
      if (win) {
        win.document.write(fullHtml);
        win.document.close();
      } else {
        alert('Pop-up blocked. Please allow pop-ups for this site.');
      }
    }

    /**
     * Builds print-friendly HTML for bale assignment cards.
     * @param {Array} soloMatches - Solo matches
     * @param {Array} teamMatches - Team matches
     * @param {string} filterValue - Round filter
     * @returns {string} HTML string
     */
    function buildPrintBaleHtml(soloMatches, teamMatches, filterValue) {
      let filteredSolo = soloMatches;
      let filteredTeam = teamMatches;

      if (filterValue === 'latest') {
        let maxRound = 0, maxRoundLabel = '';
        soloMatches.forEach(m => {
          const match = (m.bracket_match_id || '').match(/Round\s+(\d+)/i);
          if (match) { const rn = parseInt(match[1]); if (rn > maxRound) { maxRound = rn; maxRoundLabel = m.bracket_match_id; } }
        });
        teamMatches.forEach(m => {
          const match = (m.bracket_match_id || '').match(/Round\s+(\d+)/i);
          if (match) { const rn = parseInt(match[1]); if (rn > maxRound) { maxRound = rn; maxRoundLabel = m.bracket_match_id; } }
        });
        if (maxRoundLabel) {
          filteredSolo = soloMatches.filter(m => m.bracket_match_id === maxRoundLabel);
          filteredTeam = teamMatches.filter(m => m.bracket_match_id === maxRoundLabel);
        }
      } else if (filterValue !== 'all') {
        filteredSolo = soloMatches.filter(m => m.bracket_match_id === filterValue);
        filteredTeam = teamMatches.filter(m => m.bracket_match_id === filterValue);
      }

      const bales = {};

      filteredSolo.forEach(m => {
        const bn = m.bale_number;
        if (!bn) return;
        if (!bales[bn]) bales[bn] = {};
        const lk = `line${m.line_number || 1}`;
        const a1 = m.archer1 || {};
        const a2 = m.archer2 || {};
        const tgts = m.line_number === 2 ? ['C', 'D'] : ['A', 'B'];
        bales[bn][lk] = {
          type: 'solo', status: m.card_status || 'PENDING', bracketName: m.bracket_name || '',
          slots: [
            { target: a1.target_assignment || tgts[0], name: a1.archer_name || '‚Äî', school: a1.school || '' },
            { target: a2.target_assignment || tgts[1], name: a2.archer_name || '‚Äî', school: a2.school || '' }
          ]
        };
      });

      filteredTeam.forEach(m => {
        const bn = m.bale_number;
        if (!bn) return;
        if (!bales[bn]) bales[bn] = {};
        const lk = `line${m.line_number || 1}`;
        const t1 = m.team1 || {};
        const t2 = m.team2 || {};
        const tgts = m.line_number === 2 ? ['C', 'D'] : ['A', 'B'];
        bales[bn][lk] = {
          type: 'team', status: m.card_status || 'PENDING', bracketName: m.bracket_name || '',
          slots: [
            { target: tgts[0], name: t1.team_name || t1.school || '‚Äî', school: t1.school || '', archers: (t1.archers || []).map(a => a.archer_name).join(', ') },
            { target: tgts[1], name: t2.team_name || t2.school || '‚Äî', school: t2.school || '', archers: (t2.archers || []).map(a => a.archer_name).join(', ') }
          ]
        };
      });

      const baleNumbers = Object.keys(bales).map(Number).sort((a, b) => a - b);
      if (baleNumbers.length === 0) return '<p>No bale assignments found.</p>';

      let html = '<div class="bale-grid">';
      for (const bn of baleNumbers) {
        const bd = bales[bn];
        html += `<div class="bale-card">`;
        html += `<div class="bale-title">BALE ${bn}</div>`;
        html += buildPrintLineHtml(bd.line1, 1);
        html += buildPrintLineHtml(bd.line2, 2);
        html += `</div>`;
      }
      html += '</div>';
      return html;
    }

    /**
     * Builds print HTML for one line of a bale.
     * @param {Object|undefined} lineData - Line data
     * @param {number} lineNum - 1 or 2
     * @returns {string} HTML
     */
    function buildPrintLineHtml(lineData, lineNum) {
      const label = lineNum === 1 ? 'Line 1 (A/B)' : 'Line 2 (C/D)';
      if (!lineData) {
        return `<div class="bale-line"><div class="line-label">${label}</div><div class="empty-line">‚Äî empty ‚Äî</div></div>`;
      }

      const cs = (lineData.status || 'PENDING').toUpperCase();
      let badgeClass = 'status-pending';
      let badgeText = 'Pending';
      if (cs === 'VRFD' || cs === 'VER') { badgeClass = 'status-verified'; badgeText = 'Verified'; }
      else if (cs === 'COMP' || cs === 'COMPLETED') { badgeClass = 'status-complete'; badgeText = 'Complete'; }

      let slotsHtml = '';
      for (const s of lineData.slots) {
        const archersHtml = s.archers ? `<div class="slot-archers">${s.archers}</div>` : '';
        slotsHtml += `<div class="slot"><div class="slot-target">${s.target}</div><div class="slot-name">${s.name}</div><div class="slot-school">${s.school}</div>${archersHtml}</div>`;
      }

      return `
        <div class="bale-line">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.25rem;">
            <div class="line-label">${label}</div>
            <span class="status-badge ${badgeClass}">${badgeText}</span>
          </div>
          <div class="slots">${slotsHtml}</div>
          <div class="bracket-label">${lineData.bracketName}</div>
        </div>
      `;
    }

    // Generate bracket from Top 8
    async function generateBracket(bracketId) {
      if (!confirm('This will generate bracket entries from Top 8 ranking scores. Continue?')) {
        return;
      }

      const btn = document.getElementById(`generate-btn-${bracketId}`);
      if (!btn) return;

      try {
        btn.disabled = true;
        btn.textContent = 'Generating...';

        await apiRequest(`/brackets/${bracketId}/generate`, 'POST');

        alert('Bracket generated successfully!');

        // Refresh dashboard data
        await loadOverview();
      } catch (err) {
        alert('Error generating bracket: ' + (err.message || 'Unknown error'));
        btn.disabled = false;
        btn.textContent = 'üéØ Generate from Top 8';
      }
    }

    /**
     * Loads suggested round progress for a Swiss bracket and displays it.
     * @param {string} bracketId - Bracket UUID
     */
    async function loadSwissProgress(bracketId) {
      try {
        const data = await apiRequest(`/brackets/${bracketId}/suggested-rounds`);
        const suggestedRounds = data.suggestedRounds || 0;
        const rosterSize = data.rosterSize || 0;

        if (suggestedRounds <= 0) return;

        // Determine current round from bracket results
        const results = await apiRequest(`/brackets/${bracketId}/results`);
        const swissMatches = results?.rounds?.swiss || [];
        let currentRound = 0;
        swissMatches.forEach(m => {
          const matchLabel = m.bracket_match_id || '';
          const roundMatch = matchLabel.match(/Round\s+(\d+)/i);
          if (roundMatch) {
            const rn = parseInt(roundMatch[1], 10);
            if (rn > currentRound) currentRound = rn;
          }
        });

        const el = document.getElementById(`swiss-progress-${bracketId}`);
        if (el) {
          el.innerHTML = `<span class="font-semibold text-gray-800 dark:text-white">Round ${currentRound} of ${suggestedRounds}</span> suggested (${rosterSize} archers)`;
        }
      } catch (err) {
        console.error('Failed to load Swiss progress for bracket:', bracketId, err);
      }
    }

    /**
     * Generates the next Swiss round for a bracket.
     * Calls POST /brackets/:id/generate-round and refreshes the dashboard.
     * @param {string} bracketId - Bracket UUID
     */
    async function generateSwissRound(bracketId) {
      if (!confirm('Generate the next Swiss round? This will create new match pairings based on current standings.')) {
        return;
      }

      const btn = document.getElementById(`swiss-gen-btn-${bracketId}`);
      if (!btn) return;

      try {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';

        const result = await apiRequest(`/brackets/${bracketId}/generate-round`, 'POST', {});

        const matchCount = result.pairings || 0;
        const roundNum = result.round || '?';
        alert(`Round ${roundNum} generated with ${matchCount} matches!`);

        // Refresh dashboard data
        await loadOverview();
      } catch (err) {
        alert('Error generating Swiss round: ' + (err.message || 'Unknown error'));
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-plus-circle"></i> Next Round';
      }
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
      // Refresh buttons
      document.getElementById('refresh-btn').addEventListener('click', loadOverview);
      document.getElementById('footer-refresh-btn').addEventListener('click', loadOverview);

      // Toggle buttons
      document.getElementById('toggle-rounds').addEventListener('click', toggleAllRounds);
      document.getElementById('toggle-brackets').addEventListener('click', toggleAllBrackets);

      // Bale assignments: round filter change
      document.getElementById('bale-round-filter').addEventListener('change', () => {
        if (cachedBaleData) {
          renderBaleAssignmentsView(cachedBaleData.soloMatches, cachedBaleData.teamMatches);
        }
      });

      // Bale assignments: print button
      document.getElementById('print-bale-btn').addEventListener('click', printBaleAssignments);

      // Initial load
      loadOverview();
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      stopAutoRefresh();
    });
  </script>
</body>

</html>