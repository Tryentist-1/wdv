<!DOCTYPE html>
<html lang="en" class="h-full">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Assignment List - WDV Archery</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="css/tailwind-compiled.css">
    <style>
        /* Safe area insets for iOS */
        .safe-top {
            padding-top: env(safe-area-inset-top, 0);
        }

        .safe-bottom {
            padding-bottom: env(safe-area-inset-bottom, 0);
        }
    </style>
    <script>
        // Dark mode initialization
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                document.documentElement.classList.add('dark');
            }
        }

        // Run on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initTheme);
        } else {
            initTheme();
        }
    </script>
</head>

<body class="h-full bg-gray-50 dark:bg-gray-900 transition-colors duration-200 flex flex-col">
    <!-- Header -->
    <header
        class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700 safe-top transition-colors duration-200 z-20">
        <div class="flex items-center justify-between px-4 py-3">
            <div class="flex items-center gap-3">
                <button onclick="window.history.back()"
                    class="p-2 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg min-w-[44px] min-h-[44px] transition-colors"
                    aria-label="Go back">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h1 class="text-xl font-bold text-gray-900 dark:text-white">Team Positions</h1>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="refreshArchers()"
                    class="p-2 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg min-w-[44px] min-h-[44px] transition-colors"
                    title="Refresh" aria-label="Refresh archers">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>

        <!-- Filter Bar -->
        <div class="px-4 pb-3 flex flex-wrap gap-2">
            <!-- Search -->
            <div class="flex-1 min-w-[150px] relative">
                <input type="text" id="search-input" placeholder="Search archers..."
                    class="w-full pl-9 pr-3 py-2 bg-gray-100 dark:bg-gray-700 border-none rounded-lg text-sm text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-primary focus:outline-none transition-colors"
                    oninput="applyFilters()">
                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            </div>

            <!-- Gender Filter -->
            <button id="gender-filter-btn" onclick="toggleGenderFilter()"
                class="px-3 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg text-sm font-medium hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors min-h-[36px]"
                title="Filter by Gender">
                <span id="gender-label">All</span>
            </button>

            <!-- Level Filter -->
            <select id="level-filter" onchange="applyFilters()"
                class="px-3 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg text-sm font-medium border-none focus:ring-2 focus:ring-primary focus:outline-none transition-colors min-h-[36px] cursor-pointer">
                <option value="all">All Levels</option>
                <option value="VAR">Varsity</option>
                <option value="JV">JV</option>
            </select>

            <!-- School Filter -->
            <select id="school-filter" onchange="applyFilters()"
                class="px-3 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg text-sm font-medium border-none focus:ring-2 focus:ring-primary focus:outline-none transition-colors min-h-[36px] cursor-pointer max-w-[120px]">
                <option value="all">All Schools</option>
            </select>

            <!-- Status Filter -->
            <select id="status-filter" onchange="applyFilters()"
                class="px-3 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg text-sm font-medium border-none focus:ring-2 focus:ring-primary focus:outline-none transition-colors min-h-[36px] cursor-pointer">
                <option value="all">All Status</option>
                <option value="active" selected>Active</option>
                <option value="inactive">Inactive</option>
            </select>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-auto p-4 pb-20 transition-colors duration-200">
        <div id="archer-grid" class="space-y-2">
            <!-- Archer rows will be inserted here -->
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="hidden text-center py-12">
            <i class="fas fa-users text-6xl text-gray-300 dark:text-gray-600 mb-4"></i>
            <p class="text-gray-500 dark:text-gray-400">No archers found</p>
        </div>

        <!-- Loading State -->
        <div id="loading-state" class="text-center py-12">
            <i class="fas fa-spinner fa-spin text-4xl text-gray-400 dark:text-gray-500"></i>
            <p class="mt-4 text-gray-500 dark:text-gray-400">Loading archers...</p>
        </div>
    </main>

    <!-- Footer with Save Button -->
    <footer id="footer"
        class="hidden fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 shadow-lg safe-bottom transition-colors duration-200 z-30">
        <div class="px-4 py-3">
            <button id="save-all-btn" onclick="saveAll()"
                class="w-full px-4 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-semibold min-h-[44px] transition-colors flex items-center justify-center gap-2">
                <i class="fas fa-save"></i>Save All Changes
            </button>
        </div>
    </footer>

    <script src="js/archer_module.js"></script>
    <script>
        let archerModule;
        let archerList = []; // Local copy of all archers
        let filteredArchers = []; // Currently displayed archers
        let modifiedArchers = new Map(); // Track modified archers
        let genderFilter = 'all'; // all, M, F

        async function init() {
            // Initialize archer module
            archerModule = window.ArcherModule;

            // Load archers - try MySQL first, fall back to local storage
            try {
                await archerModule.loadFromMySQL();
            } catch (e) {
                console.log('MySQL load failed, using local storage:', e.message);
                // Data is already in localStorage, just proceed
            }

            // Load local copy for editing
            archerList = archerModule.loadList();

            // Initialize school filter
            populateSchoolFilter();

            // Initial render
            applyFilters();
        }

        function populateSchoolFilter() {
            const schoolSelect = document.getElementById('school-filter');
            const schools = new Set(archerList.map(a => a.school).filter(s => s));
            const sortedSchools = Array.from(schools).sort();

            // Keep "All Schools" and remove others
            while (schoolSelect.options.length > 1) {
                schoolSelect.remove(1);
            }

            sortedSchools.forEach(school => {
                const option = document.createElement('option');
                option.value = school;
                option.textContent = school;
                schoolSelect.appendChild(option);
            });
        }

        function toggleGenderFilter() {
            const btn = document.getElementById('gender-filter-btn');
            const label = document.getElementById('gender-label');

            if (genderFilter === 'all') {
                genderFilter = 'M';
                label.textContent = 'Men';
                btn.className = 'px-3 py-2 bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-200 rounded-lg text-sm font-medium transition-colors min-h-[36px]';
            } else if (genderFilter === 'M') {
                genderFilter = 'F';
                label.textContent = 'Women';
                btn.className = 'px-3 py-2 bg-pink-100 dark:bg-pink-900 text-pink-700 dark:text-pink-200 rounded-lg text-sm font-medium transition-colors min-h-[36px]';
            } else {
                genderFilter = 'all';
                label.textContent = 'All';
                btn.className = 'px-3 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg text-sm font-medium hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors min-h-[36px]';
            }

            applyFilters();
        }

        function refreshArchers() {
            // Reload from localStorage
            archerList = archerModule.loadList();
            modifiedArchers.clear();
            document.getElementById('footer').classList.add('hidden');
            populateSchoolFilter(); // Schools might have changed
            applyFilters();
            showToast('Refreshed!', 'success');
        }

        function applyFilters() {
            const search = document.getElementById('search-input').value.toLowerCase();
            const level = document.getElementById('level-filter').value;
            const school = document.getElementById('school-filter').value;
            const status = document.getElementById('status-filter').value;

            filteredArchers = archerList.filter(archer => {
                // Search
                if (search && !((archer.first + ' ' + archer.last).toLowerCase().includes(search) ||
                    (archer.school || '').toLowerCase().includes(search))) {
                    return false;
                }

                // Gender
                if (genderFilter !== 'all' && archer.gender !== genderFilter) {
                    return false;
                }

                // Level
                if (level !== 'all' && archer.level !== level) {
                    return false;
                }

                // School
                if (school !== 'all' && archer.school !== school) {
                    return false;
                }

                // Status
                if (status !== 'all') {
                    const archerStatus = (archer.status || 'active').toLowerCase();
                    if (archerStatus !== status) {
                        return false;
                    }
                }

                return true;
            });

            renderArcherGrid();
        }

        function renderArcherGrid() {
            const grid = document.getElementById('archer-grid');
            const loadingState = document.getElementById('loading-state');
            const emptyState = document.getElementById('empty-state');

            loadingState.classList.add('hidden');

            if (filteredArchers.length === 0) {
                emptyState.classList.remove('hidden');
                grid.innerHTML = '';
                return;
            }

            emptyState.classList.add('hidden');

            // Sort by School, Gender, Level (VJV), Position
            const sorted = [...filteredArchers].sort((a, b) => {
                // 1. School (alphabetically)
                const schoolA = (a.school || '').toUpperCase();
                const schoolB = (b.school || '').toUpperCase();
                if (schoolA !== schoolB) {
                    return schoolA.localeCompare(schoolB);
                }

                // 2. Gender: M before F
                if (a.gender !== b.gender) {
                    return a.gender === 'M' ? -1 : 1;
                }

                // 3. Level: VAR > JV > BEG
                const levelOrder = { 'VAR': 0, 'JV': 1, 'BEG': 2 };
                const aLevel = levelOrder[a.level] ?? 999;
                const bLevel = levelOrder[b.level] ?? 999;
                if (aLevel !== bLevel) {
                    return aLevel - bLevel;
                }

                // 4. Position/Assignment: S1-S8, then T1-T6, then blanks
                const getAssignmentOrder = (val) => {
                    if (!val) return 999;
                    if (val.startsWith('S')) return parseInt(val.substring(1));
                    if (val.startsWith('T')) return 100 + parseInt(val.substring(1));
                    return 999;
                };
                const aOrder = getAssignmentOrder(a.assignment);
                const bOrder = getAssignmentOrder(b.assignment);
                if (aOrder !== bOrder) {
                    return aOrder - bOrder;
                }

                // 5. Finally by last name
                return (a.last || '').localeCompare(b.last || '');
            });

            grid.innerHTML = sorted.map(archer => createArcherRow(archer)).join('');
        }

        function createArcherRow(archer) {
            const assignment = archer.assignment || '';

            return `
                <div class="bg-white dark:bg-gray-800 rounded-lg p-3 shadow-sm border border-gray-200 dark:border-gray-700 transition-colors duration-200">
                    <div class="flex items-start gap-3">
                        <!-- Archer Info -->
                        <div class="flex-1 min-w-0">
                            <div class="font-semibold text-gray-900 dark:text-white truncate">
                                ${archer.first} ${archer.last}
                            </div>
                            <div class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">
                                ${archer.gender || 'M'} / ${archer.level || 'VAR'} â€¢ ${archer.school || 'N/A'}
                            </div>
                        </div>
                        
                        <!-- Assignment Buttons Container -->
                        <div class="flex flex-col gap-1 flex-shrink-0">
                            <!-- Solo Label + Buttons -->
                            <div class="flex items-center gap-1">
                                <div class="text-[10px] text-gray-400 dark:text-gray-500 w-8">Solo</div>
                                ${['S1', 'S2', 'S3', 'S4', 'S5', 'S6', 'S7', 'S8'].map(val => `
                                    <button 
                                        onclick="setAssignment('${archer.extId}', '${val}')"
                                        class="w-8 h-8 rounded text-xs font-semibold transition-colors min-h-[36px] min-w-[36px] ${assignment === val ? 'bg-primary text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600'}"
                                        aria-label="Assign to ${val}">
                                        ${val}
                                    </button>
                                `).join('')}
                            </div>
                            
                            <!-- Team Label + Buttons -->
                            <div class="flex items-center gap-1">
                                <div class="text-[10px] text-gray-400 dark:text-gray-500 w-8">Team</div>
                                ${['T1', 'T2', 'T3', 'T4', 'T5', 'T6'].map(val => `
                                    <button 
                                        onclick="setAssignment('${archer.extId}', '${val}')"
                                        class="w-8 h-8 rounded text-xs font-semibold transition-colors min-h-[36px] min-w-[36px] ${assignment === val ? 'bg-primary text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600'}"
                                        aria-label="Assign to ${val}">
                                        ${val}
                                    </button>
                                `).join('')}
                                
                                <!-- Clear Button -->
                                <button 
                                    onclick="setAssignment('${archer.extId}', '')"
                                    class="w-8 h-8 rounded transition-colors min-h-[36px] min-w-[36px] ${assignment === '' ? 'bg-gray-300 dark:bg-gray-600' : 'bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600'} text-gray-600 dark:text-gray-300"
                                    title="Clear assignment"
                                    aria-label="Clear assignment">
                                    <i class="fas fa-times text-xs"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        window.setAssignment = function (extId, assignment) {
            // Find archer in our local list
            const archer = archerList.find(a => a.extId === extId);
            if (!archer) return;

            // Update local data
            archer.assignment = assignment;
            modifiedArchers.set(extId, archer);

            // Re-render to show updated highlight
            renderArcherGrid();

            // Show footer
            document.getElementById('footer').classList.remove('hidden');

            // Auto-save after short delay
            clearTimeout(window.autoSaveTimeout);
            window.autoSaveTimeout = setTimeout(() => saveAll(), 1500);
        };

        async function saveAll() {
            if (modifiedArchers.size === 0) return;

            const saveBtn = document.getElementById('save-all-btn');
            const originalHTML = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
            saveBtn.disabled = true;

            try {
                // Prepare payloads for API
                const archersToSave = Array.from(modifiedArchers.values());
                const payloads = archersToSave.map(a => archerModule._prepareForSync(a));

                // Get auth headers
                const apiKey = localStorage.getItem('coach_api_key') || '';
                const passcode = localStorage.getItem('coach_passcode') || '';

                // Save to database via direct API call
                const response = await fetch('/api/v1/archers/bulk_upsert', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-KEY': apiKey,
                        'X-PASSCODE': passcode
                    },
                    body: JSON.stringify(payloads)
                });

                if (response.status === 401) {
                    throw new Error('Not authorized. Are you logged in as coach?');
                }

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                // Also update localStorage
                archerModule.saveList(archerList);

                // Clear modified set
                modifiedArchers.clear();

                // Hide footer
                document.getElementById('footer').classList.add('hidden');
                saveBtn.innerHTML = originalHTML;
                saveBtn.disabled = false;

                // Show success feedback
                showToast('Assignments saved!', 'success');
            } catch (error) {
                console.error('Failed to save assignments:', error);
                saveBtn.innerHTML = originalHTML;
                saveBtn.disabled = false;

                // Even if API fails, we save to local storage so work isn't lost
                archerModule.saveList(archerList);

                if (error.message.includes('Not authorized')) {
                    showToast('Saved locally only (Not logged in)', 'warning');
                } else {
                    showToast('Saved locally (API Error)', 'warning');
                }
            }
        }

        function showToast(message, type = 'info') {
            // Simple toast notification
            const toast = document.createElement('div');
            let bgClass = 'bg-gray-800';
            if (type === 'success') bgClass = 'bg-green-600';
            if (type === 'warning') bgClass = 'bg-yellow-600';
            if (type === 'error') bgClass = 'bg-red-600';

            toast.className = `fixed bottom-24 right-4 px-4 py-3 rounded-lg shadow-lg text-white transition-opacity ${bgClass} z-50`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000); // 3 seconds
        }

        // Initialize on load
        init();
    </script>
</body>

</html>